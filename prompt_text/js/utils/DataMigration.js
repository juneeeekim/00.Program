class DataMigration{constructor(db, auth){if (!db || !auth){throw new Error('DataMigration: db와 auth는 필수 파라미터입니다.')}this.db = db;this.auth = auth;this.currentUser = null;this.isRunning = false;this.progress = 0;this.totalItems = 0;this.migratedItems = 0;this.errors = []}setCurrentUser(user){this.currentUser = user}async migrateFromLocalStorage(progressCallback){try{if (this.isRunning){throw new Error('마이그레이션이 이미 실행 중입니다.')}if (!this.currentUser){throw new Error('로그인이 필요합니다.')}this.isRunning = true;this.progress = 0;this.migratedItems = 0;this.errors = [];const localData = this._getLocalStorageData();this.totalItems = localData.texts.length;if (this.totalItems === 0){return{success: true, migrated: 0, errors: []}}await this._backupLocalData(localData);for (const text of localData.texts){try{await this._migrateText(text);this.migratedItems++;this.progress = Math.round((this.migratedItems / this.totalItems) * 100);if (progressCallback){progressCallback({progress: this.progress, migrated: this.migratedItems, total: this.totalItems})}}catch (error){console.error('❌ 마이그레이션 실패:', error);this.errors.push({item: text, error: error.message})}}const result ={success: this.errors.length === 0, migrated: this.migratedItems, total: this.totalItems, errors: this.errors};this.isRunning = false;return result}catch (error){console.error('❌ 마이그레이션 실패:', error);this.isRunning = false;throw error}}_getLocalStorageData(){try{const savedTextsKey = 'dualTextWriter_savedTexts';const savedTextsStr = localStorage.getItem(savedTextsKey);if (!savedTextsStr){return{texts: []}}const texts = JSON.parse(savedTextsStr);return{texts: Array.isArray(texts) ? texts : []}}catch (error){console.error('❌ 로컬 데이터 읽기 실패:', error);return{texts: []}}}async _backupLocalData(data){try{const backupKey = `migration_backup_${Date.now()}`;localStorage.setItem(backupKey, JSON.stringify(data))}catch (error){console.error('❌ 백업 실패:', error);throw new Error('데이터 백업에 실패했습니다.')}}async _migrateText(text){try{const promptRef = this.db.collection(`users/${this.currentUser.uid}/prompts`).doc();const prompt ={id: promptRef.id, title: text.title || this._generateTitle(text.content), description: '', category: text.topic || text.source || '기타', tags: text.tags || [], currentVersion: 'v1.0.0', isPublic: false, isDeleted: false, createdAt: text.createdAt ? new Date(text.createdAt) : new Date(), updatedAt: new Date()};await promptRef.set(prompt);const versionRef = this.db .collection(`users/${this.currentUser.uid}/prompts/${promptRef.id}/versions`) .doc();const version ={id: versionRef.id, version: 'v1.0.0', content: text.content || '', variables: [], changelog: '마이그레이션된 초기 버전', createdBy: this.currentUser.uid, createdAt: text.createdAt ? new Date(text.createdAt) : new Date()};await versionRef.set(version)}catch (error){console.error('❌ 텍스트 마이그레이션 실패:', error);throw error}}_generateTitle(content){if (!content){return '제목 없음'}const firstLine = content.split('\n')[0];const title = firstLine.length > 50 ? firstLine.substring(0, 50) + '...' : firstLine;return title || '제목 없음'}async rollback(backupKey){try{const backupStr = localStorage.getItem(backupKey);if (!backupStr){throw new Error('백업 데이터를 찾을 수 없습니다.')}const backup = JSON.parse(backupStr);localStorage.setItem('dualTextWriter_savedTexts', JSON.stringify(backup.texts))}catch (error){console.error('❌ 롤백 실패:', error);throw error}}async validateMigration(){try{if (!this.currentUser){throw new Error('로그인이 필요합니다.')}const promptsSnapshot = await this.db.collection(`users/${this.currentUser.uid}/prompts`).get();const firestoreCount = promptsSnapshot.size;const localData = this._getLocalStorageData();const localCount = localData.texts.length;const result ={firestoreCount: firestoreCount, localCount: localCount, match: firestoreCount >= localCount, message: firestoreCount >= localCount ? '✅ 마이그레이션이 정상적으로 완료되었습니다.' : '⚠️ 일부 데이터가 마이그레이션되지 않았을 수 있습니다.'};return result}catch (error){console.error('❌ 검증 실패:', error);throw error}}}if (typeof module !== 'undefined' && module.exports){module.exports = DataMigration}