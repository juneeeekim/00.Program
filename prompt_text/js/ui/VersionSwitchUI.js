class VersionSwitchUI{constructor(versionManager, promptManager){if (!versionManager || !promptManager){throw new Error('VersionManager와 PromptManager 인스턴스가 필요합니다.')}this.versionManager = versionManager;this.promptManager = promptManager;this.currentPromptId = null;this.currentVersionId = null;this.targetVersionId = null;this.hasUnsavedChanges = false;this.versions = [];this.versionCache = new Map();this.init()}init(){this.bindEvents()}bindEvents(){const versionSelect = document.getElementById('version-select');if (versionSelect){versionSelect.addEventListener('change', (e) => this.handleVersionChange(e))}const closeBtn = document.getElementById('close-switch-modal');const cancelBtn = document.getElementById('cancel-switch-btn');if (closeBtn){closeBtn.addEventListener('click', () => this.closeSwitchModal())}if (cancelBtn){cancelBtn.addEventListener('click', () => this.closeSwitchModal())}const discardBtn = document.getElementById('discard-switch-btn');if (discardBtn){discardBtn.addEventListener('click', () => this.handleDiscardAndSwitch())}document.addEventListener('keydown', (e) =>{const modal = document.getElementById('version-switch-modal');if (e.key === 'Escape' && modal && modal.style.display !== 'none'){this.closeSwitchModal()}})}async loadVersions(promptId, currentVersionId, hasUnsavedChanges = false){try{this.currentPromptId = promptId;this.currentVersionId = currentVersionId;this.hasUnsavedChanges = hasUnsavedChanges;if (this.versionCache.has(promptId)){this.versions = this.versionCache.get(promptId)}else{this.versions = await this.versionManager.getVersions(promptId);this.versionCache.set(promptId, this.versions)}this.updateVersionSelect();this.updateCurrentVersionDisplay()}catch (error){console.error('❌ 버전 목록 로드 실패:', error);this.showNotification(error.message, 'error')}}updateVersionSelect(){const select = document.getElementById('version-select');if (!select) return;while (select.options.length > 1){select.remove(1)}this.versions.forEach((version) =>{const option = document.createElement('option');option.value = version.id;option.textContent = `${version.version}- ${version.changelog}`;if (version.id === this.currentVersionId){option.textContent = `✓ ${version.version}(현재) - ${version.changelog}`;option.setAttribute('data-current', 'true');option.selected = true}const date = new Date(version.createdAt.seconds * 1000);option.textContent += ` (${date.toLocaleDateString()})`;select.appendChild(option)})}updateCurrentVersionDisplay(){const currentVersion = this.versions.find((v) => v.id === this.currentVersionId);if (!currentVersion) return;const display = document.getElementById('current-version-display');if (display){display.textContent = currentVersion.version}}handleVersionChange(e){const targetVersionId = e.target.value;if (!targetVersionId){return}if (targetVersionId === this.currentVersionId){return}this.targetVersionId = targetVersionId;if (this.hasUnsavedChanges){this.showSwitchModal()}else{this.performSwitch()}}showSwitchModal(){const currentVersion = this.versions.find((v) => v.id === this.currentVersionId);const targetVersion = this.versions.find((v) => v.id === this.targetVersionId);if (!currentVersion || !targetVersion) return;const fromEl = document.getElementById('switch-from-version');const toEl = document.getElementById('switch-to-version');if (fromEl) fromEl.textContent = currentVersion.version;if (toEl) toEl.textContent = targetVersion.version;this.previousFocus = document.activeElement;const modal = document.getElementById('version-switch-modal');if (modal){modal.style.display = 'flex';modal.setAttribute('aria-hidden', 'false');this.setupFocusTrap(modal);const cancelBtn = document.getElementById('cancel-switch-btn');if (cancelBtn){setTimeout(() => cancelBtn.focus(), 100)}}}closeSwitchModal(){const modal = document.getElementById('version-switch-modal');if (modal){modal.style.display = 'none';modal.setAttribute('aria-hidden', 'true')}if (this.previousFocus){this.previousFocus.focus();this.previousFocus = null}const select = document.getElementById('version-select');if (select){select.value = this.currentVersionId}this.targetVersionId = null}async handleDiscardAndSwitch(){const discardBtn = document.getElementById('discard-switch-btn');if (discardBtn){discardBtn.classList.add('loading');discardBtn.disabled = true}try{await this.performSwitch();this.closeSwitchModal()}catch (error){console.error('❌ 버전 전환 실패:', error);this.showNotification(error.message, 'error')}finally{if (discardBtn){discardBtn.classList.remove('loading');discardBtn.disabled = false}}}async performSwitch(){try{this.showLoadingOverlay();const newVersion = await this.versionManager.switchVersion(this.currentPromptId, this.targetVersionId);this.currentVersionId = this.targetVersionId;this.updateVersionSelect();this.updateCurrentVersionDisplay();document.dispatchEvent( new CustomEvent('versionSwitched',{detail:{promptId: this.currentPromptId, versionId: this.targetVersionId, version: newVersion}}) );this.showNotification(`버전 ${newVersion.version}으로 전환되었습니다.`, 'success');this.hasUnsavedChanges = false}catch (error){console.error('❌ 버전 전환 실패:', error);throw error}finally{this.hideLoadingOverlay()}}showLoadingOverlay(){const overlay = document.getElementById('version-loading-overlay');if (overlay){overlay.style.display = 'flex';overlay.setAttribute('aria-hidden', 'false')}}hideLoadingOverlay(){const overlay = document.getElementById('version-loading-overlay');if (overlay){overlay.style.display = 'none';overlay.setAttribute('aria-hidden', 'true')}}setUnsavedChanges(hasChanges){this.hasUnsavedChanges = hasChanges}invalidateCache(promptId = null){if (promptId){this.versionCache.delete(promptId)}else{this.versionCache.clear()}}setupFocusTrap(container){const focusableElements = container.querySelectorAll( 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])' );const firstElement = focusableElements[0];const lastElement = focusableElements[focusableElements.length - 1];const handleTabKey = (e) =>{if (e.key !== 'Tab') return;if (e.shiftKey){if (document.activeElement === firstElement){e.preventDefault();lastElement.focus()}}else{if (document.activeElement === lastElement){e.preventDefault();firstElement.focus()}}};container.addEventListener('keydown', handleTabKey)}showNotification(message, type = 'info'){const notification = document.createElement('div');notification.className = `notification notification-${type}`;notification.textContent = message;notification.setAttribute('role', 'alert');notification.setAttribute('aria-live', 'polite');Object.assign(notification.style,{position: 'fixed', top: '20px', right: '20px', padding: '16px 24px', borderRadius: '8px', backgroundColor: type === 'error' ? '#e74c3c' : type === 'success' ? '#27ae60' : '#3498db', color: '#ffffff', fontWeight: '600', boxShadow: '0 4px 12px rgba(0, 0, 0, 0.2)', zIndex: '10000', animation: 'slideInRight 0.3s ease-out'});document.body.appendChild(notification);setTimeout(() =>{notification.style.animation = 'slideOutRight 0.3s ease-out';setTimeout(() =>{document.body.removeChild(notification)}, 300)}, 3000)}}if (typeof module !== 'undefined' && module.exports){module.exports = VersionSwitchUI}