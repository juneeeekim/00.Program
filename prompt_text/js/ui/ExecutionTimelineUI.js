class ExecutionTimelineUI{constructor(executionManager){if (!executionManager){throw new Error('ExecutionManager 인스턴스가 필요합니다.')}this.executionManager = executionManager;this.histories = [];this.lastDoc = null;this.hasMore = true;this.isLoading = false;this.currentFilter = '';this.timelineList = null;this.loadingSkeleton = null;this.emptyState = null;this.errorState = null;this.scrollTrigger = null;this.loadingMore = null;this.ratingFilter = null;this.observer = null;this.init()}init(){this.initElements();this.initEventListeners();this.initIntersectionObserver();this.loadInitialData()}initElements(){this.timelineList = document.getElementById('timeline-list');this.loadingSkeleton = document.getElementById('loading-skeleton');this.emptyState = document.getElementById('empty-state');this.errorState = document.getElementById('error-state');this.scrollTrigger = document.getElementById('scroll-trigger');this.loadingMore = document.getElementById('loading-more');this.ratingFilter = document.getElementById('rating-filter');if (!this.timelineList){throw new Error('timeline-list 요소를 찾을 수 없습니다.')}}initEventListeners(){this.refreshHandler = () => this.refresh();this.ratingFilterHandler = (e) =>{this.currentFilter = e.target.value;this.refresh()};this.retryHandler = () => this.loadInitialData();this.executionHistorySavedHandler = () => this.refresh();this.executionHistoryDeletedHandler = () => this.refresh();const refreshBtn = document.getElementById('refresh-timeline');if (refreshBtn){refreshBtn.addEventListener('click', this.refreshHandler)}if (this.ratingFilter){this.ratingFilter.addEventListener('change', this.ratingFilterHandler)}const retryBtn = document.getElementById('retry-button');if (retryBtn){retryBtn.addEventListener('click', this.retryHandler)}document.addEventListener('executionHistorySaved', this.executionHistorySavedHandler);document.addEventListener('executionHistoryDeleted', this.executionHistoryDeletedHandler)}initIntersectionObserver(){if (!this.scrollTrigger) return;const options ={root: null, rootMargin: '100px', threshold: 0.1};this.observer = new IntersectionObserver((entries) =>{entries.forEach((entry) =>{if (entry.isIntersecting && this.hasMore && !this.isLoading){this.loadMore()}})}, options);this.observer.observe(this.scrollTrigger)}async loadInitialData(){try{this.showLoading();this.hideError();const options ={limit: 10};if (this.currentFilter){options.rating = parseInt(this.currentFilter)}const result = await this.executionManager.getExecutionHistories(options);this.histories = result.histories;this.lastDoc = result.lastDoc;this.hasMore = result.hasMore;this.render()}catch (error){console.error('❌ 초기 데이터 로드 실패:', error);this.showError(error.message)}finally{this.hideLoading()}}async loadMore(){if (this.isLoading || !this.hasMore) return;try{this.isLoading = true;this.showLoadingMore();const options ={limit: 10, startAfter: this.lastDoc};if (this.currentFilter){options.rating = parseInt(this.currentFilter)}const result = await this.executionManager.getExecutionHistories(options);this.histories = [...this.histories, ...result.histories];this.lastDoc = result.lastDoc;this.hasMore = result.hasMore;this.appendItems(result.histories)}catch (error){console.error('❌ 추가 데이터 로드 실패:', error);this.showNotification('더 불러오기에 실패했습니다.', 'error')}finally{this.isLoading = false;this.hideLoadingMore()}}async refresh(){try{this.histories = [];this.lastDoc = null;this.hasMore = true;this.timelineList.innerHTML = '';await this.loadInitialData()}catch (error){console.error('❌ 새로고침 실패:', error);this.showNotification('새로고침에 실패했습니다.', 'error')}}render(){if (this.histories.length === 0){this.showEmpty();return}this.hideEmpty();this.timelineList.innerHTML = '';this.histories.forEach((history) =>{const timelineItem = this.createTimelineItem(history);this.timelineList.appendChild(timelineItem)});this.timelineList.setAttribute('aria-busy', 'false')}appendItems(histories){const fragment = document.createDocumentFragment();histories.forEach((history) =>{const timelineItem = this.createTimelineItem(history);fragment.appendChild(timelineItem)});this.timelineList.appendChild(fragment)}createTimelineItem(history){const template = document.getElementById('timeline-item-template');const clone = template.content.cloneNode(true);const article = clone.querySelector('.timeline-item');const card = clone.querySelector('.timeline-card');const time = clone.querySelector('.time-text');const ratingStars = clone.querySelector('.rating-stars');const ratingText = clone.querySelector('.rating-text');const title = clone.querySelector('.prompt-title');const preview = clone.querySelector('.result-preview');const versionBadge = clone.querySelector('.version-badge');const lengthBadge = clone.querySelector('.length-badge');const viewBtn = clone.querySelector('.btn-view');const deleteBtn = clone.querySelector('.btn-delete');card.setAttribute('data-rating', history.rating);card.setAttribute('data-history-id', history.id);const executedDate = history.executedAt.toDate();time.setAttribute('datetime', executedDate.toISOString());time.textContent = this.formatRelativeTime(executedDate);ratingStars.textContent = '⭐'.repeat(history.rating);ratingText.textContent = this.getRatingText(history.rating);title.textContent = '프롬프트 실행 결과';preview.textContent = history.resultText;versionBadge.textContent = `버전 ${history.versionId.substring(0, 8)}`;lengthBadge.textContent = `${history.resultLength}자`;viewBtn.addEventListener('click', () => this.viewDetail(history));deleteBtn.addEventListener('click', () => this.deleteHistory(history.id));return clone}formatRelativeTime(date){const now = new Date();const diff = now - date;const seconds = Math.floor(diff / 1000);const minutes = Math.floor(seconds / 60);const hours = Math.floor(minutes / 60);const days = Math.floor(hours / 24);if (seconds < 60){return '방금 전'}else if (minutes < 60){return `${minutes}분 전`}else if (hours < 24){return `${hours}시간 전`}else if (days < 7){return `${days}일 전`}else{return date.toLocaleDateString('ko-KR',{year: 'numeric', month: 'long', day: 'numeric'})}}getRatingText(rating){const texts ={1: '매우 나쁨', 2: '나쁨', 3: '보통', 4: '좋음', 5: '매우 좋음'};return texts[rating] || '보통'}viewDetail(history){document.dispatchEvent( new CustomEvent('viewExecutionDetail',{detail:{history}}) );alert(`실행 결과:\n\n${history.resultText}\n\n평점: ${history.rating}점\n메모: ${history.notes || '없음'}`)}async deleteHistory(historyId){if (!confirm('이 실행 이력을 삭제하시겠습니까?')){return}try{await this.executionManager.deleteExecutionHistory(historyId);const card = this.timelineList.querySelector(`[data-history-id="${historyId}"]`);if (card){const timelineItem = card.closest('.timeline-item');timelineItem.style.animation = 'slideOutRight 0.3s ease-out';setTimeout(() =>{timelineItem.remove();this.histories = this.histories.filter((h) => h.id !== historyId);if (this.histories.length === 0){this.showEmpty()}}, 300)}this.showNotification('실행 이력이 삭제되었습니다.', 'success')}catch (error){console.error('❌ 이력 삭제 실패:', error);this.showNotification('삭제에 실패했습니다.', 'error')}}showLoading(){if (this.loadingSkeleton){this.loadingSkeleton.setAttribute('aria-hidden', 'false')}if (this.timelineList){this.timelineList.setAttribute('aria-busy', 'true')}}hideLoading(){if (this.loadingSkeleton){this.loadingSkeleton.setAttribute('aria-hidden', 'true')}}showLoadingMore(){if (this.loadingMore){this.loadingMore.setAttribute('aria-hidden', 'false')}}hideLoadingMore(){if (this.loadingMore){this.loadingMore.setAttribute('aria-hidden', 'true')}}showEmpty(){if (this.emptyState){this.emptyState.setAttribute('aria-hidden', 'false')}if (this.timelineList){this.timelineList.style.display = 'none'}}hideEmpty(){if (this.emptyState){this.emptyState.setAttribute('aria-hidden', 'true')}if (this.timelineList){this.timelineList.style.display = 'block'}}showError(message){if (this.errorState){this.errorState.setAttribute('aria-hidden', 'false');const errorMessage = this.errorState.querySelector('#error-message');if (errorMessage){errorMessage.textContent = message}}if (this.timelineList){this.timelineList.style.display = 'none'}}hideError(){if (this.errorState){this.errorState.setAttribute('aria-hidden', 'true')}}showNotification(message, type = 'info'){const notification = document.createElement('div');notification.className = `notification notification-${type}`;notification.textContent = message;notification.setAttribute('role', 'alert');notification.setAttribute('aria-live', 'polite');const colors ={success: '#27ae60', error: '#e74c3c', info: '#3498db'};Object.assign(notification.style,{position: 'fixed', top: '20px', right: '20px', padding: '16px 24px', borderRadius: '8px', backgroundColor: colors[type], color: '#ffffff', fontWeight: '600', boxShadow: '0 4px 12px rgba(0, 0, 0, 0.2)', zIndex: '10000', animation: 'slideInRight 0.3s ease-out'});document.body.appendChild(notification);setTimeout(() =>{notification.style.animation = 'slideOutRight 0.3s ease-out';setTimeout(() =>{if (document.body.contains(notification)){document.body.removeChild(notification)}}, 300)}, 3000)}cleanup(){if (this.observer){this.observer.disconnect();this.observer = null}const refreshBtn = document.getElementById('refresh-timeline');if (refreshBtn){refreshBtn.removeEventListener('click', this.refreshHandler)}if (this.ratingFilter){this.ratingFilter.removeEventListener('change', this.ratingFilterHandler)}const retryBtn = document.getElementById('retry-button');if (retryBtn){retryBtn.removeEventListener('click', this.retryHandler)}document.removeEventListener('executionHistorySaved', this.executionHistorySavedHandler);document.removeEventListener('executionHistoryDeleted', this.executionHistoryDeletedHandler);this.histories = [];this.lastDoc = null;this.hasMore = true}}if (typeof module !== 'undefined' && module.exports){module.exports = ExecutionTimelineUI}