class VersionHistoryUI{constructor(versionManager){if (!versionManager){throw new Error('VersionManager 인스턴스가 필요합니다.')}this.versionManager = versionManager;this.currentPromptId = null;this.currentVersion = null;this.versions = [];this.lastDoc = null;this.hasMore = true;this.isLoading = false;this.pageSize = 10;this.init()}init(){this.bindEvents()}bindEvents(){const refreshBtn = document.getElementById('refresh-versions-btn');if (refreshBtn){refreshBtn.addEventListener('click', () => this.refreshVersions())}const loadMoreBtn = document.getElementById('load-more-btn');if (loadMoreBtn){loadMoreBtn.addEventListener('click', () => this.loadMoreVersions())}const createFirstBtn = document.getElementById('create-first-version-btn');if (createFirstBtn){createFirstBtn.addEventListener('click', () =>{document.dispatchEvent(new CustomEvent('openVersionCreate'))})}const retryBtn = document.getElementById('retry-versions-btn');if (retryBtn){retryBtn.addEventListener('click', () => this.loadVersions())}const closeDetailBtn = document.getElementById('close-version-detail-modal');const closeBtn2 = document.getElementById('close-detail-btn');if (closeDetailBtn){closeDetailBtn.addEventListener('click', () => this.closeDetailModal())}if (closeBtn2){closeBtn2.addEventListener('click', () => this.closeDetailModal())}const useVersionBtn = document.getElementById('use-version-btn');if (useVersionBtn){useVersionBtn.addEventListener('click', () => this.handleUseVersion())}}async loadVersions(promptId, currentVersion){if (promptId){this.currentPromptId = promptId;this.currentVersion = currentVersion;this.versions = [];this.lastDoc = null;this.hasMore = true}if (!this.currentPromptId){console.warn('⚠️ 프롬프트 ID가 없습니다.');return}if (this.isLoading) return;this.isLoading = true;this.showLoading();try{const versions = await this.versionManager.getVersions(this.currentPromptId);this.versions = versions;if (versions.length === 0){this.showEmpty()}else{this.renderVersions();this.hideLoading()}}catch (error){console.error('❌ 버전 목록 로드 실패:', error);this.showError(error.message)}finally{this.isLoading = false}}async loadMoreVersions(){if (this.isLoading || !this.hasMore) return;this.isLoading = true;const loadMoreBtn = document.getElementById('load-more-btn');if (loadMoreBtn){loadMoreBtn.classList.add('loading');loadMoreBtn.disabled = true}try{this.hasMore = false;const loadMoreContainer = document.getElementById('load-more-container');if (loadMoreContainer){loadMoreContainer.style.display = 'none'}}catch (error){console.error('❌ 추가 버전 로드 실패:', error);this.showNotification(error.message, 'error')}finally{this.isLoading = false;if (loadMoreBtn){loadMoreBtn.classList.remove('loading');loadMoreBtn.disabled = false}}}async refreshVersions(){try{await this.loadVersions();this.showNotification('버전 목록이 새로고침되었습니다.', 'success')}catch (error){console.error('❌ 버전 목록 새로고침 실패:', error);this.showNotification('새로고침에 실패했습니다.', 'error')}}renderVersions(){const versionList = document.getElementById('version-list');if (!versionList) return;versionList.innerHTML = '';const template = document.getElementById('version-item-template');if (!template) return;this.versions.forEach((version, index) =>{const clone = template.content.cloneNode(true);const versionItem = clone.querySelector('.version-item');if (version.version === this.currentVersion){versionItem.classList.add('current');const currentBadge = clone.querySelector('.current-badge');if (currentBadge){currentBadge.style.display = 'inline-flex'}}const versionNumber = clone.querySelector('.version-number');if (versionNumber){versionNumber.textContent = version.version}const versionDate = clone.querySelector('.version-date');if (versionDate){versionDate.textContent = this.formatDate(version.createdAt)}const changelogText = clone.querySelector('.changelog-text');if (changelogText){changelogText.textContent = version.changelog || '변경 사항 없음'}const authorName = clone.querySelector('.author-name');if (authorName){authorName.textContent = '사용자'}const executionCount = clone.querySelector('.execution-count');if (executionCount){executionCount.textContent = `${version.executionCount || 0}회 실행`}const viewBtn = clone.querySelector('.view-version-btn');if (viewBtn){viewBtn.addEventListener('click', () => this.openDetailModal(version))}const compareBtn = clone.querySelector('.compare-version-btn');if (compareBtn){compareBtn.addEventListener('click', () => this.handleCompareVersion(version))}const rollbackBtn = clone.querySelector('.rollback-version-btn');if (rollbackBtn){rollbackBtn.addEventListener('click', () => this.handleRollback(version))}versionList.appendChild(clone)});const loadMoreContainer = document.getElementById('load-more-container');if (loadMoreContainer){loadMoreContainer.style.display = this.hasMore ? 'block' : 'none'}}openDetailModal(version){const versionNumber = document.getElementById('detail-version-number');if (versionNumber){versionNumber.textContent = version.version}const createdAt = document.getElementById('detail-created-at');if (createdAt){createdAt.textContent = this.formatDate(version.createdAt)}const author = document.getElementById('detail-author');if (author){author.textContent = '사용자'}const executionCount = document.getElementById('detail-execution-count');if (executionCount){executionCount.textContent = `${version.executionCount || 0}회`}const changelog = document.getElementById('detail-changelog');if (changelog){changelog.textContent = version.changelog || '변경 사항 없음'}const content = document.getElementById('detail-content');if (content){content.textContent = version.content || '(내용 없음)'}const variablesContainer = document.getElementById('detail-variables');if (variablesContainer){variablesContainer.innerHTML = '';if (version.variables && version.variables.length > 0){version.variables.forEach((variable) =>{const varItem = document.createElement('div');varItem.className = 'variable-item';varItem.innerHTML = ` <span class="variable-name">{{${variable.name}}}</span> <span class="variable-type">${variable.type || 'text'}</span> ${variable.required ? '<span class="variable-required">필수</span>' : ''}`;variablesContainer.appendChild(varItem)})}else{variablesContainer.innerHTML = '<p style="color: #7f8c8d;">변수가 없습니다.</p>'}}const modal = document.getElementById('version-detail-modal');if (modal){modal.style.display = 'flex';modal.setAttribute('aria-hidden', 'false');this.selectedVersion = version}}closeDetailModal(){const modal = document.getElementById('version-detail-modal');if (modal){modal.style.display = 'none';modal.setAttribute('aria-hidden', 'true')}this.selectedVersion = null}async handleUseVersion(){if (!this.selectedVersion) return;if (!confirm(`${this.selectedVersion.version}으로 롤백하시겠습니까?`)){return}try{await this.versionManager.rollbackToVersion(this.currentPromptId, this.selectedVersion.id);this.showNotification('버전이 롤백되었습니다!', 'success');this.closeDetailModal();await this.refreshVersions();document.dispatchEvent( new CustomEvent('versionRolledBack',{detail:{version: this.selectedVersion}}) )}catch (error){console.error('❌ 버전 롤백 실패:', error);this.showNotification(error.message, 'error')}}handleCompareVersion(version){this.showNotification('버전 비교 기능은 곧 추가됩니다.', 'info');document.dispatchEvent( new CustomEvent('compareVersion',{detail:{version}}) )}async handleRollback(version){if (!confirm(`${version.version}으로 롤백하시겠습니까?\n\n새로운 버전이 생성됩니다.`)){return}try{await this.versionManager.rollbackToVersion(this.currentPromptId, version.id);this.showNotification('버전이 롤백되었습니다!', 'success');await this.refreshVersions();document.dispatchEvent( new CustomEvent('versionRolledBack',{detail:{version}}) )}catch (error){console.error('❌ 버전 롤백 실패:', error);this.showNotification(error.message, 'error')}}showLoading(){this.hideAllStates();const loadingElement = document.getElementById('versions-loading');if (loadingElement){loadingElement.style.display = 'flex'}}hideLoading(){const loadingElement = document.getElementById('versions-loading');if (loadingElement){loadingElement.style.display = 'none'}}showEmpty(){this.hideAllStates();const emptyElement = document.getElementById('versions-empty');if (emptyElement){emptyElement.style.display = 'flex'}}showError(message){this.hideAllStates();const errorElement = document.getElementById('versions-error');if (errorElement){error.style.display = 'flex';const errorMessage = document.getElementById('error-message');if (errorMessage){errorMessage.textContent = message}}}hideAllStates(){const states = ['versions-loading', 'versions-empty', 'versions-error'];states.forEach((id) =>{const element = document.getElementById(id);if (element){element.style.display = 'none'}})}formatDate(date){if (!date) return '';if (date.toDate){date = date.toDate()}else if (!(date instanceof Date)){date = new Date(date)}const now = new Date();const diff = now - date;const seconds = Math.floor(diff / 1000);const minutes = Math.floor(seconds / 60);const hours = Math.floor(minutes / 60);const days = Math.floor(hours / 24);if (seconds < 60){return '방금 전'}else if (minutes < 60){return `${minutes}분 전`}else if (hours < 24){return `${hours}시간 전`}else if (days < 7){return `${days}일 전`}else{return date.toLocaleDateString('ko-KR',{year: 'numeric', month: 'long', day: 'numeric'})}}showNotification(message, type = 'info'){const notification = document.createElement('div');notification.className = `notification notification-${type}`;notification.textContent = message;notification.setAttribute('role', 'alert');notification.setAttribute('aria-live', 'polite');Object.assign(notification.style,{position: 'fixed', top: '20px', right: '20px', padding: '16px 24px', borderRadius: '8px', backgroundColor: type === 'error' ? '#e74c3c' : type === 'success' ? '#27ae60' : '#3498db', color: '#ffffff', fontWeight: '600', boxShadow: '0 4px 12px rgba(0, 0, 0, 0.2)', zIndex: '10000', animation: 'slideInRight 0.3s ease-out'});document.body.appendChild(notification);setTimeout(() =>{notification.style.animation = 'slideOutRight 0.3s ease-out';setTimeout(() =>{document.body.removeChild(notification)}, 300)}, 3000)}}if (typeof module !== 'undefined' && module.exports){module.exports = VersionHistoryUI}