class ExecutionHistoryUI{constructor(executionManager, resultInputModal){if (!executionManager || !resultInputModal){throw new Error('ExecutionManager와 ResultInputModal 인스턴스가 필요합니다.')}this.executionManager = executionManager;this.resultInputModal = resultInputModal;this.currentPromptId = null;this.currentVersionId = null;this.init()}init(){this._addStyles()}async saveExecutionResult(options){try{const{promptId, versionId, promptTitle, promptVersion}= options;if (!promptId || !versionId){throw new Error('프롬프트 ID와 버전 ID가 필요합니다.')}this.currentPromptId = promptId;this.currentVersionId = versionId;const result = await this.resultInputModal.open({promptTitle: promptTitle || '프롬프트', promptVersion: promptVersion || 'v1.0.0'});const historyId = await this.executionManager.saveExecutionHistory({promptId: promptId, versionId: versionId, resultText: result.resultText, rating: result.rating, notes: result.notes});this.showSuccessFeedback(result.rating);document.dispatchEvent( new CustomEvent('executionHistorySaved',{detail:{historyId: historyId, promptId: promptId, versionId: versionId, rating: result.rating}}) );return historyId}catch (error){console.error('❌ 실행 결과 저장 실패:', error);if (!error.message.includes('취소')){this.showErrorFeedback(error.message)}throw error}}async getExecutionHistories(options ={}){try{return await this.executionManager.getExecutionHistories(options)}catch (error){console.error('❌ 실행 이력 조회 실패:', error);this.showErrorFeedback(error.message);throw error}}async deleteExecutionHistory(historyId){try{if (!confirm('이 실행 이력을 삭제하시겠습니까?')){return}await this.executionManager.deleteExecutionHistory(historyId);this.showNotification('실행 이력이 삭제되었습니다.', 'success');document.dispatchEvent( new CustomEvent('executionHistoryDeleted',{detail:{historyId}}) )}catch (error){console.error('❌ 실행 이력 삭제 실패:', error);this.showErrorFeedback(error.message);throw error}}showSuccessFeedback(rating){const ratingText = this.getRatingText(rating);const message = `실행 결과가 저장되었습니다! (평가: ${rating}점 - ${ratingText})`;this.showNotification(message, 'success');this.showRatingAnimation(rating)}showErrorFeedback(errorMessage){let userFriendlyMessage = errorMessage;if (errorMessage.includes('로그인')){userFriendlyMessage = '로그인이 필요합니다. 다시 로그인해주세요.'}else if (errorMessage.includes('네트워크')){userFriendlyMessage = '네트워크 연결을 확인해주세요.'}else if (errorMessage.includes('권한')){userFriendlyMessage = '저장 권한이 없습니다. 관리자에게 문의하세요.'}this.showNotification(userFriendlyMessage, 'error')}getRatingText(rating){const ratingTexts ={1: '매우 나쁨', 2: '나쁨', 3: '보통', 4: '좋음', 5: '매우 좋음'};return ratingTexts[rating] || '보통'}showRatingAnimation(rating){const stars = '⭐'.repeat(rating);const animation = document.createElement('div');animation.className = 'rating-animation';animation.textContent = stars;Object.assign(animation.style,{position: 'fixed', top: '50%', left: '50%', transform: 'translate(-50%, -50%)', fontSize: '3rem', zIndex: '10000', animation: 'ratingPulse 2s ease-out', pointerEvents: 'none'});document.body.appendChild(animation);setTimeout(() =>{if (document.body.contains(animation)){document.body.removeChild(animation)}}, 2000)}showNotification(message, type = 'info'){const notification = document.createElement('div');notification.className = `notification notification-${type}`;notification.textContent = message;notification.setAttribute('role', 'alert');notification.setAttribute('aria-live', 'polite');const colors ={success: '#27ae60', error: '#e74c3c', info: '#3498db'};Object.assign(notification.style,{position: 'fixed', top: '20px', right: '20px', padding: '16px 24px', borderRadius: '8px', backgroundColor: colors[type], color: '#ffffff', fontWeight: '600', boxShadow: '0 4px 12px rgba(0, 0, 0, 0.2)', zIndex: '10000', animation: 'slideInRight 0.3s ease-out', maxWidth: '400px', wordWrap: 'break-word'});document.body.appendChild(notification);setTimeout(() =>{notification.style.animation = 'slideOutRight 0.3s ease-out';setTimeout(() =>{if (document.body.contains(notification)){document.body.removeChild(notification)}}, 300)}, 4000)}_addStyles(){if (document.getElementById('execution-history-ui-styles')){return}const style = document.createElement('style');style.id = 'execution-history-ui-styles';style.textContent = ` @keyframes ratingPulse{0%{opacity: 0;transform: translate(-50%, -50%) scale(0.5)}50%{opacity: 1;transform: translate(-50%, -50%) scale(1.2)}100%{opacity: 0;transform: translate(-50%, -50%) scale(1)}}@keyframes slideInRight{from{transform: translateX(400px);opacity: 0}to{transform: translateX(0);opacity: 1}}@keyframes slideOutRight{from{transform: translateX(0);opacity: 1}to{transform: translateX(400px);opacity: 0}}`;document.head.appendChild(style)}async getPromptStats(promptId){try{const prompt = await this.executionManager.db .collection(`users/${this.executionManager.currentUser.uid}/prompts`) .doc(promptId) .get();if (prompt.exists){return ( prompt.data().stats ||{executionCount: 0, averageRating: 0, lastExecutedAt: null})}return{executionCount: 0, averageRating: 0, lastExecutedAt: null}}catch (error){console.error('❌ 통계 조회 실패:', error);return{executionCount: 0, averageRating: 0, lastExecutedAt: null}}}cleanup(){this.currentPromptId = null;this.currentVersionId = null}}if (typeof module !== 'undefined' && module.exports){module.exports = ExecutionHistoryUI}