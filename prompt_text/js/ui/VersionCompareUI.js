class VersionCompareUI{constructor(versionManager, diffManager, rollbackModal){if (!versionManager || !diffManager){throw new Error('VersionManager와 DiffManager 인스턴스가 필요합니다.')}this.versionManager = versionManager;this.diffManager = diffManager;this.rollbackModal = rollbackModal;this.currentPromptId = null;this.version1 = null;this.version2 = null;this.version1Select = null;this.version2Select = null;this.compareButton = null;this.compareView = null;this.leftContent = null;this.rightContent = null;this.leftLineNumbers = null;this.rightLineNumbers = null;this.isScrolling = false;this.scrollTimeout = null;this.init()}init(){this.initElements();this.initEventListeners()}initElements(){this.version1Select = document.getElementById('version1-select');this.version2Select = document.getElementById('version2-select');this.compareButton = document.getElementById('compare-button');this.compareView = document.getElementById('compare-view');this.leftContent = document.getElementById('left-content');this.rightContent = document.getElementById('right-content');this.leftLineNumbers = document.getElementById('left-line-numbers');this.rightLineNumbers = document.getElementById('right-line-numbers');if (!this.version1Select || !this.version2Select){throw new Error('필수 DOM 요소를 찾을 수 없습니다.')}}initEventListeners(){this.version1Select.addEventListener('change', () => this.onVersionChange());this.version2Select.addEventListener('change', () => this.onVersionChange());const swapButton = document.getElementById('swap-versions');if (swapButton){swapButton.addEventListener('click', () => this.swapVersions())}if (this.compareButton){this.compareButton.addEventListener('click', () => this.compare())}const closeButton = document.getElementById('close-compare');if (closeButton){closeButton.addEventListener('click', () => this.close())}const rollbackButton = document.getElementById('rollback-button');if (rollbackButton){rollbackButton.addEventListener('click', () => this.rollback())}if (this.leftContent && this.rightContent){this.leftContent.addEventListener('scroll', () => this.syncScroll('left'));this.rightContent.addEventListener('scroll', () => this.syncScroll('right'))}}async loadVersions(promptId){try{this.currentPromptId = promptId;const versions = await this.versionManager.getVersions(promptId);this.populateVersionSelects(versions)}catch (error){console.error('❌ 버전 로드 실패:', error);this.showError(error.message)}}populateVersionSelects(versions){const sortedVersions = versions.sort((a, b) => b.createdAt.toDate() - a.createdAt.toDate());const options = sortedVersions .map((version) =>{const date = version.createdAt.toDate().toLocaleDateString('ko-KR');return `<option value="${version.id}">${version.version}(${date})</option>`}) .join('');this.version1Select.innerHTML = '<option value="">버전 선택...</option>' + options;this.version2Select.innerHTML = '<option value="">버전 선택...</option>' + options;if (sortedVersions.length >= 2){this.version1Select.value = sortedVersions[1].id;this.version2Select.value = sortedVersions[0].id;this.onVersionChange()}}onVersionChange(){const version1Id = this.version1Select.value;const version2Id = this.version2Select.value;if (version1Id && version2Id && version1Id !== version2Id){this.compareButton.disabled = false}else{this.compareButton.disabled = true}}swapVersions(){const tempVersionId = this.version1Select.value;this.version1Select.value = this.version2Select.value;this.version2Select.value = tempVersionId;this.onVersionChange()}async compare(){try{this.showLoading();this.hideError();this.hideEmpty();const version1Id = this.version1Select.value;const version2Id = this.version2Select.value;this.version1 = await this.versionManager.getVersionByIds(this.currentPromptId, version1Id);this.version2 = await this.versionManager.getVersionByIds(this.currentPromptId, version2Id);const diffs = this.diffManager.diff(this.version1.content, this.version2.content,{cleanup: true});const stats = this.diffManager.getDiffStats(diffs);const similarity = this.diffManager.calculateSimilarity(this.version1.content, this.version2.content);this.renderComparison(diffs, stats, similarity)}catch (error){console.error('❌ 비교 실패:', error);this.showError(error.message)}finally{this.hideLoading()}}renderComparison(diffs, stats, similarity){this.renderStats(stats, similarity);const{left, right}= this.diffManager.diffToPrettyHtml(this.version1.content, this.version2.content, diffs,{addAriaLabels: true});this.leftContent.innerHTML = left;this.rightContent.innerHTML = right;this.leftContent.setAttribute('aria-label', `원본 버전 ${this.version1.version}내용`);this.rightContent.setAttribute('aria-label', `비교 버전 ${this.version2.version}내용`);this.renderLineNumbers();this.renderVersionInfo();this.showCompareView()}renderStats(stats, similarity){document.getElementById('stat-insertions').textContent = stats.insertions;document.getElementById('stat-deletions').textContent = stats.deletions;document.getElementById('stat-unchanged').textContent = stats.unchanged;document.getElementById('stat-similarity').textContent = similarity + '%';const statsElement = document.getElementById('compare-stats');if (statsElement){statsElement.setAttribute('aria-hidden', 'false')}}renderLineNumbers(){const leftLines = this.leftContent.textContent.split('\n').length;const rightLines = this.rightContent.textContent.split('\n').length;this.leftLineNumbers.innerHTML = Array.from({length: leftLines}, (_, i) => `<span class="line-number">${i + 1}</span>` ).join('');this.rightLineNumbers.innerHTML = Array.from({length: rightLines}, (_, i) => `<span class="line-number">${i + 1}</span>` ).join('')}renderVersionInfo(){const leftTitle = document.getElementById('left-version-title');const leftBadge = document.getElementById('left-version-badge');if (leftTitle && leftBadge){leftTitle.textContent = '원본 버전';leftBadge.textContent = this.version1.version}const rightTitle = document.getElementById('right-version-title');const rightBadge = document.getElementById('right-version-badge');if (rightTitle && rightBadge){rightTitle.textContent = '비교 버전';rightBadge.textContent = this.version2.version}}syncScroll(source){if (this.isScrolling) return;this.isScrolling = true;clearTimeout(this.scrollTimeout);this.scrollTimeout = setTimeout(() =>{this.isScrolling = false}, 50);if (source === 'left'){this.rightContent.scrollTop = this.leftContent.scrollTop;this.rightLineNumbers.scrollTop = this.leftContent.scrollTop;this.leftLineNumbers.scrollTop = this.leftContent.scrollTop}else{this.leftContent.scrollTop = this.rightContent.scrollTop;this.leftLineNumbers.scrollTop = this.rightContent.scrollTop;this.rightLineNumbers.scrollTop = this.rightContent.scrollTop}}showCompareView(){if (this.compareView){this.compareView.setAttribute('aria-hidden', 'false')}}showLoading(){const loadingElement = document.getElementById('loading-state');if (loadingElement){loadingElement.setAttribute('aria-hidden', 'false')}}hideLoading(){const loadingElement = document.getElementById('loading-state');if (loadingElement){loadingElement.setAttribute('aria-hidden', 'true')}}showEmpty(){const emptyElement = document.getElementById('empty-state');if (emptyElement){emptyElement.setAttribute('aria-hidden', 'false')}}hideEmpty(){const emptyElement = document.getElementById('empty-state');if (emptyElement){emptyElement.setAttribute('aria-hidden', 'true')}}showError(message){const errorElement = document.getElementById('error-state');const errorMessageElement = document.getElementById('error-message');if (errorElement && errorMessageElement){errorMessageElement.textContent = message;errorElement.setAttribute('aria-hidden', 'false')}}hideError(){const errorElement = document.getElementById('error-state');if (errorElement){errorElement.setAttribute('aria-hidden', 'true')}}close(){if (this.compareView){this.compareView.setAttribute('aria-hidden', 'true')}const stats = document.getElementById('compare-stats');if (stats){stats.setAttribute('aria-hidden', 'true')}this.showEmpty();this.version1Select.value = '';this.version2Select.value = '';this.onVersionChange();document.dispatchEvent(new CustomEvent('versionCompareClose'))}async rollback(){try{if (!this.version1 || !this.version2){alert('먼저 버전을 비교해주세요.');return}if (!this.rollbackModal){if (!confirm('정말로 롤백하시겠습니까?')){return}await this.executeRollback('');return}const result = await this.rollbackModal.open(this.currentPromptId, this.version1.id,{currentVersion: this.version2.version, targetVersion: this.version1.version});if (!result.confirmed){return}await this.executeRollback(result.reason)}catch (error){console.error('❌ 롤백 실패:', error);alert('롤백에 실패했습니다: ' + error.message)}}async executeRollback(reason){try{this.showLoading();const newVersionId = await this.versionManager.rollbackToVersion(this.currentPromptId, this.version1.id,{reason});this.showNotification('✅ 롤백이 완료되었습니다! 새 버전이 생성되었습니다.', 'success');document.dispatchEvent( new CustomEvent('versionRollback',{detail:{promptId: this.currentPromptId, newVersionId: newVersionId, targetVersionId: this.version1.id}}) );await this.loadVersions(this.currentPromptId)}catch (error){console.error('❌ 롤백 실행 실패:', error);throw error}finally{this.hideLoading()}}showNotification(message, type = 'info'){const notification = document.createElement('div');notification.className = `notification notification-${type}`;notification.textContent = message;notification.setAttribute('role', 'alert');notification.setAttribute('aria-live', 'polite');const colors ={success: '#27ae60', error: '#e74c3c', info: '#3498db'};Object.assign(notification.style,{position: 'fixed', top: '20px', right: '20px', padding: '16px 24px', borderRadius: '8px', backgroundColor: colors[type], color: '#ffffff', fontWeight: '600', boxShadow: '0 4px 12px rgba(0, 0, 0, 0.2)', zIndex: '10001', animation: 'slideInRight 0.3s ease-out', maxWidth: '400px', wordWrap: 'break-word'});document.body.appendChild(notification);setTimeout(() =>{notification.style.animation = 'slideOutRight 0.3s ease-out';setTimeout(() =>{if (document.body.contains(notification)){document.body.removeChild(notification)}}, 300)}, 4000)}cleanup(){this.currentPromptId = null;this.version1 = null;this.version2 = null}}if (typeof module !== 'undefined' && module.exports){module.exports = VersionCompareUI}