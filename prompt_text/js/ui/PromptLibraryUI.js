import performanceOptimizer from '../utils/PerformanceOptimizer.js';class PromptLibraryUI{constructor(promptManager, container){if (!promptManager || !container){throw new Error('PromptManagerì™€ containerê°€ í•„ìš”í•©ë‹ˆë‹¤.')}this.promptManager = promptManager;this.container = container;this.prompts = [];this.filteredPrompts = [];this.selectedPrompt = null;this.isLoading = false;this.searchQuery = '';this.filters ={categories: [], tags: [], minRating: 0, dateRange: ''};this.availableCategories = [];this.availableTags = [];this.sortBy = 'createdAt';this.sortOrder = 'desc';this.performanceOptimizer = performanceOptimizer;this.renderCache = new Map();this.intersectionObserver = null;this.debouncedSearch = this.performanceOptimizer.debounce( (query) => this.handleSearch(query), 300, 'promptLibrarySearch' );this.throttledScroll = this.performanceOptimizer.throttle( () => this.handleScroll(), 100, 'promptLibraryScroll' );this.onPromptClick = null;this.onPromptSelect = null;this.init()}init(){this.render();this.addStyles()}async load(options ={}){try{this.showLoading();const prompts = await this.promptManager.getPrompts(options);this.prompts = prompts || [];this.filteredPrompts = [...this.prompts];this.extractFilters();this.renderFilterOptions();this.renderCards()}catch (error){console.error('âŒ í”„ë¡¬í”„íŠ¸ ë¡œë“œ ì‹¤íŒ¨:', error);this.showError(error.message)}finally{this.hideLoading()}}render(){this.container.innerHTML = ` <div class="prompt-library"> <!-- í—¤ë” --> <div class="library-header"> <h2>í”„ë¡¬í”„íŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬</h2> <p class="library-description">ì €ì¥ëœ í”„ë¡¬í”„íŠ¸ë¥¼ íƒìƒ‰í•˜ê³  ê´€ë¦¬í•˜ì„¸ìš”</p> </div> <!-- ê²€ìƒ‰ ë° í•„í„° ë°” --> <div class="search-filter-bar"> <!-- ê²€ìƒ‰ --> <div class="search-section" role="search"> <div class="search-container"> <span class="search-icon" aria-hidden="true">ğŸ”</span> <input type="search" id="prompt-search" class="search-input" placeholder="í”„ë¡¬í”„íŠ¸ ê²€ìƒ‰... (Ctrl+K)" aria-label="í”„ë¡¬í”„íŠ¸ ê²€ìƒ‰" autocomplete="off" spellcheck="false" > <button id="clear-search" class="btn-clear-search" title="ê²€ìƒ‰ ì§€ìš°ê¸°" aria-label="ê²€ìƒ‰ ì§€ìš°ê¸°" style="display: none;" > âœ• </button> </div> </div> <!-- í•„í„° --> <div class="filter-section"> <button id="filter-toggle" class="btn-filter-toggle" aria-label="í•„í„° ì—´ê¸°" aria-expanded="false" > <span class="filter-icon">ğŸ¯</span> <span class="filter-text">í•„í„°</span> <span id="filter-count" class="filter-count" style="display: none;">0</span> </button> <!-- í•„í„° íŒ¨ë„ --> <div id="filter-panel" class="filter-panel" style="display: none;"> <div class="filter-panel-header"> <h3>í•„í„°</h3> <button id="clear-filters" class="btn-clear-filters">ì´ˆê¸°í™”</button> </div> <div class="filter-panel-body"> <!-- ì¹´í…Œê³ ë¦¬ í•„í„° --> <div class="filter-group"> <label class="filter-label">ì¹´í…Œê³ ë¦¬</label> <div id="category-filters" class="filter-options"></div> </div> <!-- í‰ì  í•„í„° --> <div class="filter-group"> <label class="filter-label">ìµœì†Œ í‰ì </label> <div class="rating-filter"> <input type="range" id="rating-filter" min="0" max="5" step="0.5" value="0" aria-label="ìµœì†Œ í‰ì " > <div class="rating-value"> <span id="rating-value-text">ëª¨ë“  í‰ì </span> </div> </div> </div> <!-- ë‚ ì§œ í•„í„° --> <div class="filter-group"> <label class="filter-label">ìƒì„± ë‚ ì§œ</label> <select id="date-filter" class="filter-select" aria-label="ë‚ ì§œ ë²”ìœ„"> <option value="">ì „ì²´ ê¸°ê°„</option> <option value="today">ì˜¤ëŠ˜</option> <option value="week">ì´ë²ˆ ì£¼</option> <option value="month">ì´ë²ˆ ë‹¬</option> <option value="quarter">3ê°œì›”</option> <option value="year">1ë…„</option> </select> </div> <!-- íƒœê·¸ í•„í„° --> <div class="filter-group"> <label class="filter-label">íƒœê·¸</label> <div id="tag-filters" class="filter-tags"></div> </div> </div> </div> </div> <!-- ì •ë ¬ --> <div class="sort-section"> <label for="sort-select" class="sort-label">ì •ë ¬:</label> <select id="sort-select" class="sort-select" aria-label="ì •ë ¬ ê¸°ì¤€"> <option value="createdAt">ìµœì‹ ìˆœ</option> <option value="createdAt-asc">ì˜¤ë˜ëœìˆœ</option> <option value="rating">í‰ì  ë†’ì€ìˆœ</option> <option value="rating-asc">í‰ì  ë‚®ì€ìˆœ</option> <option value="executionCount">ì‹¤í–‰ ë§ì€ìˆœ</option> <option value="executionCount-asc">ì‹¤í–‰ ì ì€ìˆœ</option> <option value="title">ì´ë¦„ìˆœ (A-Z)</option> <option value="title-asc">ì´ë¦„ìˆœ (Z-A)</option> </select> </div> <!-- ê²€ìƒ‰/í•„í„° ê²°ê³¼ ì •ë³´ --> <div id="search-results-info" class="search-results-info" aria-live="polite" aria-atomic="true"></div> </div> <!-- ì¹´ë“œ ê·¸ë¦¬ë“œ --> <div id="prompt-grid" class="prompt-grid"></div> <!-- ë¡œë”© --> <div id="library-loading" class="library-loading" style="display: none;" role="status" aria-live="polite" aria-atomic="true"> <div class="spinner" aria-hidden="true"></div> <p>í”„ë¡¬í”„íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p> </div> <!-- ë¹ˆ ìƒíƒœ --> <div id="library-empty" class="library-empty" style="display: none;"> <div class="empty-icon" aria-hidden="true">ğŸ“</div> <h3>í”„ë¡¬í”„íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤</h3> <p>ìƒˆë¡œìš´ í”„ë¡¬í”„íŠ¸ë¥¼ ìƒì„±í•´ë³´ì„¸ìš”</p> <button class="btn-create-prompt">í”„ë¡¬í”„íŠ¸ ìƒì„±</button> </div> <!-- ì—ëŸ¬ --> <div id="library-error" class="library-error" style="display: none;" role="alert" aria-live="polite" aria-atomic="true"> <div class="error-icon" aria-hidden="true">âš ï¸</div> <h3>í”„ë¡¬í”„íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h3> <p id="library-error-message">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p> <button class="btn-retry">ë‹¤ì‹œ ì‹œë„</button> </div> </div> `;this.initEventListeners()}initEventListeners(){const searchInput = document.getElementById('prompt-search');if (searchInput){searchInput.addEventListener('input', (e) =>{this.handleSearchInput(e.target.value)});document.addEventListener('keydown', (e) =>{if ((e.ctrlKey || e.metaKey) && e.key === 'k'){e.preventDefault();searchInput.focus()}})}const clearBtn = document.getElementById('clear-search');if (clearBtn){clearBtn.addEventListener('click', () =>{this.clearSearch()})}const filterToggle = document.getElementById('filter-toggle');if (filterToggle){filterToggle.addEventListener('click', () =>{this.toggleFilterPanel()})}const clearFilters = document.getElementById('clear-filters');if (clearFilters){clearFilters.addEventListener('click', () =>{this.clearFilters()})}const ratingFilter = document.getElementById('rating-filter');if (ratingFilter){ratingFilter.addEventListener('input', (e) =>{this.handleRatingFilter(parseFloat(e.target.value))})}const dateFilter = document.getElementById('date-filter');if (dateFilter){dateFilter.addEventListener('change', (e) =>{this.handleDateFilter(e.target.value)})}const sortSelect = document.getElementById('sort-select');if (sortSelect){sortSelect.addEventListener('change', (e) =>{this.handleSort(e.target.value)})}const createBtn = this.container.querySelector('.btn-create-prompt');if (createBtn){createBtn.addEventListener('click', () =>{this.handleCreatePrompt()})}const retryBtn = this.container.querySelector('.btn-retry');if (retryBtn){retryBtn.addEventListener('click', () =>{this.load()})}document.addEventListener('click', (e) =>{const filterPanel = document.getElementById('filter-panel');const filterToggle = document.getElementById('filter-toggle');if (filterPanel && filterPanel.style.display === 'block'){if (!filterPanel.contains(e.target) && !filterToggle.contains(e.target)){this.closeFilterPanel()}}})}handleSearchInput(query){if (this.searchTimeout){clearTimeout(this.searchTimeout)}const clearBtn = document.getElementById('clear-search');if (clearBtn){clearBtn.style.display = query ? 'block' : 'none'}this.searchTimeout = setTimeout(() =>{this.searchQuery = query.trim();this.performSearch()}, 300)}performSearch(){if (!this.searchQuery){this.filteredPrompts = [...this.prompts];this.renderCards();this.updateSearchResults(this.prompts.length, this.prompts.length);return}const query = this.searchQuery.toLowerCase();this.filteredPrompts = this.prompts.filter((prompt) =>{const titleMatch = (prompt.title || '').toLowerCase().includes(query);const descriptionMatch = (prompt.description || '').toLowerCase().includes(query);const categoryMatch = (prompt.category || '').toLowerCase().includes(query);const tagsMatch = (prompt.tags || []).some((tag) => tag.toLowerCase().includes(query));return titleMatch || descriptionMatch || categoryMatch || tagsMatch});this.currentSearchQuery = query;this.renderCards();this.updateSearchResults(this.filteredPrompts.length, this.prompts.length)}updateSearchResults(resultCount, totalCount){const resultsInfo = document.getElementById('search-results-info');if (!resultsInfo) return;if (this.searchQuery){resultsInfo.textContent = `${resultCount}ê°œì˜ í”„ë¡¬í”„íŠ¸ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤ (ì „ì²´ ${totalCount}ê°œ)`;resultsInfo.style.display = 'block'}else{resultsInfo.textContent = '';resultsInfo.style.display = 'none'}}clearSearch(){const searchInput = document.getElementById('prompt-search');if (searchInput){searchInput.value = '';searchInput.focus()}this.searchQuery = '';this.currentSearchQuery = '';const clearBtn = document.getElementById('clear-search');if (clearBtn){clearBtn.style.display = 'none'}this.applyFilters()}extractFilters(){const categories = new Set();const tags = new Set();this.prompts.forEach((prompt) =>{if (prompt.category){categories.add(prompt.category)}if (prompt.tags && Array.isArray(prompt.tags)){prompt.tags.forEach((tag) => tags.add(tag))}});this.availableCategories = Array.from(categories).sort();this.availableTags = Array.from(tags).sort()}renderFilterOptions(){const categoryContainer = document.getElementById('category-filters');if (categoryContainer){categoryContainer.innerHTML = this.availableCategories .map( (category) => ` <label class="filter-checkbox"> <input type="checkbox" value="${this.escapeHtml(category)}" data-filter="category" > <span>${this.escapeHtml(category)}</span> </label> ` ) .join('');categoryContainer.querySelectorAll('input[type="checkbox"]').forEach((checkbox) =>{checkbox.addEventListener('change', () =>{this.handleCategoryFilter()})})}const tagContainer = document.getElementById('tag-filters');if (tagContainer){tagContainer.innerHTML = this.availableTags .map( (tag) => ` <button class="tag-filter-btn" data-tag="${this.escapeHtml(tag)}" aria-pressed="false" > ${this.escapeHtml(tag)}</button> ` ) .join('');tagContainer.querySelectorAll('.tag-filter-btn').forEach((btn) =>{btn.addEventListener('click', () =>{this.handleTagFilter(btn)})})}}toggleFilterPanel(){const panel = document.getElementById('filter-panel');const toggle = document.getElementById('filter-toggle');if (panel.style.display === 'none' || !panel.style.display){panel.style.display = 'block';toggle.setAttribute('aria-expanded', 'true')}else{panel.style.display = 'none';toggle.setAttribute('aria-expanded', 'false')}}closeFilterPanel(){const panel = document.getElementById('filter-panel');const toggle = document.getElementById('filter-toggle');if (panel){panel.style.display = 'none'}if (toggle){toggle.setAttribute('aria-expanded', 'false')}}handleCategoryFilter(){const checkboxes = document.querySelectorAll('input[data-filter="category"]:checked');this.filters.categories = Array.from(checkboxes).map((cb) => cb.value);this.applyFilters()}handleTagFilter(btn){const tag = btn.dataset.tag;const isPressed = btn.getAttribute('aria-pressed') === 'true';if (isPressed){btn.setAttribute('aria-pressed', 'false');btn.classList.remove('active');this.filters.tags = this.filters.tags.filter((t) => t !== tag)}else{btn.setAttribute('aria-pressed', 'true');btn.classList.add('active');this.filters.tags.push(tag)}this.applyFilters()}handleRatingFilter(rating){this.filters.minRating = rating;const ratingText = document.getElementById('rating-value-text');if (ratingText){if (rating === 0){ratingText.textContent = 'ëª¨ë“  í‰ì '}else{ratingText.textContent = `${rating}ì  ì´ìƒ ${'â­'.repeat(Math.floor(rating))}`}}this.applyFilters()}handleDateFilter(range){this.filters.dateRange = range;this.applyFilters()}applyFilters(){const cacheKey = JSON.stringify({searchQuery: this.searchQuery, filters: this.filters});const cached = this.performanceOptimizer.getCache(cacheKey);if (cached){this.filteredPrompts = cached;this.sortPrompts();this.renderCards();this.updateSearchResults(cached.length, this.prompts.length);this.updateFilterCount();return}const categoriesSet = this.filters.categories.length > 0 ? new Set(this.filters.categories) : null;const tagsSet = this.filters.tags.length > 0 ? new Set(this.filters.tags) : null;const searchQuery = this.searchQuery ? this.searchQuery.toLowerCase() : null;const minRating = this.filters.minRating || 0;let startDate = null;if (this.filters.dateRange){const now = new Date();switch (this.filters.dateRange){case 'today': startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());break;case 'week': startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);break;case 'month': startDate = new Date(now.getFullYear(), now.getMonth(), 1);break;case 'quarter': startDate = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);break;case 'year': startDate = new Date(now.getTime() - 365 * 24 * 60 * 60 * 1000);break}}const filtered = this.performanceOptimizer.optimizedFilter(this.prompts, (prompt) =>{if (searchQuery){const titleMatch = (prompt.title || '').toLowerCase().includes(searchQuery);const descriptionMatch = (prompt.description || '').toLowerCase().includes(searchQuery);const categoryMatch = (prompt.category || '').toLowerCase().includes(searchQuery);let tagsMatch = false;if (prompt.tags && prompt.tags.length > 0){const promptTagsLower = prompt.tags.map(tag => tag.toLowerCase());tagsMatch = promptTagsLower.some(tag => tag.includes(searchQuery))}if (!titleMatch && !descriptionMatch && !categoryMatch && !tagsMatch){return false}}if (categoriesSet && !categoriesSet.has(prompt.category)){return false}if (tagsSet && prompt.tags){const hasMatchingTag = prompt.tags.some(tag => tagsSet.has(tag));if (!hasMatchingTag){return false}}if (minRating > 0){const rating = prompt.stats?.averageRating || 0;if (rating < minRating){return false}}if (startDate && prompt.createdAt){const createdDate = prompt.createdAt.toDate ? prompt.createdAt.toDate() : new Date(prompt.createdAt);if (createdDate < startDate){return false}}return true});this.filteredPrompts = filtered;this.performanceOptimizer.setCache(cacheKey, filtered, 30000);this.sortPrompts();this.renderCards();this.updateSearchResults(filtered.length, this.prompts.length);this.updateFilterCount()}handleSort(sortValue){if (sortValue.endsWith('-asc')){this.sortBy = sortValue.replace('-asc', '');this.sortOrder = 'asc'}else{this.sortBy = sortValue;this.sortOrder = 'desc'}this.sortPrompts();this.renderCards();`)}sortPrompts(){this.filteredPrompts.sort((a, b) =>{let valueA, valueB;switch (this.sortBy){case 'createdAt': valueA = a.createdAt ? a.createdAt.toDate ? a.createdAt.toDate() : new Date(a.createdAt) : new Date(0);valueB = b.createdAt ? b.createdAt.toDate ? b.createdAt.toDate() : new Date(b.createdAt) : new Date(0);break;case 'rating': valueA = a.stats?.averageRating || 0;valueB = b.stats?.averageRating || 0;break;case 'executionCount': valueA = a.stats?.executionCount || 0;valueB = b.stats?.executionCount || 0;break;case 'title': valueA = (a.title || '').toLowerCase();valueB = (b.title || '').toLowerCase();if (this.sortOrder === 'desc'){return valueB.localeCompare(valueA)}else{return valueA.localeCompare(valueB)}default: return 0}if (this.sortOrder === 'desc'){return valueB > valueA ? 1 : valueB < valueA ? -1 : 0}else{return valueA > valueB ? 1 : valueA < valueB ? -1 : 0}})}updateFilterCount(){let count = 0;if (this.filters.categories.length > 0) count += this.filters.categories.length;if (this.filters.tags.length > 0) count += this.filters.tags.length;if (this.filters.minRating > 0) count += 1;if (this.filters.dateRange) count += 1;const filterCount = document.getElementById('filter-count');if (filterCount){if (count > 0){filterCount.textContent = count;filterCount.style.display = 'inline-block'}else{filterCount.style.display = 'none'}}}clearFilters(){this.filters ={categories: [], tags: [], minRating: 0, dateRange: ''};document.querySelectorAll('input[data-filter="category"]').forEach((cb) =>{cb.checked = false});document.querySelectorAll('.tag-filter-btn').forEach((btn) =>{btn.setAttribute('aria-pressed', 'false');btn.classList.remove('active')});const ratingFilter = document.getElementById('rating-filter');if (ratingFilter){ratingFilter.value = 0;this.handleRatingFilter(0)}const dateFilter = document.getElementById('date-filter');if (dateFilter){dateFilter.value = ''}this.applyFilters()}renderCards(){const grid = document.getElementById('prompt-grid');if (!this.prompts || this.prompts.length === 0){this.showEmpty();return}if (this.filteredPrompts.length === 0){this.showNoResults();return}this.hideEmpty();this.hideError();this.hideNoResults();const startTime = performance.now();const fragment = document.createDocumentFragment();const tempDiv = document.createElement('div');tempDiv.innerHTML = this.filteredPrompts.map((prompt) => this.memoizedRenderCard(prompt)).join('');while (tempDiv.firstChild){fragment.appendChild(tempDiv.firstChild)}grid.innerHTML = '';grid.appendChild(fragment);this.addCardListeners();requestAnimationFrame(() =>{this.applyLazyLoading()});const endTime = performance.now();.toFixed(2)}ms (${this.filteredPrompts.length}ê°œ ì¹´ë“œ)`)}renderCard(prompt){const stats = prompt.stats ||{executionCount: 0, averageRating: 0};const category = prompt.category || 'ë¯¸ë¶„ë¥˜';const description = prompt.description || 'ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.';const version = prompt.currentVersion || 'v1.0.0';const rating = stats.averageRating || 0;const executionCount = stats.executionCount || 0;const stars = this.renderStars(rating);const categoryColor = this.getCategoryColor(category);const highlightedTitle = this.highlightText(prompt.title);const highlightedDescription = this.highlightText(this.truncateText(description, 100));const highlightedCategory = this.highlightText(category);return ` <article class="prompt-card" data-prompt-id="${prompt.id}" role="article" aria-labelledby="prompt-title-${prompt.id}" tabindex="0" > <!-- ì¹´ë“œ í—¤ë” --> <div class="card-header"> <span class="card-category" style="background-color: ${categoryColor}"> ${highlightedCategory}</span> <span class="card-version">${version}</span> </div> <!-- ì¹´ë“œ ë³¸ë¬¸ --> <div class="card-body"> <h3 id="prompt-title-${prompt.id}" class="card-title"> ${highlightedTitle}</h3> <p class="card-description"> ${highlightedDescription}</p> </div> <!-- ì¹´ë“œ í‘¸í„° --> <div class="card-footer"> <div class="card-stats"> <div class="stat-item"> <span class="stat-icon">â­</span> <span class="stat-value">${rating.toFixed(1)}</span> <span class="stat-label">í‰ì </span> </div> <div class="stat-item"> <span class="stat-icon">â–¶ï¸</span> <span class="stat-value">${executionCount}</span> <span class="stat-label">ì‹¤í–‰</span> </div> </div> <div class="card-actions"> <button class="btn-card-action btn-view" data-action="view" aria-label="í”„ë¡¬í”„íŠ¸ ìƒì„¸ ë³´ê¸°" > ë³´ê¸° </button> <button class="btn-card-action btn-execute" data-action="execute" aria-label="í”„ë¡¬í”„íŠ¸ ì‹¤í–‰" > ì‹¤í–‰ </button> </div> </div> </article> `}renderStars(rating){const fullStars = Math.floor(rating);const hasHalfStar = rating % 1 >= 0.5;const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);let html = '';for (let starIndex = 0;starIndex < fullStars;starIndex++){html += '<span class="star star-full">â˜…</span>'}if (hasHalfStar){html += '<span class="star star-half">â˜…</span>'}for (let starIndex = 0;starIndex < emptyStars;starIndex++){html += '<span class="star star-empty">â˜†</span>'}return html}getCategoryColor(category){const colors ={ê°œë°œ: '#3498db', ë§ˆì¼€íŒ…: '#e74c3c', ë””ìì¸: '#9b59b6', ë¹„ì¦ˆë‹ˆìŠ¤: '#f39c12', êµìœ¡: '#27ae60', ê¸°íƒ€: '#95a5a6', ë¯¸ë¶„ë¥˜: '#bdc3c7'};return colors[category] || colors['ë¯¸ë¶„ë¥˜']}addCardListeners(){if (this.cardClickHandler){this.container.removeEventListener('click', this.cardClickHandler);this.container.removeEventListener('keydown', this.cardKeydownHandler)}this.cardClickHandler = (e) =>{const card = e.target.closest('.prompt-card');if (!card) return;const promptId = card.dataset.promptId;if (!promptId) return;const actionBtn = e.target.closest('[data-action]');if (actionBtn){e.stopPropagation();const action = actionBtn.dataset.action;switch (action){case 'view': this.handleViewPrompt(promptId);break;case 'execute': this.handleExecutePrompt(promptId);break}return}if (!e.target.closest('.btn-card-action')){this.handleCardClick(promptId)}};this.cardKeydownHandler = (e) =>{const card = e.target.closest('.prompt-card');if (!card) return;const promptId = card.dataset.promptId;if (!promptId) return;if (e.key === 'Enter' || e.key === ' '){e.preventDefault();this.handleCardClick(promptId)}};this.container.addEventListener('click', this.cardClickHandler);this.container.addEventListener('keydown', this.cardKeydownHandler)}handleCardClick(promptId){const prompt = this.prompts.find((p) => p.id === promptId);if (!prompt) return;this.selectedPrompt = prompt;this.updateSelection(promptId);if (this.onPromptClick){this.onPromptClick(prompt)}}handleViewPrompt(promptId){const prompt = this.prompts.find((p) => p.id === promptId);if (!prompt) return;this.container.dispatchEvent( new CustomEvent('promptView',{detail:{prompt}}) )}handleExecutePrompt(promptId){const prompt = this.prompts.find((p) => p.id === promptId);if (!prompt) return;this.container.dispatchEvent( new CustomEvent('promptExecute',{detail:{prompt}}) )}handleCreatePrompt(){this.container.dispatchEvent(new CustomEvent('promptCreate'))}updateSelection(promptId){const cards = this.container.querySelectorAll('.prompt-card');cards.forEach((card) =>{card.classList.remove('selected');card.setAttribute('aria-selected', 'false')});const selectedCard = this.container.querySelector(`[data-prompt-id="${promptId}"]`);if (selectedCard){selectedCard.classList.add('selected');selectedCard.setAttribute('aria-selected', 'true')}}truncateText(text, maxLength){if (!text) return '';if (text.length <= maxLength) return text;return text.substring(0, maxLength) + '...'}escapeHtml(text){if (!text) return '';const div = document.createElement('div');div.textContent = text;return div.innerHTML}highlightText(text){if (!text || !this.currentSearchQuery){return this.escapeHtml(text)}const escapedText = this.escapeHtml(text);const query = this.escapeHtml(this.currentSearchQuery);const regex = new RegExp(`(${query})`, 'gi');return escapedText.replace(regex, '<mark class="search-highlight">$1</mark>')}showLoading(){this.isLoading = true;document.getElementById('library-loading').style.display = 'block';document.getElementById('prompt-grid').style.display = 'none';document.getElementById('library-empty').style.display = 'none';document.getElementById('library-error').style.display = 'none'}hideLoading(){this.isLoading = false;document.getElementById('library-loading').style.display = 'none';document.getElementById('prompt-grid').style.display = 'grid'}showEmpty(){document.getElementById('library-empty').style.display = 'block';document.getElementById('prompt-grid').style.display = 'none'}hideEmpty(){document.getElementById('library-empty').style.display = 'none'}showError(message){document.getElementById('library-error').style.display = 'block';document.getElementById('library-error-message').textContent = message;document.getElementById('prompt-grid').style.display = 'none'}hideError(){document.getElementById('library-error').style.display = 'none'}showNoResults(){const grid = document.getElementById('prompt-grid');grid.innerHTML = ` <div class="no-results"> <div class="no-results-icon">ğŸ”</div> <h3>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</h3> <p>"${this.escapeHtml(this.searchQuery)}"ì— ëŒ€í•œ í”„ë¡¬í”„íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p> <button class="btn-clear-search-inline" onclick="document.getElementById('clear-search').click()"> ê²€ìƒ‰ ì§€ìš°ê¸° </button> </div> `}hideNoResults(){}addStyles(){if (document.getElementById('prompt-library-styles')){return}const style = document.createElement('style');style.id = 'prompt-library-styles';style.textContent = ` .prompt-library{padding: 24px}.library-header{margin-bottom: 24px}.library-header h2{font-size: 28px;font-weight: 700;color: #2c3e50;margin-bottom: 8px}.library-description{font-size: 16px;color: #7f8c8d}.search-filter-bar{margin-bottom: 24px}.search-section{margin-bottom: 12px}.sort-section{display: flex;align-items: center;gap: 12px;margin-bottom: 16px;justify-content: flex-end}.sort-label{font-size: 14px;font-weight: 600;color: #2c3e50}.sort-select{padding: 8px 32px 8px 12px;border: 2px solid #e1e8ed;border-radius: 8px;font-size: 14px;color: #2c3e50;background: white;cursor: pointer;transition: all 0.3s ease;appearance: none;background-image: url("data:image/svg+xml,%3Csvg xmlns='http: background-repeat: no-repeat;background-position: right 12px center}.sort-select:hover{border-color: #667eea}.sort-select:focus{outline: none;border-color: #667eea;box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1)}.search-container{position: relative;display: flex;align-items: center;background: white;border: 2px solid #e1e8ed;border-radius: 12px;padding: 12px 16px;transition: all 0.3s ease}.search-container:focus-within{border-color: #667eea;box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1)}.search-icon{font-size: 20px;margin-right: 12px;color: #95a5a6}.search-input{flex: 1;border: none;outline: none;font-size: 16px;color: #2c3e50;background: transparent}.search-input::placeholder{color: #bdc3c7}.search-input::-webkit-search-cancel-button{display: none}.btn-clear-search{width: 24px;height: 24px;border: none;border-radius: 50%;background: #95a5a6;color: white;font-size: 14px;cursor: pointer;transition: all 0.3s ease;display: flex;align-items: center;justify-content: center;margin-left: 8px}.btn-clear-search:hover{background: #7f8c8d}.search-results-info{margin-top: 12px;font-size: 14px;color: #7f8c8d;text-align: center}.search-highlight{background: #fff3cd;color: #856404;padding: 2px 4px;border-radius: 3px;font-weight: 600}.no-results{grid-column: 1 / -1;text-align: center;padding: 80px 20px}.no-results-icon{font-size: 64px;margin-bottom: 20px;opacity: 0.5}.no-results h3{font-size: 20px;font-weight: 600;color: #2c3e50;margin-bottom: 10px}.no-results p{font-size: 14px;color: #7f8c8d;margin-bottom: 24px}.btn-clear-search-inline{padding: 10px 20px;border: none;border-radius: 8px;background: #667eea;color: white;font-size: 14px;font-weight: 600;cursor: pointer;transition: all 0.3s ease}.btn-clear-search-inline:hover{background: #5568d3}.prompt-grid{display: grid;grid-template-columns: repeat(3, 1fr);gap: 24px;margin-bottom: 32px}.prompt-card{background: white;border-radius: 12px;padding: 20px;box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);transition: all 0.3s ease;cursor: pointer;outline: none;position: relative}.prompt-card:hover{transform: translateY(-4px);box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15)}.prompt-card:focus{box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3)}.prompt-card.selected{border: 2px solid #667eea;box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2)}.card-header{display: flex;justify-content: space-between;align-items: center;margin-bottom: 16px}.card-category{display: inline-block;padding: 4px 12px;border-radius: 12px;font-size: 12px;font-weight: 600;color: white}.card-version{font-size: 12px;color: #95a5a6;font-weight: 600}.card-body{margin-bottom: 16px}.card-title{font-size: 18px;font-weight: 700;color: #2c3e50;margin-bottom: 8px;line-height: 1.4}.card-description{font-size: 14px;color: #7f8c8d;line-height: 1.6;min-height: 60px}.card-footer{display: flex;flex-direction: column;gap: 12px;padding-top: 16px;border-top: 1px solid #ecf0f1}.card-stats{display: flex;gap: 16px}.stat-item{display: flex;align-items: center;gap: 6px}.stat-icon{font-size: 16px}.stat-value{font-size: 16px;font-weight: 700;color: #2c3e50}.stat-label{font-size: 12px;color: #95a5a6}.card-actions{display: flex;gap: 8px}.btn-card-action{flex: 1;padding: 10px 16px;border: none;border-radius: 8px;font-size: 14px;font-weight: 600;cursor: pointer;transition: all 0.3s ease;min-height: 44px}.btn-view{background: #ecf0f1;color: #2c3e50}.btn-view:hover{background: #d1d8dd}.btn-execute{background: #667eea;color: white}.btn-execute:hover{background: #5568d3}.btn-card-action:focus{outline: none;box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3)}.star{font-size: 14px}.star-full{color: #FFD700}.star-half{color: #FFD700;opacity: 0.5}.star-empty{color: #ddd}.library-loading{text-align: center;padding: 80px 20px}.spinner{width: 50px;height: 50px;margin: 0 auto 20px;border: 5px solid #e1e8ed;border-top-color: #667eea;border-radius: 50%;animation: spin 1s linear infinite}@keyframes spin{to{transform: rotate(360deg)}}.library-empty{text-align: center;padding: 80px 20px}.empty-icon{font-size: 64px;margin-bottom: 20px}.library-empty h3{font-size: 20px;font-weight: 600;color: #2c3e50;margin-bottom: 10px}.library-empty p{font-size: 14px;color: #7f8c8d;margin-bottom: 24px}.btn-create-prompt{padding: 12px 24px;border: none;border-radius: 8px;background: #667eea;color: white;font-size: 14px;font-weight: 600;cursor: pointer;transition: all 0.3s ease;min-height: 44px}.btn-create-prompt:hover{background: #5568d3}.library-error{text-align: center;padding: 80px 20px}.error-icon{font-size: 64px;margin-bottom: 20px}.library-error h3{font-size: 20px;font-weight: 600;color: #e74c3c;margin-bottom: 10px}.library-error p{font-size: 14px;color: #7f8c8d;margin-bottom: 24px}.btn-retry{padding: 12px 24px;border: none;border-radius: 8px;background: #667eea;color: white;font-size: 14px;font-weight: 600;cursor: pointer;transition: all 0.3s ease;min-height: 44px}.btn-retry:hover{background: #5568d3}@media (max-width: 1024px){.prompt-grid{grid-template-columns: repeat(2, 1fr);gap: 20px}}@media (max-width: 768px){.prompt-library{padding: 16px}.library-header{margin-bottom: 16px}.library-header h2{font-size: 24px}.search-bar{margin-bottom: 16px}.search-container{padding: 10px 12px}.search-input{font-size: 14px}.search-input::placeholder{font-size: 13px}.sort-section{flex-direction: column;align-items: flex-start;gap: 8px}.sort-select{width: 100%}.prompt-grid{grid-template-columns: 1fr;gap: 16px}.prompt-card{padding: 16px}.card-title{font-size: 16px}.card-description{font-size: 13px;min-height: auto}.card-actions{flex-direction: column}.btn-card-action{width: 100%}}@media (prefers-color-scheme: dark){.prompt-library{background: #1a1a1a}.library-header h2{color: #e1e8ed}.library-description{color: #95a5a6}.prompt-card{background: #2c2c2c;box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3)}.prompt-card:hover{box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4)}.card-title{color: #e1e8ed}.card-description{color: #95a5a6}.btn-view{background: #3a3a3a;color: #e1e8ed}.btn-view:hover{background: #4a4a4a}}@media (prefers-contrast: high){.prompt-card{border: 2px solid #2c3e50}.prompt-card:focus{border: 3px solid #667eea}.btn-card-action{border: 2px solid currentColor}}@media (prefers-reduced-motion: reduce){.prompt-card, .btn-card-action, .spinner{transition: none;animation: none}.prompt-card:hover{transform: none}}`;document.head.appendChild(style)}clearRenderCache(){this.renderCache.clear()}memoizedRenderCard(prompt){const cacheKey = `${prompt.id}-${this.currentSearchQuery || ''}-${this.filters.minRating}`;if (this.renderCache.has(cacheKey)){return this.renderCache.get(cacheKey)}const html = this.renderCard(prompt);if (this.renderCache.size > 100){const firstKey = this.renderCache.keys().next().value;this.renderCache.delete(firstKey)}this.renderCache.set(cacheKey, html);return html}initIntersectionObserver(){if (this.intersectionObserver){return}const options ={root: null, rootMargin: '50px', threshold: 0.01};this.intersectionObserver = new IntersectionObserver((entries) =>{entries.forEach((entry) =>{if (entry.isIntersecting){const card = entry.target;const img = card.querySelector('img[data-src]');if (img){img.src = img.dataset.src;img.removeAttribute('data-src');img.classList.add('loaded')}this.intersectionObserver.unobserve(card)}})}, options)}applyLazyLoading(){if (!this.intersectionObserver){this.initIntersectionObserver()}const cards = this.container.querySelectorAll('.prompt-card');cards.forEach((card) =>{this.intersectionObserver.observe(card)})}throttle(func, delay){let lastCall = 0;return function (...args){const now = Date.now();if (now - lastCall >= delay){lastCall = now;return func.apply(this, args)}}}cleanup(){if (this.intersectionObserver){this.intersectionObserver.disconnect();this.intersectionObserver = null}if (this.searchTimeout){clearTimeout(this.searchTimeout);this.searchTimeout = null}if (this.cardClickHandler){this.container.removeEventListener('click', this.cardClickHandler);this.cardClickHandler = null}if (this.cardKeydownHandler){this.container.removeEventListener('keydown', this.cardKeydownHandler);this.cardKeydownHandler = null}this.clearRenderCache();this.container.innerHTML = '';this.prompts = [];this.filteredPrompts = [];this.selectedPrompt = null}}if (typeof module !== 'undefined' && module.exports){module.exports = PromptLibraryUI}