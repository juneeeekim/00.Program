class PromptCRUDUI{constructor(promptManager){if (!promptManager){throw new Error('PromptManager ì¸ìŠ¤í„´ìŠ¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.')}this.promptManager = promptManager;this.currentPromptId = null;this.autoSaveTimer = null;this.autoSaveInterval = 5000;this.hasUnsavedChanges = false;this.history = [];this.historyIndex = -1;this.maxHistorySize = 50;this.init()}init(){this.bindEvents();this.setupKeyboardShortcuts()}bindEvents(){this.bindCreateFormEvents();this.bindEditFormEvents();this.bindDeleteModalEvents()}bindCreateFormEvents(){const form = document.getElementById('prompt-form');const closeBtn = document.getElementById('close-create-form');const cancelBtn = document.getElementById('cancel-create-btn');if (form){form.addEventListener('submit', (e) => this.handleCreateSubmit(e));form.querySelectorAll('input, textarea, select').forEach((field) =>{field.addEventListener('input', () => this.validateField(field));field.addEventListener('blur', () => this.validateField(field))});this.setupCharCounter('prompt-title', 'title-counter', 100);this.setupCharCounter('prompt-description', 'description-counter', 500);this.setupCharCounter('prompt-content', 'content-counter', 10000);this.setupTagsPreview('prompt-tags', 'tags-preview')}if (closeBtn){closeBtn.addEventListener('click', () => this.closeCreateForm())}if (cancelBtn){cancelBtn.addEventListener('click', () => this.closeCreateForm())}}bindEditFormEvents(){const form = document.getElementById('prompt-edit-form-element');const closeBtn = document.getElementById('close-edit-form');const cancelBtn = document.getElementById('cancel-edit-btn');if (form){form.addEventListener('submit', (e) => this.handleEditSubmit(e));form.querySelectorAll('input, textarea, select').forEach((field) =>{field.addEventListener('input', () =>{this.validateField(field);this.hasUnsavedChanges = true;this.scheduleAutoSave()});field.addEventListener('blur', () => this.validateField(field))});this.setupCharCounter('edit-prompt-title', 'edit-title-counter', 100);this.setupCharCounter('edit-prompt-description', 'edit-description-counter', 500);this.setupCharCounter('edit-prompt-content', 'edit-content-counter', 10000);this.setupTagsPreview('edit-prompt-tags', 'edit-tags-preview')}if (closeBtn){closeBtn.addEventListener('click', () => this.closeEditForm())}if (cancelBtn){cancelBtn.addEventListener('click', () => this.closeEditForm())}}bindDeleteModalEvents(){const overlay = document.getElementById('delete-modal-overlay');const closeBtn = document.getElementById('close-delete-modal');const cancelBtn = document.getElementById('cancel-delete-btn');const confirmBtn = document.getElementById('confirm-delete-btn');if (closeBtn){closeBtn.addEventListener('click', () => this.closeDeleteModal())}if (cancelBtn){cancelBtn.addEventListener('click', () => this.closeDeleteModal())}if (confirmBtn){confirmBtn.addEventListener('click', () => this.handleDeleteConfirm())}if (overlay){overlay.addEventListener('click', (e) =>{if (e.target === overlay){this.closeDeleteModal()}});document.addEventListener('keydown', (e) =>{if (e.key === 'Escape' && overlay.style.display !== 'none'){this.closeDeleteModal()}})}}setupKeyboardShortcuts(){document.addEventListener('keydown', (e) =>{if (e.ctrlKey && e.key === 'z' && !e.shiftKey){e.preventDefault();this.undo()}if ((e.ctrlKey && e.key === 'y') || (e.ctrlKey && e.shiftKey && e.key === 'z')){e.preventDefault();this.redo()}})}setupCharCounter(inputId, counterId, maxLength){const input = document.getElementById(inputId);const counter = document.getElementById(counterId);if (!input || !counter) return;const updateCounter = () =>{const length = input.value.length;counter.textContent = `${length}/${maxLength}`;if (length >= maxLength * 0.9){counter.style.color = '#e74c3c'}else{counter.style.color = '#95a5a6'}};input.addEventListener('input', updateCounter);updateCounter()}setupTagsPreview(inputId, previewId){const input = document.getElementById(inputId);const preview = document.getElementById(previewId);if (!input || !preview) return;const updatePreview = () =>{const tags = input.value .split(',') .map((tag) => tag.trim()) .filter((tag) => tag.length > 0);preview.innerHTML = '';tags.forEach((tag, index) =>{const tagElement = document.createElement('span');tagElement.className = 'tag-item';tagElement.setAttribute('role', 'listitem');const tagText = document.createElement('span');tagText.textContent = tag;const removeBtn = document.createElement('button');removeBtn.className = 'tag-remove';removeBtn.textContent = 'Ã—';removeBtn.setAttribute('aria-label', `${tag}íƒœê·¸ ì œê±°`);removeBtn.addEventListener('click', () =>{const newTags = tags.filter((_, i) => i !== index);input.value = newTags.join(', ');updatePreview()});tagElement.appendChild(tagText);tagElement.appendChild(removeBtn);preview.appendChild(tagElement)})};input.addEventListener('input', updatePreview);input.addEventListener('blur', updatePreview)}validateField(field){const errorId = field.id.replace(/^(edit-)?prompt-/, '$1') + '-error';const errorElement = document.getElementById(errorId);if (!errorElement) return true;const errorMessage = this._getFieldValidationError(field);errorElement.textContent = errorMessage;if (errorMessage){field.setAttribute('aria-invalid', 'true');return false}field.removeAttribute('aria-invalid');return true}_getFieldValidationError(field){if (field.hasAttribute('required') && !field.value.trim()){return 'ì´ í•­ëª©ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.'}if (field.id.includes('title')){return this._validateTitleField(field)}if (field.id.includes('description')){return this._validateDescriptionField(field)}if (field.id.includes('content')){return this._validateContentField(field)}if (field.id.includes('tags')){return this._validateTagsField(field)}return ''}_validateTitleField(field){if (!field.value.trim()) return '';const trimmedValue = field.value.trim();if (trimmedValue.length < 1 || trimmedValue.length > 100){return 'ì œëª©ì€ 1-100ì ì‚¬ì´ì—¬ì•¼ í•©ë‹ˆë‹¤.'}return ''}_validateDescriptionField(field){if (field.value.length > 500){return 'ì„¤ëª…ì€ ìµœëŒ€ 500ìê¹Œì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤.'}return ''}_validateContentField(field){if (!field.value.trim()) return '';const trimmedValue = field.value.trim();if (trimmedValue.length < 1 || trimmedValue.length > 10000){return 'í…œí”Œë¦¿ ë‚´ìš©ì€ 1-10000ì ì‚¬ì´ì—¬ì•¼ í•©ë‹ˆë‹¤.'}return ''}_validateTagsField(field){if (!field.value.trim()) return '';const tags = field.value .split(',') .map((t) => t.trim()) .filter((t) => t);if (tags.length > 10){return 'íƒœê·¸ëŠ” ìµœëŒ€ 10ê°œê¹Œì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤.'}if (tags.some((tag) => tag.length > 20)){return 'ê° íƒœê·¸ëŠ” ìµœëŒ€ 20ìê¹Œì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤.'}return ''}openCreateForm(){const form = document.getElementById('prompt-create-form');if (form){form.style.display = 'block';form.scrollIntoView({behavior: 'smooth', block: 'start'});const firstInput = form.querySelector('input, textarea, select');if (firstInput){setTimeout(() => firstInput.focus(), 100)}}}closeCreateForm(){const form = document.getElementById('prompt-create-form');const formElement = document.getElementById('prompt-form');if (form){form.style.display = 'none'}if (formElement){formElement.reset();formElement.querySelectorAll('.error-message').forEach((el) => (el.textContent = ''));const preview = document.getElementById('tags-preview');if (preview) preview.innerHTML = ''}}async handleCreateSubmit(e){e.preventDefault();const form = e.target;const submitBtn = document.getElementById('submit-create-btn');let isValid = true;form.querySelectorAll('input[required], textarea[required], select[required]').forEach((field) =>{if (!this.validateField(field)){isValid = false}});if (!isValid){this.showNotification('ì…ë ¥ ë‚´ìš©ì„ í™•ì¸í•´ì£¼ì„¸ìš”.', 'error');return}submitBtn.classList.add('loading');submitBtn.disabled = true;try{const formData = new FormData(form);const tags = formData.get('tags') ? formData .get('tags') .split(',') .map((t) => t.trim()) .filter((t) => t) : [];const promptData ={title: formData.get('title'), description: formData.get('description') || '', category: formData.get('category'), tags: tags, content: formData.get('content'), isPublic: formData.get('isPublic') === 'on'};const promptId = await this.promptManager.createPrompt(promptData);this.showNotification('í”„ë¡¬í”„íŠ¸ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');this.closeCreateForm();document.dispatchEvent(new CustomEvent('promptCreated',{detail:{promptId}}))}catch (error){console.error('í”„ë¡¬í”„íŠ¸ ìƒì„± ì‹¤íŒ¨:', error);this.showNotification(error.message, 'error')}finally{submitBtn.classList.remove('loading');submitBtn.disabled = false}}async openEditForm(promptId){try{const form = document.getElementById('prompt-edit-form');if (!form) return;const prompt = await this.promptManager.getPromptById(promptId);document.getElementById('edit-prompt-id').value = prompt.id;document.getElementById('edit-prompt-title').value = prompt.title;document.getElementById('edit-prompt-description').value = prompt.description || '';document.getElementById('edit-prompt-category').value = prompt.category;document.getElementById('edit-prompt-tags').value = prompt.tags ? prompt.tags.join(', ') : '';document.getElementById('edit-prompt-content').value = prompt.currentVersion?.content || '';document.getElementById('edit-prompt-public').checked = prompt.isPublic || false;['edit-prompt-title', 'edit-prompt-description', 'edit-prompt-content'].forEach((id) =>{const input = document.getElementById(id);if (input){input.dispatchEvent(new Event('input'))}});const tagsInput = document.getElementById('edit-prompt-tags');if (tagsInput){tagsInput.dispatchEvent(new Event('input'))}this.currentPromptId = promptId;this.hasUnsavedChanges = false;form.style.display = 'block';form.scrollIntoView({behavior: 'smooth', block: 'start'});const firstInput = form.querySelector('input, textarea, select');if (firstInput){setTimeout(() => firstInput.focus(), 100)}this.history = [];this.historyIndex = -1;this.saveToHistory()}catch (error){console.error('í”„ë¡¬í”„íŠ¸ ë¡œë“œ ì‹¤íŒ¨:', error);this.showNotification(error.message, 'error')}}closeEditForm(){if (this.hasUnsavedChanges){if (!confirm('ì €ì¥í•˜ì§€ ì•Šì€ ë³€ê²½ì‚¬í•­ì´ ìˆìŠµë‹ˆë‹¤. ì •ë§ ë‹«ìœ¼ì‹œê² ìŠµë‹ˆê¹Œ?')){return}}const form = document.getElementById('prompt-edit-form');const formElement = document.getElementById('prompt-edit-form-element');if (form){form.style.display = 'none'}if (formElement){formElement.reset();formElement.querySelectorAll('.error-message').forEach((el) => (el.textContent = ''));const preview = document.getElementById('edit-tags-preview');if (preview) preview.innerHTML = ''}this.currentPromptId = null;this.hasUnsavedChanges = false;this.clearAutoSave()}async handleEditSubmit(e){e.preventDefault();const form = e.target;const submitBtn = document.getElementById('submit-edit-btn');let isValid = true;form.querySelectorAll('input[required], textarea[required], select[required]').forEach((field) =>{if (!this.validateField(field)){isValid = false}});if (!isValid){this.showNotification('ì…ë ¥ ë‚´ìš©ì„ í™•ì¸í•´ì£¼ì„¸ìš”.', 'error');return}submitBtn.classList.add('loading');submitBtn.disabled = true;try{const formData = new FormData(form);const promptId = formData.get('promptId');const tags = formData.get('tags') ? formData .get('tags') .split(',') .map((t) => t.trim()) .filter((t) => t) : [];const updates ={title: formData.get('title'), description: formData.get('description') || '', category: formData.get('category'), tags: tags, isPublic: formData.get('isPublic') === 'on'};await this.promptManager.updatePrompt(promptId, updates);this.showNotification('í”„ë¡¬í”„íŠ¸ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');this.hasUnsavedChanges = false;this.closeEditForm();document.dispatchEvent(new CustomEvent('promptUpdated',{detail:{promptId}}))}catch (error){console.error('í”„ë¡¬í”„íŠ¸ ìˆ˜ì • ì‹¤íŒ¨:', error);this.showNotification(error.message, 'error')}finally{submitBtn.classList.remove('loading');submitBtn.disabled = false}}scheduleAutoSave(){this.clearAutoSave();this.autoSaveTimer = setTimeout(() =>{this.performAutoSave()}, this.autoSaveInterval)}async performAutoSave(){if (!this.hasUnsavedChanges || !this.currentPromptId) return;const statusElement = document.getElementById('save-status');if (statusElement){statusElement.className = 'save-status saving';statusElement.innerHTML = '<span class="status-icon">â³</span><span class="status-text">ì €ì¥ ì¤‘...</span>'}try{const form = document.getElementById('prompt-edit-form-element');const formData = new FormData(form);const tags = formData.get('tags') ? formData .get('tags') .split(',') .map((t) => t.trim()) .filter((t) => t) : [];const updates ={title: formData.get('title'), description: formData.get('description') || '', category: formData.get('category'), tags: tags, isPublic: formData.get('isPublic') === 'on'};await this.promptManager.updatePrompt(this.currentPromptId, updates);this.hasUnsavedChanges = false;if (statusElement){statusElement.className = 'save-status';statusElement.innerHTML = '<span class="status-icon">ğŸ’¾</span><span class="status-text">ìë™ ì €ì¥ë¨</span>'}const timeElement = document.getElementById('save-time');if (timeElement){const now = new Date();timeElement.textContent = `${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')}`}}catch (error){console.error('ìë™ ì €ì¥ ì‹¤íŒ¨:', error);if (statusElement){statusElement.className = 'save-status error';statusElement.innerHTML = '<span class="status-icon">âŒ</span><span class="status-text">ì €ì¥ ì‹¤íŒ¨</span>'}}}clearAutoSave(){if (this.autoSaveTimer){clearTimeout(this.autoSaveTimer);this.autoSaveTimer = null}}async openDeleteModal(promptId){try{const prompt = await this.promptManager.getPromptById(promptId);document.getElementById('delete-prompt-title').textContent = prompt.title;document.getElementById('delete-version-count').textContent = `${prompt.versionCount || 0}ê°œ`;document.getElementById('delete-execution-count').textContent = `${prompt.executionCount || 0}íšŒ`;this.currentPromptId = promptId;this.previousFocus = document.activeElement;const overlay = document.getElementById('delete-modal-overlay');if (overlay){overlay.style.display = 'flex';overlay.setAttribute('aria-hidden', 'false');this.setupFocusTrap(overlay);const confirmBtn = document.getElementById('confirm-delete-btn');if (confirmBtn){setTimeout(() => confirmBtn.focus(), 100)}}}catch (error){console.error('í”„ë¡¬í”„íŠ¸ ë¡œë“œ ì‹¤íŒ¨:', error);this.showNotification(error.message, 'error')}}closeDeleteModal(){const overlay = document.getElementById('delete-modal-overlay');if (overlay){overlay.style.display = 'none';overlay.setAttribute('aria-hidden', 'true')}if (this.previousFocus){this.previousFocus.focus();this.previousFocus = null}this.currentPromptId = null}async handleDeleteConfirm(){const confirmBtn = document.getElementById('confirm-delete-btn');if (!this.currentPromptId) return;confirmBtn.classList.add('loading');confirmBtn.disabled = true;try{await this.promptManager.deletePrompt(this.currentPromptId);this.showNotification('í”„ë¡¬í”„íŠ¸ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤. 30ì¼ ë‚´ ë³µêµ¬ ê°€ëŠ¥í•©ë‹ˆë‹¤.', 'success');this.closeDeleteModal();document.dispatchEvent( new CustomEvent('promptDeleted',{detail:{promptId: this.currentPromptId}}) )}catch (error){console.error('í”„ë¡¬í”„íŠ¸ ì‚­ì œ ì‹¤íŒ¨:', error);this.showNotification(error.message, 'error')}finally{confirmBtn.classList.remove('loading');confirmBtn.disabled = false}}setupFocusTrap(container){const focusableElements = container.querySelectorAll( 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])' );const firstElement = focusableElements[0];const lastElement = focusableElements[focusableElements.length - 1];const handleTabKey = (e) =>{if (e.key !== 'Tab') return;if (e.shiftKey){if (document.activeElement === firstElement){e.preventDefault();lastElement.focus()}}else{if (document.activeElement === lastElement){e.preventDefault();firstElement.focus()}}};container.addEventListener('keydown', handleTabKey)}undo(){if (this.historyIndex <= 0){this.showNotification('ë” ì´ìƒ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'info');return}this.historyIndex--;this.restoreFromHistory();this.showNotification('ë˜ëŒë¦¬ê¸° ì™„ë£Œ', 'info')}redo(){if (this.historyIndex >= this.history.length - 1){this.showNotification('ë” ì´ìƒ ë‹¤ì‹œ ì‹¤í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'info');return}this.historyIndex++;this.restoreFromHistory();this.showNotification('ë‹¤ì‹œ ì‹¤í–‰ ì™„ë£Œ', 'info')}saveToHistory(){const form = document.getElementById('prompt-edit-form-element');if (!form) return;const formData = new FormData(form);const state ={title: formData.get('title'), description: formData.get('description'), category: formData.get('category'), tags: formData.get('tags'), content: formData.get('content'), isPublic: formData.get('isPublic') === 'on'};this.history = this.history.slice(0, this.historyIndex + 1);this.history.push(state);this.historyIndex++;if (this.history.length > this.maxHistorySize){this.history.shift();this.historyIndex--}}restoreFromHistory(){const state = this.history[this.historyIndex];if (!state) return;document.getElementById('edit-prompt-title').value = state.title || '';document.getElementById('edit-prompt-description').value = state.description || '';document.getElementById('edit-prompt-category').value = state.category || '';document.getElementById('edit-prompt-tags').value = state.tags || '';document.getElementById('edit-prompt-content').value = state.content || '';document.getElementById('edit-prompt-public').checked = state.isPublic || false;['edit-prompt-title', 'edit-prompt-description', 'edit-prompt-content'].forEach((id) =>{const input = document.getElementById(id);if (input){input.dispatchEvent(new Event('input'))}})}showNotification(message, type = 'info'){const notification = document.createElement('div');notification.className = `notification notification-${type}`;notification.textContent = message;notification.setAttribute('role', 'alert');notification.setAttribute('aria-live', 'polite');Object.assign(notification.style,{position: 'fixed', top: '20px', right: '20px', padding: '16px 24px', borderRadius: '8px', backgroundColor: type === 'error' ? '#e74c3c' : type === 'success' ? '#27ae60' : '#3498db', color: '#ffffff', fontWeight: '600', boxShadow: '0 4px 12px rgba(0, 0, 0, 0.2)', zIndex: '10000', animation: 'slideInRight 0.3s ease-out'});document.body.appendChild(notification);setTimeout(() =>{notification.style.animation = 'slideOutRight 0.3s ease-out';setTimeout(() =>{document.body.removeChild(notification)}, 300)}, 3000)}}if (typeof module !== 'undefined' && module.exports){module.exports = PromptCRUDUI}