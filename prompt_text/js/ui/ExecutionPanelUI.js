import performanceOptimizer from '../utils/PerformanceOptimizer.js';class ExecutionPanelUI{constructor(executionManager, templateEngine){if (!executionManager){throw new Error('ExecutionManager ì¸ìŠ¤í„´ìŠ¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.')}this.executionManager = executionManager;this.templateEngine = templateEngine;this.currentPromptId = null;this.currentVersionId = null;this.currentTemplate = '';this.variables = [];this.variableValues ={};this.performanceOptimizer = performanceOptimizer;this.debouncedUpdatePreview = this.performanceOptimizer.debounce( () => this.updatePreview(), 200, 'executionPanelPreview' );this.init()}init(){this.bindEvents()}bindEvents(){const llmSelect = document.getElementById('llm-model-select');if (llmSelect){llmSelect.addEventListener('change', () => this.validateExecuteButton())}const executeBtn = document.getElementById('execute-prompt-btn');if (executeBtn){executeBtn.addEventListener('click', () => this.handleExecute())}const resetBtn = document.getElementById('reset-execution-btn');if (resetBtn){resetBtn.addEventListener('click', () => this.resetInputs())}const closeGuideBtn = document.getElementById('close-guide-modal');const cancelBtn = document.getElementById('cancel-execution-btn');if (closeGuideBtn){closeGuideBtn.addEventListener('click', () => this.closeGuideModal())}if (cancelBtn){cancelBtn.addEventListener('click', () => this.closeGuideModal())}const saveBtn = document.getElementById('save-execution-btn');if (saveBtn){saveBtn.addEventListener('click', () => this.handleSaveResult())}this.setupCharCounter('execution-result', 'result-counter', 10000)}loadPrompt(promptId, versionId, template){this.currentPromptId = promptId;this.currentVersionId = versionId;this.currentTemplate = template;this.extractVariables(template);this.renderVariableInputs();this.updateTemplateLength();this.updatePreview()}extractVariables(template){if (this.templateEngine){this.variables = this.templateEngine.extractVariables(template)}else{const regex = /\{\{([^}]+)\}\}/g;const matches = [...template.matchAll(regex)];this.variables = [...new Set(matches.map((m) => m[1].trim()))]}const countEl = document.getElementById('variables-count');if (countEl){countEl.textContent = `${this.variables.length}ê°œ ë³€ìˆ˜`}}renderVariableInputs(){const container = document.getElementById('variables-container');if (!container) return;container.innerHTML = '';if (this.variables.length === 0){container.innerHTML = ` <div class="no-variables"> <span class="no-variables-icon">ğŸ“</span> <p class="no-variables-text">í…œí”Œë¦¿ì— ë³€ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤</p> </div> `;return}this.variables.forEach((variable, index) =>{const inputGroup = document.createElement('div');inputGroup.className = 'variable-input-group';const label = document.createElement('label');label.className = 'variable-label';label.htmlFor = `variable-${index}`;label.innerHTML = ` <span>ğŸ”¤ ${variable}</span> <span class="variable-required">*</span> `;const input = document.createElement('input');input.type = 'text';input.id = `variable-${index}`;input.className = 'variable-input';input.placeholder = `${variable}ê°’ì„ ì…ë ¥í•˜ì„¸ìš”`;input.required = true;input.setAttribute('aria-label', `${variable}ë³€ìˆ˜ ì…ë ¥`);input.setAttribute('data-variable', variable);input.addEventListener('input', (e) =>{this.variableValues[variable] = e.target.value;this.debouncedUpdatePreview();this.validateExecuteButton()});inputGroup.appendChild(label);inputGroup.appendChild(input);container.appendChild(inputGroup)})}updatePreview(){const previewEl = document.getElementById('preview-content');if (!previewEl) return;const allFilled = this.variables.every((v) => this.variableValues[v]);if (!allFilled && this.variables.length > 0){previewEl.innerHTML = ` <div class="preview-placeholder"> <span class="placeholder-icon">ğŸ“„</span> <p class="placeholder-text">ë³€ìˆ˜ë¥¼ ì…ë ¥í•˜ë©´ ë¯¸ë¦¬ë³´ê¸°ê°€ í‘œì‹œë©ë‹ˆë‹¤</p> </div> `;this.updateRenderedLength(0);return}let rendered;if (this.templateEngine){rendered = this.templateEngine.render(this.currentTemplate, this.variableValues)}else{rendered = this.currentTemplate;for (const [key, value] of Object.entries(this.variableValues)){rendered = rendered.replace(new RegExp(`\\{\\{${key}\\}\\}`, 'g'), value)}}previewEl.textContent = rendered;this.updateRenderedLength(rendered.length);this.updatePreviewInfo(rendered)}updateTemplateLength(){const lengthEl = document.getElementById('template-length');if (lengthEl){lengthEl.textContent = `${this.currentTemplate.length.toLocaleString()}ì`}}updateRenderedLength(length){const lengthEl = document.getElementById('rendered-length');if (lengthEl){lengthEl.textContent = `${length.toLocaleString()}ì`}}updatePreviewInfo(text){const wordCount = text.trim().split(/\s+/).length;const wordCountEl = document.getElementById('preview-word-count');if (wordCountEl){wordCountEl.textContent = `${wordCount.toLocaleString()}ë‹¨ì–´`}const lineCount = text.split('\n').length;const lineCountEl = document.getElementById('preview-line-count');if (lineCountEl){lineCountEl.textContent = `${lineCount.toLocaleString()}ì¤„`}}validateExecuteButton(){const executeBtn = document.getElementById('execute-prompt-btn');const llmSelect = document.getElementById('llm-model-select');const llmError = document.getElementById('llm-model-error');if (!executeBtn || !llmSelect) return;const llmSelected = llmSelect.value !== '';if (!llmSelected){if (llmError){llmError.textContent = 'LLM ëª¨ë¸ì„ ì„ íƒí•´ì£¼ì„¸ìš”.'}llmSelect.setAttribute('aria-invalid', 'true')}else{if (llmError){llmError.textContent = ''}llmSelect.setAttribute('aria-invalid', 'false')}const allVariablesFilled = this.variables.every((v) => this.variableValues[v]);executeBtn.disabled = !(llmSelected && (this.variables.length === 0 || allVariablesFilled))}async handleExecute(){try{const llmSelect = document.getElementById('llm-model-select');const executeBtn = document.getElementById('execute-prompt-btn');const llmError = document.getElementById('llm-model-error');if (!llmSelect || !executeBtn) return;const llmModel = llmSelect.value;if (!llmModel){if (llmError){llmError.textContent = 'LLM ëª¨ë¸ì„ ì„ íƒí•´ì£¼ì„¸ìš”.'}llmSelect.setAttribute('aria-invalid', 'true');llmSelect.focus();this.showNotification('LLM ëª¨ë¸ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');return}else{if (llmError){llmError.textContent = ''}llmSelect.setAttribute('aria-invalid', 'false')}executeBtn.classList.add('loading');executeBtn.disabled = true;let rendered;if (this.templateEngine){rendered = this.templateEngine.render(this.currentTemplate, this.variableValues)}else{rendered = this.currentTemplate;for (const [key, value] of Object.entries(this.variableValues)){rendered = rendered.replace(new RegExp(`\\{\\{${key}\\}\\}`, 'g'), value)}}await this.copyToClipboard(rendered);this.openLLMSite(llmModel);this.showGuideModal();this.showNotification('í”„ë¡¬í”„íŠ¸ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success')}catch (error){console.error('âŒ í”„ë¡¬í”„íŠ¸ ì‹¤í–‰ ì‹¤íŒ¨:', error);this.showNotification(error.message, 'error')}finally{const executeBtn = document.getElementById('execute-prompt-btn');if (executeBtn){executeBtn.classList.remove('loading');executeBtn.disabled = false}}}async copyToClipboard(text){try{if (navigator.clipboard && navigator.clipboard.writeText){await navigator.clipboard.writeText(text)}else{const textarea = document.createElement('textarea');textarea.value = text;textarea.style.position = 'fixed';textarea.style.opacity = '0';document.body.appendChild(textarea);textarea.select();document.execCommand('copy');document.body.removeChild(textarea)}}catch (error){throw new Error('í´ë¦½ë³´ë“œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.')}}openLLMSite(llmModel){const urls ={chatgpt: 'https: gemini: 'https: claude: 'https: perplexity: 'https: grok: 'https:};const url = urls[llmModel];if (url){window.open(url, '_blank')}}showGuideModal(){this.previousFocus = document.activeElement;const modal = document.getElementById('execution-guide-modal');if (modal){modal.style.display = 'flex';modal.setAttribute('aria-hidden', 'false');this.setupFocusTrap(modal);const resultInput = document.getElementById('execution-result');if (resultInput){setTimeout(() => resultInput.focus(), 100)}}}closeGuideModal(){const modal = document.getElementById('execution-guide-modal');if (modal){modal.style.display = 'none';modal.setAttribute('aria-hidden', 'true')}if (this.previousFocus){this.previousFocus.focus();this.previousFocus = null}const resultInput = document.getElementById('execution-result');if (resultInput){resultInput.value = ''}}async handleSaveResult(){try{const resultInput = document.getElementById('execution-result');const saveBtn = document.getElementById('save-execution-btn');const llmSelect = document.getElementById('llm-model-select');if (!resultInput || !saveBtn || !llmSelect) return;const result = resultInput.value.trim();if (!result){this.showNotification('LLM ì‘ë‹µ ê²°ê³¼ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');return}saveBtn.classList.add('loading');saveBtn.disabled = true;let rendered;if (this.templateEngine){rendered = this.templateEngine.render(this.currentTemplate, this.variableValues)}else{rendered = this.currentTemplate;for (const [key, value] of Object.entries(this.variableValues)){rendered = rendered.replace(new RegExp(`\\{\\{${key}\\}\\}`, 'g'), value)}}const executionId = await this.executionManager.saveExecution({promptId: this.currentPromptId, versionId: this.currentVersionId, input:{template: this.currentTemplate, variables: this.variableValues, rendered: rendered}, output: result, llmModel: llmSelect.value, executionMode: 'manual'});this.showNotification('ì‹¤í–‰ ê²°ê³¼ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');this.closeGuideModal();document.dispatchEvent( new CustomEvent('executionSaved',{detail:{executionId: executionId, promptId: this.currentPromptId}}) )}catch (error){console.error('âŒ ê²°ê³¼ ì €ì¥ ì‹¤íŒ¨:', error);this.showNotification(error.message, 'error')}finally{const saveBtn = document.getElementById('save-execution-btn');if (saveBtn){saveBtn.classList.remove('loading');saveBtn.disabled = false}}}resetInputs(){this.variableValues ={};document.querySelectorAll('.variable-input').forEach((input) =>{input.value = ''});const llmSelect = document.getElementById('llm-model-select');if (llmSelect){llmSelect.value = ''}this.updatePreview();this.validateExecuteButton();this.showNotification('ì…ë ¥ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info')}setupCharCounter(inputId, counterId, maxLength){const input = document.getElementById(inputId);const counter = document.getElementById(counterId);if (!input || !counter) return;const updateCounter = () =>{const length = input.value.length;counter.textContent = `${length.toLocaleString()}ì`};input.addEventListener('input', updateCounter);updateCounter()}setupFocusTrap(container){const focusableElements = container.querySelectorAll( 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])' );const firstElement = focusableElements[0];const lastElement = focusableElements[focusableElements.length - 1];const handleTabKey = (e) =>{if (e.key !== 'Tab') return;if (e.shiftKey){if (document.activeElement === firstElement){e.preventDefault();lastElement.focus()}}else{if (document.activeElement === lastElement){e.preventDefault();firstElement.focus()}}};container.addEventListener('keydown', handleTabKey)}showNotification(message, type = 'info'){const notification = document.createElement('div');notification.className = `notification notification-${type}`;notification.textContent = message;notification.setAttribute('role', 'alert');notification.setAttribute('aria-live', 'polite');Object.assign(notification.style,{position: 'fixed', top: '20px', right: '20px', padding: '16px 24px', borderRadius: '8px', backgroundColor: type === 'error' ? '#e74c3c' : type === 'success' ? '#27ae60' : '#3498db', color: '#ffffff', fontWeight: '600', boxShadow: '0 4px 12px rgba(0, 0, 0, 0.2)', zIndex: '10000', animation: 'slideInRight 0.3s ease-out'});document.body.appendChild(notification);setTimeout(() =>{notification.style.animation = 'slideOutRight 0.3s ease-out';setTimeout(() =>{document.body.removeChild(notification)}, 300)}, 3000)}}if (typeof module !== 'undefined' && module.exports){module.exports = ExecutionPanelUI}