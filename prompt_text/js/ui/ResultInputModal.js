class ResultInputModal{constructor(){this.isOpen = false;this.resolvePromise = null;this.rejectPromise = null;this.focusableElements = [];this.previousFocus = null;this.init()}init(){this.bindEvents()}bindEvents(){const closeBtn = document.getElementById('result-modal-close');const cancelBtn = document.getElementById('result-modal-cancel');if (closeBtn){closeBtn.addEventListener('click', () => this.cancel())}if (cancelBtn){cancelBtn.addEventListener('click', () => this.cancel())}const submitBtn = document.getElementById('result-modal-submit');if (submitBtn){submitBtn.addEventListener('click', () => this.submit())}const overlay = document.getElementById('result-input-modal-overlay');if (overlay){overlay.addEventListener('click', (e) =>{if (e.target === overlay){this.cancel()}})}document.addEventListener('keydown', (e) =>{if (e.key === 'Escape' && this.isOpen){this.cancel()}});this.setupCharCounter('result-text-input', 'result-counter', 5000);this.setupCharCounter('result-notes-input', 'notes-counter', 1000)}open(options ={}){return new Promise((resolve, reject) =>{this.resolvePromise = resolve;this.rejectPromise = reject;const titleEl = document.getElementById('result-prompt-title');const versionEl = document.getElementById('result-prompt-version');if (titleEl) titleEl.textContent = options.promptTitle || '-';if (versionEl) versionEl.textContent = options.promptVersion || '-';const overlay = document.getElementById('result-input-modal-overlay');if (overlay){overlay.style.display = 'flex';overlay.setAttribute('aria-hidden', 'false')}this.isOpen = true;this.previousFocus = document.activeElement;this.setupFocusTrap();const firstInput = document.getElementById('result-text-input');if (firstInput){setTimeout(() => firstInput.focus(), 100)}})}close(){const overlay = document.getElementById('result-input-modal-overlay');if (overlay){overlay.style.display = 'none';overlay.setAttribute('aria-hidden', 'true')}this.isOpen = false;const form = document.getElementById('result-input-form');if (form){form.reset();const errorEl = document.getElementById('result-error');if (errorEl) errorEl.textContent = ''}if (this.previousFocus){this.previousFocus.focus();this.previousFocus = null}}cancel(){this.close();if (this.rejectPromise){this.rejectPromise(new Error('사용자가 취소했습니다.'));this.rejectPromise = null;this.resolvePromise = null}}async submit(){const form = document.getElementById('result-input-form');const submitBtn = document.getElementById('result-modal-submit');if (!this.validateForm(form)){return}if (submitBtn){submitBtn.classList.add('loading');submitBtn.disabled = true}try{const formData = new FormData(form);const result ={resultText: formData.get('resultText'), rating: parseInt(formData.get('rating')) || 3, notes: formData.get('notes') || '', timestamp: new Date()};if (this.resolvePromise){this.resolvePromise(result);this.resolvePromise = null;this.rejectPromise = null}this.close()}catch (error){console.error('❌ 결과 저장 실패:', error);if (this.rejectPromise){this.rejectPromise(error);this.rejectPromise = null;this.resolvePromise = null}}finally{if (submitBtn){submitBtn.classList.remove('loading');submitBtn.disabled = false}}}validateForm(form){const resultText = form.querySelector('#result-text-input');const errorEl = document.getElementById('result-error');if (!resultText.value.trim()){errorEl.textContent = '실행 결과를 입력해주세요.';resultText.setAttribute('aria-invalid', 'true');resultText.focus();return false}if (resultText.value.trim().length < 10){errorEl.textContent = '실행 결과는 최소 10자 이상이어야 합니다.';resultText.setAttribute('aria-invalid', 'true');resultText.focus();return false}errorEl.textContent = '';resultText.removeAttribute('aria-invalid');return true}setupCharCounter(inputId, counterId, maxLength){const input = document.getElementById(inputId);const counter = document.getElementById(counterId);if (!input || !counter) return;const updateCounter = () =>{const length = input.value.length;counter.textContent = `${length}/${maxLength}`;if (length >= maxLength * 0.9){counter.style.color = '#e74c3c'}else{counter.style.color = '#95a5a6'}};input.addEventListener('input', updateCounter);updateCounter()}setupFocusTrap(){const modal = document.querySelector('.result-modal-dialog');if (!modal) return;this.focusableElements = Array.from( modal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])') );if (this.focusableElements.length === 0) return;const firstElement = this.focusableElements[0];const lastElement = this.focusableElements[this.focusableElements.length - 1];const handleTabKey = (e) =>{if (!this.isOpen || e.key !== 'Tab') return;if (e.shiftKey){if (document.activeElement === firstElement){e.preventDefault();lastElement.focus()}}else{if (document.activeElement === lastElement){e.preventDefault();firstElement.focus()}}};document.addEventListener('keydown', handleTabKey);this.cleanupFocusTrap = () =>{document.removeEventListener('keydown', handleTabKey)}}cleanup(){if (this.cleanupFocusTrap){this.cleanupFocusTrap()}this.close()}}if (typeof module !== 'undefined' && module.exports){module.exports = ResultInputModal}