class RollbackModalUI{constructor(versionManager){if (!versionManager){throw new Error('VersionManager 인스턴스가 필요합니다.')}this.versionManager = versionManager;this.modal = null;this.isOpen = false;this.resolveCallback = null;this.rejectCallback = null;this.previousFocus = null;this.focusTrapHandler = null;this.init()}init(){this.createModal();this.initEventListeners()}createModal(){const modalHTML = ` <div class="rollback-modal" id="rollback-modal" role="dialog" aria-labelledby="rollback-modal-title" aria-modal="true" style="display: none;"> <div class="rollback-modal-overlay"></div> <div class="rollback-modal-content"> <div class="rollback-modal-header"> <h3 id="rollback-modal-title">⚠️ 버전 롤백 확인</h3> <button class="rollback-modal-close" aria-label="닫기">✕</button> </div> <div class="rollback-modal-body"> <div class="rollback-warning"> <span class="warning-icon">⚠️</span> <p>이 작업은 새로운 버전을 생성하여 이전 상태로 복원합니다.</p> </div> <div class="rollback-info"> <h4>롤백 정보</h4> <div class="info-grid"> <div class="info-item"> <span class="info-label">현재 버전:</span> <span class="info-value" id="current-version-text">-</span> </div> <div class="info-item"> <span class="info-label">롤백 대상:</span> <span class="info-value" id="target-version-text">-</span> </div> </div> </div> <div class="rollback-impact" id="rollback-impact"> <h4>예상 영향</h4> <ul id="impact-list"></ul> </div> <div class="rollback-reason"> <label for="rollback-reason-input"> 롤백 사유 (선택) </label> <textarea id="rollback-reason-input" placeholder="롤백하는 이유를 입력하세요..." rows="3" maxlength="500" ></textarea> <div class="char-count"> <span id="reason-char-count">0</span> / 500 </div> </div> </div> <div class="rollback-modal-footer"> <button class="btn-cancel" id="rollback-cancel-btn"> 취소 </button> <button class="btn-confirm" id="rollback-confirm-btn"> 롤백 실행 </button> </div> <div class="rollback-loading" id="rollback-loading" style="display: none;"> <div class="spinner"></div> <p>롤백 중...</p> </div> </div> </div> `;const container = document.createElement('div');container.innerHTML = modalHTML;document.body.appendChild(container.firstElementChild);this.modal = document.getElementById('rollback-modal');this.addStyles()}initEventListeners(){const closeBtn = this.modal.querySelector('.rollback-modal-close');if (closeBtn){closeBtn.addEventListener('click', () => this.close(false))}const cancelBtn = document.getElementById('rollback-cancel-btn');if (cancelBtn){cancelBtn.addEventListener('click', () => this.close(false))}const confirmBtn = document.getElementById('rollback-confirm-btn');if (confirmBtn){confirmBtn.addEventListener('click', () => this.confirm())}const overlay = this.modal.querySelector('.rollback-modal-overlay');if (overlay){overlay.addEventListener('click', () => this.close(false))}document.addEventListener('keydown', (e) =>{if (e.key === 'Escape' && this.isOpen){this.close(false)}});const reasonInput = document.getElementById('rollback-reason-input');const charCount = document.getElementById('reason-char-count');if (reasonInput && charCount){reasonInput.addEventListener('input', () =>{charCount.textContent = reasonInput.value.length})}}async open(promptId, targetVersionId, versionInfo){try{const checkResult = await this.versionManager.canRollback(promptId, targetVersionId);if (!checkResult.canRollback){alert(checkResult.reason);return Promise.reject(new Error(checkResult.reason))}this.displayInfo(versionInfo, checkResult.impact);this.previousFocus = document.activeElement;this.modal.style.display = 'flex';this.isOpen = true;const modalDialog = this.modal.querySelector('.rollback-modal-content');if (modalDialog){const focusableElements = modalDialog.querySelectorAll( 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])' );if (focusableElements.length > 0){const firstElement = focusableElements[0];const lastElement = focusableElements[focusableElements.length - 1];this.focusTrapHandler = (e) =>{if (e.key !== 'Tab') return;if (e.shiftKey){if (document.activeElement === firstElement){e.preventDefault();lastElement.focus()}}else{if (document.activeElement === lastElement){e.preventDefault();firstElement.focus()}}};modalDialog.addEventListener('keydown', this.focusTrapHandler)}}const reasonInput = document.getElementById('rollback-reason-input');if (reasonInput){setTimeout(() => reasonInput.focus(), 100)}return new Promise((resolve, reject) =>{this.resolveCallback = resolve;this.rejectCallback = reject})}catch (error){console.error('❌ 모달 열기 실패:', error);return Promise.reject(error)}}displayInfo(versionInfo, impact){const currentVersionText = document.getElementById('current-version-text');if (currentVersionText){currentVersionText.textContent = impact.currentVersion}const targetVersionText = document.getElementById('target-version-text');if (targetVersionText){targetVersionText.textContent = impact.targetVersion}const impactList = document.getElementById('impact-list');if (impactList){const impacts = [];if (impact.contentChanged){impacts.push('템플릿 내용이 변경됩니다.')}if (impact.variablesChanged){impacts.push('변수 정의가 변경됩니다.')}impacts.push(`새로운 버전이 생성됩니다. (총 ${impact.versionCount + 1}개)`);impacts.push('이전 버전들은 유지됩니다.');impactList.innerHTML = impacts.map((text) => `<li>${text}</li>`).join('')}}async confirm(){try{const reasonInput = document.getElementById('rollback-reason-input');const reason = reasonInput ? reasonInput.value.trim() : '';this.showLoading();if (this.resolveCallback){this.resolveCallback({confirmed: true, reason: reason})}this.close(true)}catch (error){console.error('❌ 확인 실패:', error);this.hideLoading();alert('오류가 발생했습니다: ' + error.message)}}close(confirmed){if (!confirmed && this.resolveCallback){this.resolveCallback({confirmed: false, reason: ''})}this.modal.style.display = 'none';this.isOpen = false;const reasonInput = document.getElementById('rollback-reason-input');if (reasonInput){reasonInput.value = ''}const charCount = document.getElementById('reason-char-count');if (charCount){charCount.textContent = '0'}if (this.focusTrapHandler){const modalDialog = this.modal.querySelector('.rollback-modal-content');if (modalDialog){modalDialog.removeEventListener('keydown', this.focusTrapHandler)}this.focusTrapHandler = null}if (this.previousFocus){this.previousFocus.focus();this.previousFocus = null}this.hideLoading()}showLoading(){const loadingElement = document.getElementById('rollback-loading');if (loadingElement){loadingElement.style.display = 'flex'}const confirmBtn = document.getElementById('rollback-confirm-btn');if (confirmBtn){confirmBtn.disabled = true}}hideLoading(){const loadingElement = document.getElementById('rollback-loading');if (loadingElement){loadingElement.style.display = 'none'}const confirmBtn = document.getElementById('rollback-confirm-btn');if (confirmBtn){confirmBtn.disabled = false}}addStyles(){if (document.getElementById('rollback-modal-styles')){return}const style = document.createElement('style');style.id = 'rollback-modal-styles';style.textContent = ` .rollback-modal{position: fixed;top: 0;left: 0;width: 100%;height: 100%;z-index: 10000;display: flex;align-items: center;justify-content: center}.rollback-modal-overlay{position: absolute;top: 0;left: 0;width: 100%;height: 100%;background: rgba(0, 0, 0, 0.5);backdrop-filter: blur(4px)}.rollback-modal-content{position: relative;background: white;border-radius: 12px;box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);max-width: 600px;width: 90%;max-height: 90vh;overflow-y: auto;animation: modalSlideIn 0.3s ease-out}@keyframes modalSlideIn{from{opacity: 0;transform: translateY(-20px)}to{opacity: 1;transform: translateY(0)}}.rollback-modal-header{display: flex;justify-content: space-between;align-items: center;padding: 24px;border-bottom: 2px solid #e1e8ed}.rollback-modal-header h3{font-size: 20px;font-weight: 700;color: #e74c3c;margin: 0}.rollback-modal-close{width: 32px;height: 32px;border: none;background: transparent;font-size: 24px;color: #7f8c8d;cursor: pointer;border-radius: 6px;transition: all 0.3s ease}.rollback-modal-close:hover{background: #f8f9fa;color: #2c3e50}.rollback-modal-body{padding: 24px}.rollback-warning{display: flex;gap: 12px;padding: 16px;background: #fff3cd;border-left: 4px solid #ffc107;border-radius: 8px;margin-bottom: 24px}.warning-icon{font-size: 24px}.rollback-warning p{margin: 0;color: #856404;font-weight: 500}.rollback-info, .rollback-impact{margin-bottom: 24px}.rollback-info h4, .rollback-impact h4{font-size: 16px;font-weight: 600;color: #2c3e50;margin-bottom: 12px}.info-grid{display: grid;gap: 12px}.info-item{display: flex;justify-content: space-between;padding: 12px;background: #f8f9fa;border-radius: 6px}.info-label{font-weight: 600;color: #7f8c8d}.info-value{font-weight: 600;color: #2c3e50}.rollback-impact ul{margin: 0;padding-left: 20px}.rollback-impact li{margin-bottom: 8px;color: #2c3e50}.rollback-reason label{display: block;font-weight: 600;color: #2c3e50;margin-bottom: 8px}.rollback-reason textarea{width: 100%;padding: 12px;border: 2px solid #e1e8ed;border-radius: 8px;font-family: inherit;font-size: 14px;resize: vertical;transition: border-color 0.3s ease}.rollback-reason textarea:focus{outline: none;border-color: #667eea}.char-count{text-align: right;font-size: 12px;color: #7f8c8d;margin-top: 4px}.rollback-modal-footer{display: flex;justify-content: flex-end;gap: 12px;padding: 24px;border-top: 2px solid #e1e8ed}.btn-cancel, .btn-confirm{padding: 12px 24px;border: none;border-radius: 8px;font-size: 14px;font-weight: 600;cursor: pointer;transition: all 0.3s ease}.btn-cancel{background: #e1e8ed;color: #2c3e50}.btn-cancel:hover{background: #d1d8dd}.btn-confirm{background: #e74c3c;color: white}.btn-confirm:hover{background: #c0392b}.btn-confirm:disabled{background: #e1e8ed;color: #95a5a6;cursor: not-allowed}.rollback-loading{position: absolute;top: 0;left: 0;width: 100%;height: 100%;background: rgba(255, 255, 255, 0.95);display: flex;flex-direction: column;align-items: center;justify-content: center;gap: 16px;border-radius: 12px}.rollback-loading .spinner{width: 50px;height: 50px;border: 5px solid #e1e8ed;border-top-color: #667eea;border-radius: 50%;animation: spin 1s linear infinite}@keyframes spin{to{transform: rotate(360deg)}}.rollback-loading p{font-size: 16px;font-weight: 600;color: #2c3e50}`;document.head.appendChild(style)}cleanup(){if (this.modal && this.modal.parentNode){this.modal.parentNode.removeChild(this.modal)}const styles = document.getElementById('rollback-modal-styles');if (styles && styles.parentNode){styles.parentNode.removeChild(styles)}}}if (typeof module !== 'undefined' && module.exports){module.exports = RollbackModalUI}