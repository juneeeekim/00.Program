import performanceOptimizer from '../utils/PerformanceOptimizer.js';class RatingHistoryUI{constructor(executionManager, container){if (!executionManager || !container){throw new Error('ExecutionManagerì™€ containerê°€ í•„ìš”í•©ë‹ˆë‹¤.')}this.executionManager = executionManager;this.container = container;this.histories = [];this.filteredHistories = [];this.currentPage = 1;this.itemsPerPage = 10;this.totalPages = 0;this.isLoading = false;this.filters ={rating: '', dateRange: '', searchQuery: ''};this.performanceOptimizer = performanceOptimizer;this.renderCache = new Map();this.debouncedSearch = this.performanceOptimizer.debounce( (query) => this.handleSearch(query), 300, 'ratingHistorySearch' );this.init()}init(){this.render();this.addStyles()}async load(promptId = null){try{this.showLoading();const result = await this.executionManager.getExecutionHistories({promptId: promptId, limit: 100});this.histories = result.histories || [];this.applyFilters();this.renderHistoryList()}catch (error){console.error('âŒ íˆìŠ¤í† ë¦¬ ë¡œë“œ ì‹¤íŒ¨:', error);this.showError(error.message)}finally{this.hideLoading()}}render(){this.container.innerHTML = ` <div class="rating-history"> <!-- í—¤ë” --> <div class="history-header"> <h3>í‰ê°€ íˆìŠ¤í† ë¦¬</h3> <div class="history-actions"> <button id="refresh-history" class="btn-icon" title="ìƒˆë¡œê³ ì¹¨"> ğŸ”„ </button> </div> </div> <!-- í•„í„° ë° ê²€ìƒ‰ --> <div class="history-filters"> <div class="filter-group"> <label for="rating-filter">í‰ì  í•„í„°</label> <select id="rating-filter"> <option value="">ëª¨ë“  í‰ì </option> <option value="5">â­â­â­â­â­ (5ì )</option> <option value="4">â­â­â­â­ (4ì )</option> <option value="3">â­â­â­ (3ì )</option> <option value="2">â­â­ (2ì )</option> <option value="1">â­ (1ì )</option> </select> </div> <div class="filter-group"> <label for="date-filter">ê¸°ê°„ í•„í„°</label> <select id="date-filter"> <option value="">ì „ì²´ ê¸°ê°„</option> <option value="today">ì˜¤ëŠ˜</option> <option value="week">ì´ë²ˆ ì£¼</option> <option value="month">ì´ë²ˆ ë‹¬</option> <option value="quarter">3ê°œì›”</option> </select> </div> <div class="filter-group search-group"> <label for="search-input">ê²€ìƒ‰</label> <div class="search-container"> <input type="text" id="search-input" placeholder="ê²°ê³¼ ë‚´ìš© ë˜ëŠ” ë©”ëª¨ ê²€ìƒ‰..." maxlength="100" > <button id="clear-search" class="btn-clear" title="ê²€ìƒ‰ ì§€ìš°ê¸°"> âœ• </button> </div> </div> </div> <!-- íˆìŠ¤í† ë¦¬ ëª©ë¡ --> <div class="history-content"> <div id="history-list" class="history-list"></div> <!-- í˜ì´ì§€ë„¤ì´ì…˜ --> <div id="history-pagination" class="history-pagination"></div> </div> <!-- ë¡œë”© --> <div id="history-loading" class="history-loading" style="display: none;" role="status" aria-live="polite" aria-atomic="true"> <div class="spinner" aria-hidden="true"></div> <p>íˆìŠ¤í† ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p> </div> <!-- ë¹ˆ ìƒíƒœ --> <div id="history-empty" class="history-empty" style="display: none;"> <div class="empty-icon">ğŸ“‹</div> <h4>í‰ê°€ íˆìŠ¤í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤</h4> <p>í”„ë¡¬í”„íŠ¸ë¥¼ ì‹¤í–‰í•˜ê³  í‰ê°€í•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p> </div> <!-- ì—ëŸ¬ --> <div id="history-error" class="history-error" style="display: none;"> <div class="error-icon">âš ï¸</div> <h4>íˆìŠ¤í† ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h4> <p id="error-message">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p> </div> </div> `;this.initEventListeners()}initEventListeners(){const refreshBtn = document.getElementById('refresh-history');if (refreshBtn){refreshBtn.addEventListener('click', () => this.load())}const ratingFilter = document.getElementById('rating-filter');if (ratingFilter){ratingFilter.addEventListener('change', (e) =>{this.filters.rating = e.target.value;this.applyFilters();this.renderHistoryList()})}const dateFilter = document.getElementById('date-filter');if (dateFilter){dateFilter.addEventListener('change', (e) =>{this.filters.dateRange = e.target.value;this.applyFilters();this.renderHistoryList()})}const searchInput = document.getElementById('search-input');if (searchInput){searchInput.addEventListener('input', (e) =>{clearTimeout(this.searchTimeout);this.searchTimeout = setTimeout(() =>{this.filters.searchQuery = e.target.value.trim();this.applyFilters();this.renderHistoryList()}, 300)})}const clearSearch = document.getElementById('clear-search');if (clearSearch){clearSearch.addEventListener('click', () =>{const searchInput = document.getElementById('search-input');if (searchInput){searchInput.value = '';this.filters.searchQuery = '';this.applyFilters();this.renderHistoryList()}})}}applyFilters(){const cacheKey = JSON.stringify(this.filters);const cached = this.performanceOptimizer.getCache(cacheKey);if (cached){this.filteredHistories = cached;return}if (!this.filters.rating && !this.filters.dateRange && !this.filters.searchQuery){this.filteredHistories = [...this.histories];this.performanceOptimizer.setCache(cacheKey, this.filteredHistories, 30000);return}const rating = this.filters.rating ? parseInt(this.filters.rating) : null;const query = this.filters.searchQuery ? this.filters.searchQuery.toLowerCase() : null;let startDate = null;if (this.filters.dateRange){const now = new Date();switch (this.filters.dateRange){case 'today': startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());break;case 'week': startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);break;case 'month': startDate = new Date(now.getFullYear(), now.getMonth(), 1);break;case 'quarter': startDate = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);break}}const filtered = this.performanceOptimizer.optimizedFilter(this.histories, (h) =>{if (rating && h.rating !== rating){return false}if (startDate){const executedDate = h.executedAt.toDate ? h.executedAt.toDate() : new Date(h.executedAt);if (executedDate < startDate){return false}}if (query){const resultText = (h.resultText || '').toLowerCase();const notes = (h.notes || '').toLowerCase();if (!resultText.includes(query) && !notes.includes(query)){return false}}return true});this.filteredHistories = filtered;this.performanceOptimizer.setCache(cacheKey, filtered, 30000);filtered.sort((a, b) =>{const dateA = a.executedAt.toDate ? a.executedAt.toDate() : new Date(a.executedAt);const dateB = b.executedAt.toDate ? b.executedAt.toDate() : new Date(b.executedAt);return dateB - dateA});this.filteredHistories = filtered;this.currentPage = 1;this.totalPages = Math.ceil(filtered.length / this.itemsPerPage)}renderHistoryList(){const listContainer = document.getElementById('history-list');if (this.filteredHistories.length === 0){this.showEmpty();return}this.hideEmpty();this.hideError();const startIndex = (this.currentPage - 1) * this.itemsPerPage;const endIndex = startIndex + this.itemsPerPage;const pageItems = this.filteredHistories.slice(startIndex, endIndex);const fragment = document.createDocumentFragment();const tempDiv = document.createElement('div');tempDiv.innerHTML = pageItems.map((history) => this.memoizedRenderHistoryItem(history)).join('');while (tempDiv.firstChild){fragment.appendChild(tempDiv.firstChild)}listContainer.innerHTML = '';listContainer.appendChild(fragment);this.renderPagination();this.addHistoryItemListeners()}memoizedRenderHistoryItem(history){const cacheKey = `${history.id}-${history.updatedAt || history.executedAt}`;if (this.renderCache.has(cacheKey)){return this.renderCache.get(cacheKey)}const html = this.renderHistoryItem(history);if (this.renderCache.size > 100){const firstKey = this.renderCache.keys().next().value;this.renderCache.delete(firstKey)}this.renderCache.set(cacheKey, html);return html}renderHistoryItem(history){const executedDate = history.executedAt.toDate ? history.executedAt.toDate() : new Date(history.executedAt);const formattedDate = this.formatDate(executedDate);const relativeTime = this.getRelativeTime(executedDate);const stars = 'â­'.repeat(history.rating);const preview = this.truncateText(history.resultText, 100);return ` <div class="history-item" data-history-id="${history.id}"> <div class="history-item-header"> <div class="history-rating"> <span class="rating-stars">${stars}</span> <span class="rating-number">${history.rating}ì </span> </div> <div class="history-date"> <span class="date-formatted">${formattedDate}</span> <span class="date-relative">${relativeTime}</span> </div> </div> <div class="history-content"> <div class="result-preview">${this.escapeHtml(preview)}</div> ${history.notes ? `<div class="notes-preview">ğŸ’­ ${this.escapeHtml(this.truncateText(history.notes, 50))}</div>` : ''}</div> <div class="history-actions"> <button class="btn-view" data-action="view">ìƒì„¸ ë³´ê¸°</button> <button class="btn-delete" data-action="delete">ì‚­ì œ</button> </div> </div> `}renderPagination(){const paginationContainer = document.getElementById('history-pagination');if (this.totalPages <= 1){paginationContainer.innerHTML = '';return}let html = '<div class="pagination">';if (this.currentPage > 1){html += `<button class="page-btn" data-page="${this.currentPage - 1}">â€¹ ì´ì „</button>`}const startPage = Math.max(1, this.currentPage - 2);const endPage = Math.min(this.totalPages, this.currentPage + 2);if (startPage > 1){html += '<button class="page-btn" data-page="1">1</button>';if (startPage > 2){html += '<span class="page-ellipsis">...</span>'}}for (let pageIndex = startPage;pageIndex <= endPage;pageIndex++){const isActive = pageIndex === this.currentPage ? ' active' : '';html += `<button class="page-btn${isActive}" data-page="${pageIndex}" aria-label="í˜ì´ì§€ ${pageIndex}ë¡œ ì´ë™"${isActive ? ' aria-current="page"' : ''}>${pageIndex}</button>`}if (endPage < this.totalPages){if (endPage < this.totalPages - 1){html += '<span class="page-ellipsis">...</span>'}html += `<button class="page-btn" data-page="${this.totalPages}">${this.totalPages}</button>`}if (this.currentPage < this.totalPages){html += `<button class="page-btn" data-page="${this.currentPage + 1}">ë‹¤ìŒ â€º</button>`}html += '</div>';html += ` <div class="pagination-info"> ${this.filteredHistories.length}ê°œ ì¤‘ ` + `${(this.currentPage - 1) * this.itemsPerPage + 1}-` + `${Math.min(this.currentPage * this.itemsPerPage, this.filteredHistories.length)}ê°œ í‘œì‹œ </div> `;paginationContainer.innerHTML = html;paginationContainer.addEventListener('click', (e) =>{if (e.target.classList.contains('page-btn')){const page = parseInt(e.target.dataset.page);if (page && page !== this.currentPage){this.currentPage = page;this.renderHistoryList();this.container.scrollIntoView({behavior: 'smooth', block: 'start'})}}})}addHistoryItemListeners(){const listContainer = document.getElementById('history-list');listContainer.addEventListener('click', (e) =>{const historyItem = e.target.closest('.history-item');if (!historyItem) return;const historyId = historyItem.dataset.historyId;const action = e.target.dataset.action;switch (action){case 'view': this.viewHistory(historyId);break;case 'delete': this.deleteHistory(historyId);break}})}viewHistory(historyId){const history = this.histories.find((h) => h.id === historyId);if (!history) return;const executedDate = history.executedAt.toDate ? history.executedAt.toDate() : new Date(history.executedAt);const formattedDate = executedDate.toLocaleString('ko-KR');const stars = 'â­'.repeat(history.rating);const modal = document.createElement('div');modal.className = 'history-modal';modal.innerHTML = ` <div class="modal-overlay" aria-hidden="true"></div> <div class="modal-content" role="dialog" aria-labelledby="rating-detail-title" aria-modal="true"> <div class="modal-header"> <h3 id="rating-detail-title">í‰ê°€ ìƒì„¸ ì •ë³´</h3> <button class="modal-close" aria-label="í‰ê°€ ìƒì„¸ ëª¨ë‹¬ ë‹«ê¸°">âœ•</button> </div> <div class="modal-body"> <div class="detail-section"> <h4>í‰ì </h4> <div class="rating-display"> <span class="stars">${stars}</span> <span class="rating">${history.rating}ì </span> </div> </div> <div class="detail-section"> <h4>ì‹¤í–‰ ì¼ì‹œ</h4> <p>${formattedDate}</p> </div> <div class="detail-section"> <h4>ì‹¤í–‰ ê²°ê³¼</h4> <div class="result-content">${this.escapeHtml(history.resultText)}</div> </div> ${history.notes ? ` <div class="detail-section"> <h4>ë©”ëª¨</h4> <div class="notes-content">${this.escapeHtml(history.notes)}</div> </div> ` : ''}</div> </div> `;document.body.appendChild(modal);const closeModal = () =>{document.body.removeChild(modal)};modal.querySelector('.modal-close').addEventListener('click', closeModal);modal.querySelector('.modal-overlay').addEventListener('click', closeModal);const handleEsc = (e) =>{if (e.key === 'Escape'){closeModal();document.removeEventListener('keydown', handleEsc)}};document.addEventListener('keydown', handleEsc)}async deleteHistory(historyId){if (!confirm('ì´ í‰ê°€ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){return}try{await this.executionManager.deleteExecutionHistory(historyId);this.histories = this.histories.filter((h) => h.id !== historyId);this.applyFilters();this.renderHistoryList();this.showNotification('í‰ê°€ ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success')}catch (error){console.error('âŒ íˆìŠ¤í† ë¦¬ ì‚­ì œ ì‹¤íŒ¨:', error);this.showNotification('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error')}}formatDate(date){return date.toLocaleDateString('ko-KR',{year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'})}getRelativeTime(date){const now = new Date();const diff = now - date;const seconds = Math.floor(diff / 1000);const minutes = Math.floor(seconds / 60);const hours = Math.floor(minutes / 60);const days = Math.floor(hours / 24);if (seconds < 60) return 'ë°©ê¸ˆ ì „';if (minutes < 60) return `${minutes}ë¶„ ì „`;if (hours < 24) return `${hours}ì‹œê°„ ì „`;if (days < 7) return `${days}ì¼ ì „`;return date.toLocaleDateString('ko-KR')}truncateText(text, maxLength){if (!text) return '';if (text.length <= maxLength) return text;return text.substring(0, maxLength) + '...'}escapeHtml(text){if (!text) return '';const div = document.createElement('div');div.textContent = text;return div.innerHTML}showLoading(){this.isLoading = true;document.getElementById('history-loading').style.display = 'block';document.getElementById('history-empty').style.display = 'none';document.getElementById('history-error').style.display = 'none'}hideLoading(){this.isLoading = false;document.getElementById('history-loading').style.display = 'none'}showEmpty(){document.getElementById('history-empty').style.display = 'block';document.getElementById('history-list').innerHTML = '';document.getElementById('history-pagination').innerHTML = ''}hideEmpty(){document.getElementById('history-empty').style.display = 'none'}showError(message){document.getElementById('history-error').style.display = 'block';document.getElementById('error-message').textContent = message;document.getElementById('history-list').innerHTML = '';document.getElementById('history-pagination').innerHTML = ''}hideError(){document.getElementById('history-error').style.display = 'none'}showNotification(message, type = 'info'){const existing = document.querySelector('.history-notification');if (existing){existing.remove()}const notification = document.createElement('div');notification.className = `history-notification notification-${type}`;notification.textContent = message;const colors ={success: '#27ae60', error: '#e74c3c', info: '#3498db'};Object.assign(notification.style,{position: 'fixed', top: '20px', right: '20px', padding: '12px 20px', borderRadius: '6px', backgroundColor: colors[type], color: 'white', fontWeight: '600', zIndex: '10000', animation: 'slideInRight 0.3s ease', pointerEvents: 'none'});document.body.appendChild(notification);setTimeout(() =>{notification.style.animation = 'slideOutRight 0.3s ease';setTimeout(() =>{if (document.body.contains(notification)){document.body.removeChild(notification)}}, 300)}, 3000)}addStyles(){if (document.getElementById('rating-history-styles')){return}const style = document.createElement('style');style.id = 'rating-history-styles';style.textContent = ` .rating-history{background: white;border-radius: 12px;box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);overflow: hidden}.history-header{display: flex;justify-content: space-between;align-items: center;padding: 20px 24px;border-bottom: 2px solid #e1e8ed;background: #f8f9fa}.history-header h3{font-size: 18px;font-weight: 600;color: #2c3e50;margin: 0}.btn-icon{width: 36px;height: 36px;border: none;border-radius: 6px;background: #667eea;color: white;font-size: 16px;cursor: pointer;transition: all 0.3s ease}.btn-icon:hover{background: #5568d3;transform: rotate(180deg)}.history-filters{display: grid;grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));gap: 16px;padding: 20px 24px;border-bottom: 1px solid #e1e8ed;background: #f8f9fa}.filter-group{display: flex;flex-direction: column;gap: 6px}.filter-group label{font-size: 14px;font-weight: 600;color: #2c3e50}.filter-group select, .filter-group input{padding: 8px 12px;border: 2px solid #e1e8ed;border-radius: 6px;font-size: 14px;transition: border-color 0.3s ease}.filter-group select:focus, .filter-group input:focus{outline: none;border-color: #667eea}.search-container{position: relative}.btn-clear{position: absolute;right: 8px;top: 50%;transform: translateY(-50%);width: 20px;height: 20px;border: none;background: #95a5a6;color: white;border-radius: 50%;font-size: 12px;cursor: pointer;display: none}.search-container input:not(:placeholder-shown) + .btn-clear{display: block}.history-content{padding: 24px}.history-list{display: flex;flex-direction: column;gap: 16px;min-height: 200px}.history-item{padding: 20px;border: 2px solid #e1e8ed;border-radius: 8px;transition: all 0.3s ease}.history-item:hover{border-color: #667eea;box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1)}.history-item-header{display: flex;justify-content: space-between;align-items: center;margin-bottom: 12px}.history-rating{display: flex;align-items: center;gap: 8px}.rating-stars{font-size: 16px;color: #FFD700}.rating-number{font-size: 14px;font-weight: 600;color: #2c3e50}.history-date{display: flex;flex-direction: column;align-items: flex-end;gap: 2px}.date-formatted{font-size: 14px;color: #2c3e50}.date-relative{font-size: 12px;color: #7f8c8d}.history-content{margin-bottom: 12px}.result-preview{font-size: 14px;color: #2c3e50;line-height: 1.6;margin-bottom: 8px}.notes-preview{font-size: 13px;color: #7f8c8d;font-style: italic}.history-actions{display: flex;gap: 8px;justify-content: flex-end}.btn-view, .btn-delete{padding: 6px 12px;border: none;border-radius: 4px;font-size: 13px;font-weight: 600;cursor: pointer;transition: all 0.3s ease}.btn-view{background: #667eea;color: white}.btn-view:hover{background: #5568d3}.btn-delete{background: #e74c3c;color: white}.btn-delete:hover{background: #c0392b}.history-pagination{margin-top: 24px;display: flex;flex-direction: column;align-items: center;gap: 12px}.pagination{display: flex;gap: 8px;align-items: center}.page-btn{padding: 8px 12px;border: 2px solid #e1e8ed;border-radius: 6px;background: white;color: #2c3e50;font-size: 14px;font-weight: 600;cursor: pointer;transition: all 0.3s ease}.page-btn:hover{border-color: #667eea;color: #667eea}.page-btn.active{background: #667eea;color: white;border-color: #667eea}.page-ellipsis{color: #7f8c8d;padding: 0 4px}.pagination-info{font-size: 14px;color: #7f8c8d}.history-modal{position: fixed;top: 0;left: 0;right: 0;bottom: 0;z-index: 10000;display: flex;align-items: center;justify-content: center}.modal-overlay{position: absolute;top: 0;left: 0;right: 0;bottom: 0;background: rgba(0, 0, 0, 0.5)}.modal-content{position: relative;background: white;border-radius: 12px;max-width: 600px;width: 90%;max-height: 80vh;overflow-y: auto;box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3)}.modal-header{display: flex;justify-content: space-between;align-items: center;padding: 20px 24px;border-bottom: 2px solid #e1e8ed}.modal-header h3{font-size: 18px;font-weight: 600;color: #2c3e50;margin: 0}.modal-close{width: 32px;height: 32px;border: none;border-radius: 50%;background: #e1e8ed;color: #2c3e50;font-size: 18px;cursor: pointer;transition: all 0.3s ease}.modal-close:hover{background: #e74c3c;color: white}.modal-body{padding: 24px}.detail-section{margin-bottom: 24px}.detail-section:last-child{margin-bottom: 0}.detail-section h4{font-size: 14px;font-weight: 600;color: #7f8c8d;margin-bottom: 8px;text-transform: uppercase}.rating-display{display: flex;align-items: center;gap: 12px}.rating-display .stars{font-size: 24px;color: #FFD700}.rating-display .rating{font-size: 20px;font-weight: 600;color: #2c3e50}.result-content, .notes-content{padding: 16px;background: #f8f9fa;border-radius: 8px;font-size: 14px;line-height: 1.6;color: #2c3e50;white-space: pre-wrap;word-wrap: break-word}.history-loading{text-align: center;padding: 60px 20px}.spinner{width: 50px;height: 50px;margin: 0 auto 20px;border: 5px solid #e1e8ed;border-top-color: #667eea;border-radius: 50%;animation: spin 1s linear infinite}@keyframes spin{to{transform: rotate(360deg)}}.history-empty{text-align: center;padding: 60px 20px}.empty-icon{font-size: 64px;margin-bottom: 20px}.history-empty h4{font-size: 18px;font-weight: 600;color: #2c3e50;margin-bottom: 10px}.history-empty p{font-size: 14px;color: #7f8c8d}.history-error{text-align: center;padding: 60px 20px}.error-icon{font-size: 64px;margin-bottom: 20px}.history-error h4{font-size: 18px;font-weight: 600;color: #e74c3c;margin-bottom: 10px}.history-error p{font-size: 14px;color: #7f8c8d}@keyframes slideInRight{from{transform: translateX(400px);opacity: 0}to{transform: translateX(0);opacity: 1}}@keyframes slideOutRight{from{transform: translateX(0);opacity: 1}to{transform: translateX(400px);opacity: 0}}@media (max-width: 768px){.history-filters{grid-template-columns: 1fr}.history-item-header{flex-direction: column;align-items: flex-start;gap: 8px}.history-date{align-items: flex-start}.pagination{flex-wrap: wrap}.modal-content{width: 95%}}`;document.head.appendChild(style)}cleanup(){this.container.innerHTML = '';this.histories = [];this.filteredHistories = [];clearTimeout(this.searchTimeout)}}if (typeof module !== 'undefined' && module.exports){module.exports = RatingHistoryUI}