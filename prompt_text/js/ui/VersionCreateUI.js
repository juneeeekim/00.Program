class VersionCreateUI{constructor(versionManager, promptManager){if (!versionManager || !promptManager){throw new Error('VersionManager와 PromptManager 인스턴스가 필요합니다.')}this.versionManager = versionManager;this.promptManager = promptManager;this.currentPromptId = null;this.currentVersion = 'v1.0.0';this.currentContent = '';this.currentVariables = [];this.init()}init(){this.bindEvents()}bindEvents(){const closeBtn = document.getElementById('close-version-modal');const cancelBtn = document.getElementById('cancel-version-btn');if (closeBtn){closeBtn.addEventListener('click', () => this.closeModal())}if (cancelBtn){cancelBtn.addEventListener('click', () => this.closeModal())}const createBtn = document.getElementById('create-version-btn');if (createBtn){createBtn.addEventListener('click', () => this.handleCreateVersion())}const versionTypeInputs = document.querySelectorAll('input[name="versionType"]');versionTypeInputs.forEach((input) =>{input.addEventListener('change', () => this.updateVersionPreview())});this.setupCharCounter('version-changelog', 'changelog-counter', 500);document.addEventListener('keydown', (e) =>{const modal = document.getElementById('version-create-modal');if (e.key === 'Escape' && modal && modal.style.display !== 'none'){this.closeModal()}})}async openModal(promptId, currentVersion, content, variables = []){try{this.currentPromptId = promptId;this.currentVersion = currentVersion || 'v1.0.0';this.currentContent = content || '';this.currentVariables = variables || [];const currentVersionEl = document.getElementById('current-version-number');if (currentVersionEl){currentVersionEl.textContent = this.currentVersion}this.updateVersionPreview();this.updateContentPreview();this.previousFocus = document.activeElement;const modal = document.getElementById('version-create-modal');if (modal){modal.style.display = 'flex';modal.setAttribute('aria-hidden', 'false');this.setupFocusTrap(modal);const firstInput = document.getElementById('version-type-minor');if (firstInput){setTimeout(() => firstInput.focus(), 100)}}}catch (error){console.error('❌ 모달 열기 실패:', error);this.showNotification(error.message, 'error')}}closeModal(){const modal = document.getElementById('version-create-modal');if (modal){modal.style.display = 'none';modal.setAttribute('aria-hidden', 'true')}if (this.previousFocus){this.previousFocus.focus();this.previousFocus = null}const form = document.getElementById('version-create-form');if (form){form.reset();form.querySelectorAll('.error-message').forEach((el) => (el.textContent = ''))}this.currentPromptId = null;this.currentVersion = 'v1.0.0';this.currentContent = '';this.currentVariables = []}updateVersionPreview(){const selectedType = document.querySelector('input[name="versionType"]:checked');if (!selectedType) return;const versionType = selectedType.value;try{const newVersion = this.versionManager.incrementVersion(this.currentVersion, versionType);const previewEl = document.getElementById('new-version-preview');if (previewEl){previewEl.textContent = newVersion}}catch (error){console.error('❌ 버전 미리보기 업데이트 실패:', error)}}updateContentPreview(){const contentEl = document.getElementById('version-content-text');if (contentEl){contentEl.textContent = this.currentContent || '(내용 없음)'}const lengthEl = document.getElementById('content-length');if (lengthEl){lengthEl.textContent = this.currentContent.length.toLocaleString()}const variablesEl = document.getElementById('variables-count');if (variablesEl){variablesEl.textContent = this.currentVariables.length}}async handleCreateVersion(){try{const form = document.getElementById('version-create-form');const createBtn = document.getElementById('create-version-btn');if (!this.validateForm(form)){this.showNotification('입력 내용을 확인해주세요.', 'error');return}createBtn.classList.add('loading');createBtn.disabled = true;const formData = new FormData(form);const versionType = formData.get('versionType') || 'minor';const changelog = formData.get('changelog');const versionId = await this.versionManager.createVersion(this.currentPromptId,{versionType: versionType, changelog: changelog, content: this.currentContent, variables: this.currentVariables});this.showNotification('새 버전이 생성되었습니다!', 'success');this.closeModal();document.dispatchEvent( new CustomEvent('versionCreated',{detail:{promptId: this.currentPromptId, versionId: versionId}}) )}catch (error){console.error('❌ 버전 생성 실패:', error);this.showNotification(error.message, 'error')}finally{const createBtn = document.getElementById('create-version-btn');if (createBtn){createBtn.classList.remove('loading');createBtn.disabled = false}}}validateForm(form){let isValid = true;const versionType = form.querySelector('input[name="versionType"]:checked');const versionTypeError = document.getElementById('version-type-error');if (!versionType){versionTypeError.textContent = '버전 타입을 선택해주세요.';isValid = false}else{versionTypeError.textContent = ''}const changelog = form.querySelector('#version-changelog');const changelogError = document.getElementById('changelog-error');if (!changelog.value.trim()){changelogError.textContent = '변경 사항을 입력해주세요.';changelog.setAttribute('aria-invalid', 'true');isValid = false}else if (changelog.value.trim().length < 5){changelogError.textContent = '변경 사항은 최소 5자 이상이어야 합니다.';changelog.setAttribute('aria-invalid', 'true');isValid = false}else{changelogError.textContent = '';changelog.removeAttribute('aria-invalid')}return isValid}setupCharCounter(inputId, counterId, maxLength){const input = document.getElementById(inputId);const counter = document.getElementById(counterId);if (!input || !counter) return;const updateCounter = () =>{const length = input.value.length;counter.textContent = `${length}/${maxLength}`;if (length >= maxLength * 0.9){counter.style.color = '#e74c3c'}else{counter.style.color = '#95a5a6'}};input.addEventListener('input', updateCounter);updateCounter()}setupFocusTrap(container){const focusableElements = container.querySelectorAll( 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])' );const firstElement = focusableElements[0];const lastElement = focusableElements[focusableElements.length - 1];const handleTabKey = (e) =>{if (e.key !== 'Tab') return;if (e.shiftKey){if (document.activeElement === firstElement){e.preventDefault();lastElement.focus()}}else{if (document.activeElement === lastElement){e.preventDefault();firstElement.focus()}}};container.addEventListener('keydown', handleTabKey)}showNotification(message, type = 'info'){const notification = document.createElement('div');notification.className = `notification notification-${type}`;notification.textContent = message;notification.setAttribute('role', 'alert');notification.setAttribute('aria-live', 'polite');Object.assign(notification.style,{position: 'fixed', top: '20px', right: '20px', padding: '16px 24px', borderRadius: '8px', backgroundColor: type === 'error' ? '#e74c3c' : type === 'success' ? '#27ae60' : '#3498db', color: '#ffffff', fontWeight: '600', boxShadow: '0 4px 12px rgba(0, 0, 0, 0.2)', zIndex: '10000', animation: 'slideInRight 0.3s ease-out'});document.body.appendChild(notification);setTimeout(() =>{notification.style.animation = 'slideOutRight 0.3s ease-out';setTimeout(() =>{document.body.removeChild(notification)}, 300)}, 3000)}}if (typeof module !== 'undefined' && module.exports){module.exports = VersionCreateUI}