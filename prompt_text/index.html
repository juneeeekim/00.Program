<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="PromptHub - AI í”„ë¡¬í”„íŠ¸ ê´€ë¦¬ í”Œë«í¼" />
    <meta name="keywords" content="AI, í”„ë¡¬í”„íŠ¸, ê´€ë¦¬, ChatGPT, Claude, Gemini" />
    <meta name="theme-color" content="#667eea" />
    <title>PromptHub - AI í”„ë¡¬í”„íŠ¸ ê´€ë¦¬ í”Œë«í¼</title>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics-compat.js"></script>

    <!-- ìŠ¤íƒ€ì¼ -->
    <link rel="stylesheet" href="css/error-toast.css" />
    <link rel="stylesheet" href="css/monitoring-dashboard.css" />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #333;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .container {
        max-width: 1200px;
        width: 100%;
        padding: 20px;
      }

      /* í—¤ë” */
      header {
        text-align: center;
        color: white;
        margin-bottom: 40px;
      }

      h1 {
        font-size: 48px;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
      }

      .subtitle {
        font-size: 18px;
        opacity: 0.9;
      }

      /* ì¸ì¦ ì„¹ì…˜ */
      #auth-section {
        background: white;
        padding: 40px;
        border-radius: 16px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        max-width: 450px;
        margin: 0 auto;
      }

      #auth-section h2 {
        font-size: 24px;
        margin-bottom: 24px;
        color: #333;
        text-align: center;
      }

      .auth-form {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .input-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      label {
        font-size: 14px;
        font-weight: 600;
        color: #555;
      }

      input {
        padding: 14px;
        border: 2px solid #e1e5e9;
        border-radius: 8px;
        font-size: 15px;
        transition: all 0.3s;
      }

      input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      button {
        padding: 14px 24px;
        border: none;
        border-radius: 8px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
      }

      .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
      }

      .btn-secondary {
        background: #6c757d;
        color: white;
      }

      .btn-secondary:hover {
        background: #5a6268;
      }

      .btn-google {
        background: white;
        color: #333;
        border: 2px solid #e1e5e9;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .btn-google:hover {
        background: #f8f9fa;
        border-color: #667eea;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .auth-divider {
        text-align: center;
        margin: 20px 0;
        position: relative;
      }

      .auth-divider::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        height: 1px;
        background: #e1e5e9;
      }

      .auth-divider span {
        background: white;
        padding: 0 16px;
        position: relative;
        color: #999;
        font-size: 14px;
      }

      .auth-note {
        font-size: 13px;
        color: #999;
        text-align: center;
        margin-top: 8px;
      }

      /* ë©”ì¸ ì½˜í…ì¸  */
      #main-content {
        display: none;
        background: white;
        border-radius: 16px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        overflow: hidden;
      }

      .user-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 24px 32px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      /* íƒ­ ë„¤ë¹„ê²Œì´ì…˜ */
      .tab-navigation {
        background: #f8f9fa;
        border-bottom: 2px solid #e1e5e9;
        display: flex;
        gap: 0;
      }

      .tab-button {
        flex: 1;
        padding: 16px 24px;
        border: none;
        background: transparent;
        color: #666;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        border-bottom: 3px solid transparent;
        position: relative;
      }

      .tab-button:hover {
        background: #e9ecef;
        color: #333;
      }

      .tab-button.active {
        color: #667eea;
        background: white;
        border-bottom-color: #667eea;
      }

      .tab-button.active::after {
        content: '';
        position: absolute;
        bottom: -2px;
        left: 0;
        right: 0;
        height: 2px;
        background: #667eea;
      }

      /* íƒ­ ì½˜í…ì¸  */
      .tab-content {
        display: none;
        padding: 32px;
        min-height: 400px;
      }

      .tab-content.active {
        display: block;
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .user-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
      }

      .section {
        padding: 32px;
      }

      .section h2 {
        font-size: 24px;
        margin-bottom: 20px;
        color: #333;
      }

      .section-divider {
        height: 1px;
        background: #e1e5e9;
        margin: 0;
      }

      /* ë¡œë”© */
      #loading {
        display: none; /* ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€, í•„ìš”ì‹œ í‘œì‹œ */
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        justify-content: center;
        align-items: center;
        z-index: 9999;
      }

      .spinner {
        width: 60px;
        height: 60px;
        border: 6px solid rgba(255, 255, 255, 0.3);
        border-top: 6px solid white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }

        100% {
          transform: rotate(360deg);
        }
      }

      /* ìŠ¤í¬ë¦° ë¦¬ë” ì „ìš© í…ìŠ¤íŠ¸ */
      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border-width: 0;
      }

      /* ë°˜ì‘í˜• */
      @media (max-width: 768px) {
        h1 {
          font-size: 36px;
        }

        #auth-section {
          padding: 24px;
        }

        .section {
          padding: 20px;
        }
      }
      /* Custom Select Dropdown */
      .custom-select-wrapper {
        position: relative;
        user-select: none;
        width: 100%;
      }
      
      .custom-select-wrapper select {
        display: none;
      }
      
      .custom-select-trigger {
        position: relative;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 14px;
        font-size: 15px;
        font-weight: 400;
        color: #333;
        background: white;
        border: 2px solid #e1e5e9;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
      }
      
      .custom-select-trigger:hover {
        border-color: #667eea;
      }
      
      .custom-select-trigger:after {
        content: 'â–¼';
        font-size: 12px;
        color: #666;
        transition: transform 0.3s;
      }
      
      .custom-select-wrapper.open .custom-select-trigger:after {
        transform: rotate(180deg);
      }
      
      .custom-select-options {
        position: absolute;
        display: block;
        top: calc(100% + 8px);
        left: 0;
        right: 0;
        border: 2px solid #e1e5e9;
        border-radius: 8px;
        background: white;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        opacity: 0;
        visibility: hidden;
        pointer-events: none;
        z-index: 9999;
        transform: translateY(-10px);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        max-height: 300px;
        overflow-y: auto;
      }
      
      .custom-select-wrapper.open .custom-select-options {
        opacity: 1;
        visibility: visible;
        pointer-events: all;
        transform: translateY(0);
      }
      
      .custom-option {
        position: relative;
        display: block;
        padding: 14px;
        font-size: 15px;
        color: #333;
        cursor: pointer;
        transition: all 0.2s;
        border-bottom: 1px solid #f1f3f5;
      }
      
      .custom-option:last-child {
        border-bottom: none;
      }
      
      .custom-option:hover {
        background-color: #f8f9fa;
        color: #667eea;
        padding-left: 20px;
      }
      
      .custom-option.selected {
        background-color: #f0f4ff;
        color: #667eea;
        font-weight: 600;
      }
    </style>
  </head>

  <body>
    <!-- Skip to content (ì ‘ê·¼ì„±) -->
    <a
      href="#main-content"
      class="skip-link"
      style="
        position: absolute;
        top: -40px;
        left: 0;
        background: #667eea;
        color: white;
        padding: 8px;
        text-decoration: none;
        z-index: 100;
      "
    >
      ë³¸ë¬¸ìœ¼ë¡œ ê±´ë„ˆë›°ê¸°
    </a>

    <div class="container">
      <header>
        <h1>ğŸš€ PromptHub</h1>
        <p class="subtitle">AI í”„ë¡¬í”„íŠ¸ë¥¼ íš¨ìœ¨ì ìœ¼ë¡œ ê´€ë¦¬í•˜ì„¸ìš”</p>
      </header>

      <!-- ì¸ì¦ ì„¹ì…˜ -->
      <section id="auth-section">
        <h2>ì‹œì‘í•˜ê¸°</h2>
        <form class="auth-form" onsubmit="return false;">
          <div class="input-group">
            <label for="email-input">ì´ë©”ì¼</label>
            <input type="email" id="email-input" placeholder="your@email.com" aria-label="ì´ë©”ì¼" required />
          </div>
          <div class="input-group">
            <label for="password-input">ë¹„ë°€ë²ˆí˜¸</label>
            <input type="password" id="password-input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" aria-label="ë¹„ë°€ë²ˆí˜¸" required />
          </div>
          <button type="button" id="login-btn" class="btn-primary">ë¡œê·¸ì¸</button>

          <div class="auth-divider">
            <span>ë˜ëŠ”</span>
          </div>

          <button type="button" id="google-login-btn" class="btn-google">
            <svg width="18" height="18" viewBox="0 0 18 18" style="margin-right: 8px">
              <path
                fill="#4285F4"
                d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z"
              />
              <path
                fill="#34A853"
                d="M9 18c2.43 0 4.467-.806 5.956-2.184l-2.908-2.258c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332C2.438 15.983 5.482 18 9 18z"
              />
              <path
                fill="#FBBC05"
                d="M3.964 10.707c-.18-.54-.282-1.117-.282-1.707s.102-1.167.282-1.707V4.961H.957C.347 6.175 0 7.55 0 9s.348 2.825.957 4.039l3.007-2.332z"
              />
              <path
                fill="#EA4335"
                d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0 5.482 0 2.438 2.017.957 4.961L3.964 7.293C4.672 5.163 6.656 3.58 9 3.58z"
              />
            </svg>
            Googleë¡œ ì‹œì‘í•˜ê¸°
          </button>

          <button type="button" id="signup-btn" class="btn-secondary">íšŒì›ê°€ì…</button>
        </form>
        <p class="auth-note">í…ŒìŠ¤íŠ¸: test@example.com / test123</p>
      </section>

      <!-- ë©”ì¸ ì½˜í…ì¸  -->
      <main id="main-content">
        <!-- ì‚¬ìš©ì í—¤ë” -->
        <div class="user-header">
          <div class="user-info">
            <div class="user-avatar">ğŸ‘¤</div>
            <div>
              <div style="font-weight: 600; font-size: 16px" id="user-email"></div>
              <div style="font-size: 13px; opacity: 0.9">PromptHub ì‚¬ìš©ì</div>
            </div>
          </div>
          <button id="logout-btn" class="btn-secondary">ë¡œê·¸ì•„ì›ƒ</button>
        </div>

        <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
        <div class="tab-navigation" role="tablist">
          <button class="tab-button active" data-tab="register" role="tab" aria-selected="true" aria-controls="tab-register">
            âœï¸ í”„ë¡¬í”„íŠ¸ ë“±ë¡
          </button>
          <button class="tab-button" data-tab="use" role="tab" aria-selected="false" aria-controls="tab-use">
            ğŸš€ í”„ë¡¬í”„íŠ¸ ì‚¬ìš©
          </button>
          <button class="tab-button" data-tab="search" role="tab" aria-selected="false" aria-controls="tab-search">
            ğŸ” í”„ë¡¬í”„íŠ¸ ê²€ìƒ‰
          </button>
        </div>

        <!-- íƒ­ 1: í”„ë¡¬í”„íŠ¸ ë“±ë¡ -->
        <div id="tab-register" class="tab-content active" role="tabpanel" aria-labelledby="tab-register">
          <h2 style="font-size: 24px; margin-bottom: 20px; color: #333;">âœ¨ ìƒˆ í”„ë¡¬í”„íŠ¸ ë“±ë¡</h2>
          <button id="create-prompt-btn" class="btn-primary" style="margin-bottom: 20px;">â• ìƒˆ í”„ë¡¬í”„íŠ¸ ìƒì„±</button>
          <div id="prompt-form"></div>
        </div>

        <!-- íƒ­ 2: í”„ë¡¬í”„íŠ¸ ì‚¬ìš© -->
        <div id="tab-use" class="tab-content" role="tabpanel" aria-labelledby="tab-use">
          <h2 style="font-size: 24px; margin-bottom: 20px; color: #333;">ğŸš€ í”„ë¡¬í”„íŠ¸ ì‚¬ìš©</h2>
          
          <!-- ì¹´í…Œê³ ë¦¬ ì„ íƒ ì˜ì—­ -->
          <div id="category-selector" style="margin-bottom: 24px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">ì¹´í…Œê³ ë¦¬ ì„ íƒ</label>
            <select id="category-select-dropdown" style="width: 100%; padding: 14px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 15px; background: white; cursor: pointer;">
              <option value="">ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”...</option>
            </select>
          </div>

          <!-- í”„ë¡¬í”„íŠ¸ ì¹´ë“œ ê·¸ë¦¬ë“œ -->
          <div id="prompt-cards-container" style="display: none; margin-bottom: 24px;">
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px;" id="prompt-cards-grid"></div>
          </div>

          <!-- ì‹¤í–‰ íŒ¨ë„ -->
          <div id="execution-panel"></div>
        </div>

        <!-- íƒ­ 3: í”„ë¡¬í”„íŠ¸ ê²€ìƒ‰ -->
        <div id="tab-search" class="tab-content" role="tabpanel" aria-labelledby="tab-search">
          <h2 style="font-size: 24px; margin-bottom: 20px; color: #333;">ğŸ” í”„ë¡¬í”„íŠ¸ ê²€ìƒ‰</h2>
          <div style="margin-bottom: 20px;">
            <input 
              type="text" 
              id="search-input" 
              placeholder="í”„ë¡¬í”„íŠ¸ ì œëª©, ë‚´ìš©, ì¹´í…Œê³ ë¦¬ë¡œ ê²€ìƒ‰..." 
              style="width: 100%; padding: 14px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 15px;"
            />
          </div>
          <div id="prompt-search-results"></div>
        </div>
      </main>
    </div>

    <!-- ë¡œë”© -->
    <div id="loading">
      <div class="spinner"></div>
    </div>

    <!-- Firebase ì´ˆê¸°í™” ë° ë©”ì¸ ì•± -->
    <script>
      // Firebase ì„¤ì •
      const firebaseConfig = {
        apiKey: 'AIzaSyDudPHjfulRRa6wtOzC8nkPE8wnhya__DE',
        authDomain: 'prompthub-production.firebaseapp.com',
        projectId: 'prompthub-production',
        storageBucket: 'prompthub-production.firebasestorage.app',
        messagingSenderId: '547082323866',
        appId: '1:547082323866:web:b44da017391ab6dd2cdc23',
        measurementId: 'G-NRW0VKLWDK'
      };

      // Firebase ì´ˆê¸°í™”
      try {
        if (!firebase.apps.length) {
          firebase.initializeApp(firebaseConfig);
          console.log('âœ… Firebase ì´ˆê¸°í™” ì™„ë£Œ');
        }
      } catch (error) {
        console.error('âŒ Firebase ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
        alert('Firebase ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”. firebase-config.js íŒŒì¼ì„ ì°¸ê³ í•˜ì„¸ìš”.');
      }

      // ì „ì—­ ë³€ìˆ˜
      let auth,
        db,
        currentUser = null;

      // DOM ìš”ì†Œ
      const elements = {
        loading: document.getElementById('loading'),
        authSection: document.getElementById('auth-section'),
        mainContent: document.getElementById('main-content'),
        emailInput: document.getElementById('email-input'),
        passwordInput: document.getElementById('password-input'),
        loginBtn: document.getElementById('login-btn'),
        signupBtn: document.getElementById('signup-btn'),
        logoutBtn: document.getElementById('logout-btn'),
        userEmail: document.getElementById('user-email'),
        createPromptBtn: document.getElementById('create-prompt-btn'),
        promptLibrary: document.getElementById('prompt-library'),
        promptForm: document.getElementById('prompt-form'),
        executionPanel: document.getElementById('execution-panel'),
        tabButtons: document.querySelectorAll('.tab-button'),
        tabContents: document.querySelectorAll('.tab-content'),
        searchInput: document.getElementById('search-input'),
        promptUseList: document.getElementById('prompt-use-list'),
        promptSearchResults: document.getElementById('prompt-search-results'),
        promptSelectDropdown: document.getElementById('prompt-select-dropdown'),
        categorySelectDropdown: document.getElementById('category-select-dropdown'),
        promptCardsContainer: document.getElementById('prompt-cards-container'),
        promptCardsGrid: document.getElementById('prompt-cards-grid')
      };

      // í˜„ì¬ í™œì„± íƒ­
      let currentTab = 'register';

      // LLM ëª¨ë¸ ì˜µì…˜
      const llmModelOptions = [
        { value: 'gpt-5', label: 'OpenAI GPT-5' },
        { value: 'gpt-5.1', label: 'OpenAI GPT-5.1' },
        { value: 'gpt-4o-mini', label: 'OpenAI GPT-4o mini' },
        { value: 'gpt-4.1', label: 'OpenAI GPT-4.1' },
        { value: 'gpt-4o', label: 'OpenAI GPT-4o' },
        { value: 'gpt-3.5-turbo', label: 'OpenAI GPT-3.5 Turbo' },
        { value: 'claude-sonnet-4.5', label: 'Claude Sonnet 4.5' },
        { value: 'claude-3-5-sonnet', label: 'Claude 3.5 Sonnet' },
        { value: 'claude-4-opus', label: 'Claude 4 Opus' },
        { value: 'claude-3-opus', label: 'Claude 3 Opus' },
        { value: 'grok-4', label: 'Grok 4' },
        { value: 'gemini-2.5-flash', label: 'Gemini 2.5 Flash' },
        { value: 'gemini-2.5-pro', label: 'Gemini 2.5 Pro' },
        { value: 'gemini-1.5-pro', label: 'Gemini 1.5 Pro' },
        { value: 'mistral-large', label: 'Mistral Large' },
        { value: 'custom', label: 'ì§ì ‘ ì…ë ¥' }
      ];

      function renderLlmModelField({ selectId, customInputId }) {
        const optionsHtml = llmModelOptions
          .map(({ value, label }) => `<option value="${value}">${label}</option>`)
          .join('');

        return `
          <div>
            <label style="display: block; margin-bottom: 8px; font-weight: 600;">LLM ëª¨ë¸</label>
            <select id="${selectId}" style="width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 15px;">
              ${optionsHtml}
            </select>
            <input 
              type="text" 
              id="${customInputId}" 
              placeholder="ì§ì ‘ ëª¨ë¸ëª…ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: gpt-4o, claude-3-haiku)" 
              style="width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 15px; margin-top: 10px; display: none;"
            />
            <p style="margin-top: 6px; color: #666; font-size: 13px;">ì‚¬ìš©í•  LLM ëª¨ë¸ì„ ì„ íƒí•˜ê±°ë‚˜ ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
          </div>
        `;
      }

      function renderLlmModeField({ inputId }) {
        return `
          <div>
            <label style="display: block; margin-bottom: 8px; font-weight: 600;">LLM ëª¨ë¸ ìœ í˜•</label>
            <input 
              type="text" 
              id="${inputId}" 
              placeholder="ì˜ˆ: GPT-4o Thinking, Claude ì¼ë°˜, ì»¤ìŠ¤í…€ ëª¨ë“œ ë“±" 
              style="width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 15px;"
            />
            <p style="margin-top: 6px; color: #666; font-size: 13px;">ì‹±í‚¹ ëª¨ë¸ / ì¼ë°˜ ëª¨ë¸ / ê¸°íƒ€ ì„¸ë¶€ ëª¨ë“œë¥¼ ììœ ë¡­ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
          </div>
        `;
      }

      function setupLlmModelSelector({ selectId, customInputId, initialValue }) {
        const selectEl = document.getElementById(selectId);
        const customEl = document.getElementById(customInputId);
        if (!selectEl || !customEl) return;

        const applyInitialValue = () => {
          if (!initialValue) {
            selectEl.value = llmModelOptions[0].value;
            customEl.style.display = 'none';
            customEl.value = '';
            return;
          }

          const exists = llmModelOptions.some(option => option.value === initialValue);
          if (exists) {
            selectEl.value = initialValue;
            customEl.style.display = 'none';
            customEl.value = '';
          } else {
            selectEl.value = 'custom';
            customEl.style.display = 'block';
            customEl.value = initialValue;
          }
        };

        applyInitialValue();

        selectEl.addEventListener('change', () => {
          if (selectEl.value === 'custom') {
            customEl.style.display = 'block';
            customEl.focus();
          } else {
            customEl.style.display = 'none';
          }
        });
      }

      function getSelectedLlmModel(selectId, customInputId) {
        const selectEl = document.getElementById(selectId);
        const customEl = document.getElementById(customInputId);
        if (!selectEl) return 'ë¯¸ì§€ì •';
        if (selectEl.value === 'custom') {
          return (customEl?.value.trim() || 'ë¯¸ì§€ì •');
        }
        return selectEl.value;
      }

      function setLlmModeValue(inputId, value) {
        const input = document.getElementById(inputId);
        if (input) {
          input.value = value || '';
        }
      }

      function getLlmModeValue(inputId) {
        const input = document.getElementById(inputId);
        return input ? (input.value.trim() || 'ì¼ë°˜') : 'ì¼ë°˜';
      }

      // ì´ˆê¸°í™”
      function init() {
        try {
          // ì´ˆê¸° ë¡œë”© í‘œì‹œ
          showLoading();
          
          auth = firebase.auth();
          db = firebase.firestore();

          // ì¸ì¦ ìƒíƒœ ê°ì§€ (íƒ€ì„ì•„ì›ƒ ì¶”ê°€)
          const authStateTimeout = setTimeout(() => {
            console.warn('âš ï¸ ì¸ì¦ ìƒíƒœ í™•ì¸ì´ ì§€ì—°ë˜ê³  ìˆìŠµë‹ˆë‹¤. ë¡œë”©ì„ ìˆ¨ê¹ë‹ˆë‹¤.');
            hideLoading();
            showAuthSection();
          }, 5000); // 5ì´ˆ íƒ€ì„ì•„ì›ƒ

          auth.onAuthStateChanged((user) => {
            clearTimeout(authStateTimeout); // íƒ€ì„ì•„ì›ƒ ì·¨ì†Œ
            handleAuthStateChanged(user);
          }, (error) => {
            clearTimeout(authStateTimeout); // íƒ€ì„ì•„ì›ƒ ì·¨ì†Œ
            console.error('âŒ ì¸ì¦ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:', error);
            hideLoading();
            showAuthSection();
            showError('ì¸ì¦ ìƒíƒœë¥¼ í™•ì¸í•˜ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
          });

          // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
          elements.loginBtn.addEventListener('click', handleLogin);
          elements.signupBtn.addEventListener('click', handleSignup);
          elements.logoutBtn.addEventListener('click', handleLogout);
          elements.createPromptBtn.addEventListener('click', handleCreatePrompt);
          
          // Google ë¡œê·¸ì¸ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
          const googleLoginBtn = document.getElementById('google-login-btn');
          if (googleLoginBtn) {
            googleLoginBtn.addEventListener('click', handleGoogleLogin);
          }

          // íƒ­ ì „í™˜ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
          elements.tabButtons.forEach(button => {
            button.addEventListener('click', () => {
              const tabName = button.getAttribute('data-tab');
              switchTab(tabName);
            });
          });

          // ê²€ìƒ‰ ì…ë ¥ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
          if (elements.searchInput) {
            elements.searchInput.addEventListener('input', handleSearch);
          }

          // ì¹´í…Œê³ ë¦¬ ì„ íƒ ë“œë¡­ë‹¤ìš´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
          if (elements.categorySelectDropdown) {
            elements.categorySelectDropdown.addEventListener('change', handleCategorySelect);
          }

          // Enter í‚¤ ì²˜ë¦¬
          elements.emailInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') elements.passwordInput.focus();
          });
          elements.passwordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleLogin();
          });

          console.log('âœ… ì•± ì´ˆê¸°í™” ì™„ë£Œ');
        } catch (error) {
          console.error('âŒ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
          hideLoading();
          showAuthSection();
          showError('ì•± ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }
      }

      // ì¸ì¦ ìƒíƒœ ë³€ê²½ ì²˜ë¦¬
      function handleAuthStateChanged(user) {
        hideLoading();

        if (user) {
          currentUser = user;
          showMainContent();
          loadPromptsForAllTabs();
        } else {
          currentUser = null;
          showAuthSection();
        }
      }

      // íƒ­ ì „í™˜
      function switchTab(tabName, options = {}) {
        currentTab = tabName;
        
        // íƒ­ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        elements.tabButtons.forEach(button => {
          const isActive = button.getAttribute('data-tab') === tabName;
          button.classList.toggle('active', isActive);
          button.setAttribute('aria-selected', isActive);
        });

        // íƒ­ ì½˜í…ì¸  í‘œì‹œ/ìˆ¨ê¹€
        elements.tabContents.forEach(content => {
          const isActive = content.id === `tab-${tabName}`;
          content.classList.toggle('active', isActive);
        });

        // íƒ­ë³„ ë°ì´í„° ë¡œë“œ (skipReload ì˜µì…˜ì´ ì—†ì„ ë•Œë§Œ)
        if (!options.skipReload) {
          if (tabName === 'use') {
            loadPromptsForUse();
          } else if (tabName === 'search') {
            loadPromptsForSearch();
          }
        }
      }

      // ë¡œê·¸ì¸
      async function handleLogin() {
        const email = elements.emailInput.value.trim();
        const password = elements.passwordInput.value;

        if (!email || !password) {
          showError('ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }

        showLoading();

        try {
          await auth.signInWithEmailAndPassword(email, password);
          showSuccess('ë¡œê·¸ì¸ ì„±ê³µ!');
        } catch (error) {
          console.error('ë¡œê·¸ì¸ ì‹¤íŒ¨:', error);
          showError(getErrorMessage(error.code));
        } finally {
          hideLoading();
        }
      }

      // íšŒì›ê°€ì…
      async function handleSignup() {
        const email = elements.emailInput.value.trim();
        const password = elements.passwordInput.value;

        if (!email || !password) {
          showError('ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }

        if (password.length < 6) {
          showError('ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
          return;
        }

        showLoading();

        try {
          await auth.createUserWithEmailAndPassword(email, password);
          showSuccess('íšŒì›ê°€ì… ì„±ê³µ!');
        } catch (error) {
          console.error('íšŒì›ê°€ì… ì‹¤íŒ¨:', error);
          showError(getErrorMessage(error.code));
        } finally {
          hideLoading();
        }
      }

      // Google ë¡œê·¸ì¸/íšŒì›ê°€ì…
      async function handleGoogleLogin() {
        showLoading();

        try {
          const provider = new firebase.auth.GoogleAuthProvider();
          // ì¶”ê°€ ì˜µì…˜ ì„¤ì • (ì„ íƒì‚¬í•­)
          provider.setCustomParameters({
            prompt: 'select_account' // ê³„ì • ì„ íƒ í™”ë©´ í‘œì‹œ
          });
          
          const result = await auth.signInWithPopup(provider);
          const user = result.user;
          
          // ì‹ ê·œ ì‚¬ìš©ì ì—¬ë¶€ í™•ì¸ (ì¶”ê°€ ì •ë³´ê°€ ì—†ìœ¼ë©´ ì‹ ê·œ ì‚¬ìš©ìë¡œ ê°„ì£¼)
          const isNewUser = result.additionalUserInfo?.isNewUser;
          
          if (isNewUser) {
            showSuccess(`í™˜ì˜í•©ë‹ˆë‹¤! ${user.displayName || user.email}ë‹˜, íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.`);
            console.log('âœ… Google íšŒì›ê°€ì… ì„±ê³µ:', user.uid, user.email);
          } else {
            showSuccess(`í™˜ì˜í•©ë‹ˆë‹¤! ${user.displayName || user.email}ë‹˜, ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            console.log('âœ… Google ë¡œê·¸ì¸ ì„±ê³µ:', user.uid, user.email);
          }
        } catch (error) {
          console.error('âŒ Google ë¡œê·¸ì¸/íšŒì›ê°€ì… ì‹¤íŒ¨:', error);
          console.error('ì—ëŸ¬ ì½”ë“œ:', error.code);
          console.error('ì—ëŸ¬ ë©”ì‹œì§€:', error.message);
          
          // ìƒì„¸í•œ ì—ëŸ¬ ì²˜ë¦¬
          if (error.code === 'auth/popup-closed-by-user') {
            showError('ë¡œê·¸ì¸ ì°½ì´ ë‹«í˜”ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
          } else if (error.code === 'auth/popup-blocked') {
            showError('íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ íŒì—…ì„ í—ˆìš©í•´ì£¼ì„¸ìš”.');
          } else if (error.code === 'auth/operation-not-allowed') {
            showError('Google ë¡œê·¸ì¸ì´ í™œì„±í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. Firebase Consoleì—ì„œ Google ë¡œê·¸ì¸ì„ í™œì„±í™”í•´ì£¼ì„¸ìš”.');
          } else if (error.code === 'auth/unauthorized-domain') {
            showError('ìŠ¹ì¸ë˜ì§€ ì•Šì€ ë„ë©”ì¸ì…ë‹ˆë‹¤. Firebase Consoleì—ì„œ ë„ë©”ì¸ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.');
          } else if (error.code === 'auth/network-request-failed') {
            showError('ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
          } else {
            const errorMsg = getErrorMessage(error.code) || `Google ë¡œê·¸ì¸/íšŒì›ê°€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (${error.code})`;
            showError(errorMsg);
          }
        } finally {
          hideLoading();
        }
      }

      // ë¡œê·¸ì•„ì›ƒ
      async function handleLogout() {
        showLoading();

        try {
          await auth.signOut();
          showSuccess('ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.');
          elements.emailInput.value = '';
          elements.passwordInput.value = '';
        } catch (error) {
          console.error('ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨:', error);
          showError('ë¡œê·¸ì•„ì›ƒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        } finally {
          hideLoading();
        }
      }

      // í”„ë¡¬í”„íŠ¸ ìƒì„±
      function handleCreatePrompt() {
        elements.promptForm.innerHTML = `
                <h2>âœ¨ ìƒˆ í”„ë¡¬í”„íŠ¸ ìƒì„±</h2>
                <div style="display: flex; flex-direction: column; gap: 16px; margin-top: 20px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">ì œëª©</label>
                        <input type="text" id="prompt-title" placeholder="í”„ë¡¬í”„íŠ¸ ì œëª©" style="width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 15px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">ë‚´ìš©</label>
                        <textarea id="prompt-content" placeholder="í”„ë¡¬í”„íŠ¸ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..." style="width: 100%; min-height: 150px; padding: 12px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 15px; resize: vertical;"></textarea>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">ì¹´í…Œê³ ë¦¬</label>
                        <input type="text" id="prompt-category" placeholder="ì˜ˆ: ì½”ë”©, ê¸€ì“°ê¸°, ë²ˆì—­" style="width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 15px;">
                    </div>
                    ${renderLlmModelField({ selectId: 'llm-model-select', customInputId: 'llm-model-custom' })}
                    ${renderLlmModeField({ inputId: 'llm-mode-input' })}
                    <div style="display: flex; gap: 12px;">
                        <button onclick="savePrompt()" class="btn-primary" style="flex: 1;">ğŸ’¾ ì €ì¥</button>
                        <button onclick="cancelPrompt()" class="btn-secondary" style="flex: 1;">âŒ ì·¨ì†Œ</button>
                    </div>
                </div>
            `;
        elements.promptForm.scrollIntoView({ behavior: 'smooth' });
        setupLlmModelSelector({
          selectId: 'llm-model-select',
          customInputId: 'llm-model-custom',
          initialValue: llmModelOptions[0].value
        });
        setLlmModeValue('llm-mode-input', 'ì¼ë°˜');
      }

      // í”„ë¡¬í”„íŠ¸ ì €ì¥
      window.savePrompt = async function () {
        const title = document.getElementById('prompt-title').value.trim();
        const content = document.getElementById('prompt-content').value.trim();
        const category = document.getElementById('prompt-category').value.trim();
        const llmModel = getSelectedLlmModel('llm-model-select', 'llm-model-custom');
        const llmMode = getLlmModeValue('llm-mode-input');

        if (!title || !content) {
          showError('ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }

        showLoading();

        try {
          // Firestore ê·œì¹™ì— ë§ëŠ” ê²½ë¡œ ì‚¬ìš©: users/{userId}/prompts/{promptId}
          const userId = currentUser.uid;
          const promptRef = db.collection('users').doc(userId).collection('prompts').doc();
          const promptId = promptRef.id;
          
          // ê°™ì€ ì¹´í…Œê³ ë¦¬ì˜ í”„ë¡¬í”„íŠ¸ ê°œìˆ˜ í™•ì¸í•˜ì—¬ displayOrder ì„¤ì •
          const categoryPrompts = await db
            .collection('users')
            .doc(userId)
            .collection('prompts')
            .where('category', '==', category || 'ê¸°íƒ€')
            .where('isDeleted', '==', false)
            .get();
          
          const displayOrder = categoryPrompts.size; // ìƒˆ í”„ë¡¬í”„íŠ¸ëŠ” ë§ˆì§€ë§‰ ìˆœì„œ

          // Firestore ê·œì¹™ì—ì„œ ìš”êµ¬í•˜ëŠ” í•„ìˆ˜ í•„ë“œ í¬í•¨
          await promptRef.set({
            id: promptId,
            title,
            content,
            category: category || 'ê¸°íƒ€',
            llmModel: llmModel || 'ë¯¸ì§€ì •',
            llmMode: llmMode || 'ì¼ë°˜',
            userId: userId,
            userEmail: currentUser.email,
            currentVersion: 1, // ì´ˆê¸° ë²„ì „ (ìˆ«ìë¡œ ì €ì¥, í•˜ìœ„ í˜¸í™˜ì„± ìœ ì§€)
            isDeleted: false,
            isPublic: false,
            displayOrder: displayOrder, // ì¹´í…Œê³ ë¦¬ë³„ ìˆœì„œ
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });

          // ì´ˆê¸° ë²„ì „ì„ versions ì„œë¸Œì»¬ë ‰ì…˜ì— ì €ì¥
          const versionRef = promptRef.collection('versions').doc();
          await versionRef.set({
            id: versionRef.id,
            version: 'v1', // ë¬¸ìì—´ í˜•ì‹ìœ¼ë¡œ ì €ì¥
            title: title,
            content: content,
            category: category || 'ê¸°íƒ€',
            llmModel: llmModel || 'ë¯¸ì§€ì •',
            llmMode: llmMode || 'ì¼ë°˜',
            changelog: 'ì´ˆê¸° ë²„ì „ ìƒì„±', // í•„ìˆ˜ í•„ë“œ ì¶”ê°€
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            createdBy: userId
          });

          showSuccess('í”„ë¡¬í”„íŠ¸ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
          elements.promptForm.innerHTML = '';
          
          // ëª¨ë“  íƒ­ìš© ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
          await loadPromptsForAllTabs();
          
          // ì €ì¥ëœ í”„ë¡¬í”„íŠ¸ë¥¼ ë°”ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì‚¬ìš© íƒ­ìœ¼ë¡œ ì „í™˜
          // ì‚¬ìš©ìì—ê²Œ ì„ íƒê¶Œ ì œê³µ: ì‚¬ìš© íƒ­ìœ¼ë¡œ ì´ë™í•˜ê±°ë‚˜ ë“±ë¡ íƒ­ì— ìœ ì§€
          const useNow = confirm('í”„ë¡¬í”„íŠ¸ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!\n\në°”ë¡œ ì‚¬ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
          if (useNow) {
            switchTab('use');
            // ì €ì¥ëœ í”„ë¡¬í”„íŠ¸ì˜ ì¹´í…Œê³ ë¦¬ë¥¼ ì°¾ì•„ì„œ ì„ íƒ
            setTimeout(() => {
              const savedPrompt = allPrompts.find(p => p.id === promptId);
              if (savedPrompt && elements.categorySelectDropdown) {
                const category = savedPrompt.category || 'ê¸°íƒ€';
                elements.categorySelectDropdown.value = category;
                handleCategorySelect();
                
                // ì¹´í…Œê³ ë¦¬ ë¡œë“œ í›„ í”„ë¡¬í”„íŠ¸ ì„ íƒ
                setTimeout(() => {
                  selectPromptForUse(promptId);
                }, 200);
              }
            }, 300);
          }
        } catch (error) {
          console.error('ì €ì¥ ì‹¤íŒ¨:', error);
          showError('í”„ë¡¬í”„íŠ¸ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        } finally {
          hideLoading();
        }
      };

      // í”„ë¡¬í”„íŠ¸ ì·¨ì†Œ
      window.cancelPrompt = function () {
        elements.promptForm.innerHTML = '';
      };

      // ëª¨ë“  íƒ­ìš© í”„ë¡¬í”„íŠ¸ ë¡œë“œ (ê³µí†µ)
      let allPrompts = [];

      async function loadPromptsForAllTabs() {
        if (!currentUser) return;

        try {
          const userId = currentUser.uid;
          const snapshot = await db
            .collection('users')
            .doc(userId)
            .collection('prompts')
            .where('isDeleted', '==', false)
            .orderBy('createdAt', 'desc')
            .get();

          allPrompts = [];
          snapshot.forEach((doc) => {
            allPrompts.push({
              id: doc.id,
              ...doc.data()
            });
          });

          // í˜„ì¬ íƒ­ì— ë§ê²Œ ë°ì´í„° í‘œì‹œ
          if (currentTab === 'use') {
            loadPromptsForUse();
          } else if (currentTab === 'search') {
            loadPromptsForSearch();
          }
        } catch (error) {
          console.error('í”„ë¡¬í”„íŠ¸ ë¡œë“œ ì‹¤íŒ¨:', error);
          handleLoadError(error);
        }
      }

      // ì»¤ìŠ¤í…€ ë“œë¡­ë‹¤ìš´ ì„¤ì • í•¨ìˆ˜
      function setupCustomDropdown(selectId) {
        const select = document.getElementById(selectId);
        if (!select) return;

        // ì´ë¯¸ ë˜í•‘ë˜ì—ˆëŠ”ì§€ í™•ì¸
        let wrapper = select.parentElement.querySelector('.custom-select-wrapper');
        if (wrapper) {
          // ì´ë¯¸ ë˜í•‘ë˜ì—ˆë‹¤ë©´ ì˜µì…˜ë§Œ ì—…ë°ì´íŠ¸
          updateCustomOptions(select, wrapper);
          return;
        }

        // ë˜í¼ ìƒì„±
        wrapper = document.createElement('div');
        wrapper.className = 'custom-select-wrapper';
        select.parentNode.insertBefore(wrapper, select);
        wrapper.appendChild(select);

        // íŠ¸ë¦¬ê±° ìƒì„±
        const trigger = document.createElement('div');
        trigger.className = 'custom-select-trigger';
        trigger.textContent = select.options[select.selectedIndex]?.text || 'ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”...';
        wrapper.appendChild(trigger);

        // ì˜µì…˜ ì»¨í…Œì´ë„ˆ ìƒì„±
        const optionsContainer = document.createElement('div');
        optionsContainer.className = 'custom-select-options';
        wrapper.appendChild(optionsContainer);

        // ì˜µì…˜ ì±„ìš°ê¸°
        updateCustomOptions(select, wrapper);

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        trigger.addEventListener('click', (e) => {
          e.stopPropagation(); // ì¦‰ì‹œ ë‹«í˜ ë°©ì§€
          // ë‹¤ë¥¸ ì—´ë¦° ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
          document.querySelectorAll('.custom-select-wrapper.open').forEach(el => {
            if (el !== wrapper) el.classList.remove('open');
          });
          wrapper.classList.toggle('open');
        });

        // ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        document.addEventListener('click', (e) => {
          if (!wrapper.contains(e.target)) {
            wrapper.classList.remove('open');
          }
        });
      }

      // ì»¤ìŠ¤í…€ ì˜µì…˜ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
      function updateCustomOptions(select, wrapper) {
        const optionsContainer = wrapper.querySelector('.custom-select-options');
        const trigger = wrapper.querySelector('.custom-select-trigger');
        optionsContainer.innerHTML = '';

        Array.from(select.options).forEach(option => {
          if (option.value === '') return; // í”Œë ˆì´ìŠ¤í™€ë” ì œì™¸

          const customOption = document.createElement('div');
          customOption.className = 'custom-option';
          if (option.selected) customOption.classList.add('selected');
          customOption.textContent = option.text;
          customOption.dataset.value = option.value;

          customOption.addEventListener('click', (e) => {
            e.stopPropagation();
            select.value = option.value;
            trigger.textContent = option.text;
            
            // ì„ íƒ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
            wrapper.querySelectorAll('.custom-option').forEach(el => el.classList.remove('selected'));
            customOption.classList.add('selected');
            
            wrapper.classList.remove('open');
            
            // ë„¤ì´í‹°ë¸Œ selectì— change ì´ë²¤íŠ¸ íŠ¸ë¦¬ê±°
            const event = new Event('change');
            select.dispatchEvent(event);
          });

          optionsContainer.appendChild(customOption);
        });
        
        // íŠ¸ë¦¬ê±° í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
        const selectedOption = select.options[select.selectedIndex];
        if (selectedOption && selectedOption.value !== '') {
            trigger.textContent = selectedOption.text;
        } else {
            trigger.textContent = 'ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”...';
        }
      }

      // íƒ­ 2: í”„ë¡¬í”„íŠ¸ ì‚¬ìš©ìš© ë¡œë“œ
      async function loadPromptsForUse() {
        if (!elements.categorySelectDropdown) return;

        try {
          if (allPrompts.length === 0) {
            await loadPromptsForAllTabs();
          }

          // ì¹´í…Œê³ ë¦¬ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
          const categoryDropdown = elements.categorySelectDropdown;
          const currentCategory = categoryDropdown.value; // í˜„ì¬ ì„ íƒëœ ì¹´í…Œê³ ë¦¬ ì €ì¥
          
          // ê¸°ì¡´ ì¹´í…Œê³ ë¦¬ ì˜µì…˜ ì œê±° (ì²« ë²ˆì§¸ ì˜µì…˜ ì œì™¸)
          while (categoryDropdown.options.length > 1) {
            categoryDropdown.remove(1);
          }

          if (allPrompts.length === 0) {
            categoryDropdown.disabled = true;
            categoryDropdown.innerHTML = '<option value="">í”„ë¡¬í”„íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € í”„ë¡¬í”„íŠ¸ë¥¼ ë“±ë¡í•´ì£¼ì„¸ìš”.</option>';
            elements.promptCardsContainer.style.display = 'none';
            elements.executionPanel.innerHTML = '';
            return;
          }

          categoryDropdown.disabled = false;
          
          // ê³ ìœ í•œ ì¹´í…Œê³ ë¦¬ ëª©ë¡ ì¶”ì¶œ
          const categories = [...new Set(allPrompts.map(p => p.category || 'ê¸°íƒ€'))].sort();
          
          // ì¹´í…Œê³ ë¦¬ ì˜µì…˜ ì¶”ê°€
          categories.forEach((category) => {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            categoryDropdown.appendChild(option);
          });

          // ì´ì „ì— ì„ íƒëœ ì¹´í…Œê³ ë¦¬ê°€ ìˆìœ¼ë©´ ë³µì›
          if (currentCategory && categories.includes(currentCategory)) {
            categoryDropdown.value = currentCategory;
            handleCategorySelect();
          } else {
            // ì„ íƒ ì´ˆê¸°í™”
            categoryDropdown.value = '';
            elements.promptCardsContainer.style.display = 'none';
            elements.executionPanel.innerHTML = '';
          }

          // ì»¤ìŠ¤í…€ ë“œë¡­ë‹¤ìš´ ì ìš© (ìµœìƒë‹¨ ë ˆì´ì–´ ë³´ì¥)
          setupCustomDropdown('category-select-dropdown');
        } catch (error) {
          console.error('í”„ë¡¬í”„íŠ¸ ì‚¬ìš© ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
          if (elements.categorySelectDropdown) {
            elements.categorySelectDropdown.innerHTML = '<option value="">í”„ë¡¬í”„íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</option>';
            elements.categorySelectDropdown.disabled = true;
          }
        }
      }

      // ì¹´í…Œê³ ë¦¬ ì„ íƒ ì²˜ë¦¬
      function handleCategorySelect() {
        const selectedCategory = elements.categorySelectDropdown.value;
        
        // ì‹¤í–‰ íŒ¨ë„ ì´ˆê¸°í™”
        elements.executionPanel.innerHTML = '';

        if (!selectedCategory) {
          elements.promptCardsContainer.style.display = 'none';
          return;
        }

        // ì„ íƒí•œ ì¹´í…Œê³ ë¦¬ì— ì†í•œ í”„ë¡¬í”„íŠ¸ í•„í„°ë§ (ì‚¬ìš©ì ì •ì˜ ìˆœì„œ ê¸°ì¤€ ì •ë ¬)
        const categoryPrompts = allPrompts
          .filter(p => (p.category || 'ê¸°íƒ€') === selectedCategory)
          .sort((a, b) => {
            // displayOrderê°€ ìˆìœ¼ë©´ ê·¸ê²ƒì„ ìš°ì„  ì‚¬ìš©, ì—†ìœ¼ë©´ createdAt ì‚¬ìš©
            const aOrder = a.displayOrder !== undefined ? a.displayOrder : 999999;
            const bOrder = b.displayOrder !== undefined ? b.displayOrder : 999999;
            
            if (aOrder !== bOrder) {
              return aOrder - bOrder;
            }
            
            // displayOrderê°€ ê°™ê±°ë‚˜ ë‘˜ ë‹¤ ì—†ìœ¼ë©´ createdAt ê¸°ì¤€ (ì˜¤ë˜ëœ ê²ƒë¶€í„°)
            const aTime = a.createdAt?.toDate ? a.createdAt.toDate().getTime() : (a.createdAt?.seconds || 0) * 1000;
            const bTime = b.createdAt?.toDate ? b.createdAt.toDate().getTime() : (b.createdAt?.seconds || 0) * 1000;
            return aTime - bTime;
          });

        if (categoryPrompts.length === 0) {
          elements.promptCardsContainer.style.display = 'none';
          elements.promptCardsGrid.innerHTML = '<p style="text-align: center; padding: 40px; color: #999;">ì„ íƒí•œ ì¹´í…Œê³ ë¦¬ì— í”„ë¡¬í”„íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
          return;
        }

        // í”„ë¡¬í”„íŠ¸ ì¹´ë“œ ê·¸ë¦¬ë“œ í‘œì‹œ
        elements.promptCardsContainer.style.display = 'block';
        
        // ì¹´ë“œ ìƒì„±
        let cardsHtml = '';
        categoryPrompts.forEach((prompt, index) => {
          const orderNumber = index + 1;
          const isFirst = index === 0;
          const isLast = index === categoryPrompts.length - 1;
          cardsHtml += `
            <div 
              class="prompt-card" 
              data-prompt-id="${prompt.id}"
              data-prompt-index="${index}"
              onclick="selectPromptForUse('${prompt.id}')"
              style="
                border: 2px solid #e1e5e9; 
                border-radius: 12px; 
                padding: 20px; 
                background: #f8f9fa;
                cursor: pointer;
                transition: all 0.2s;
                position: relative;
              "
              onmouseover="this.style.borderColor='#667eea'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.2)';"
              onmouseout="if(!this.classList.contains('selected')) { this.style.borderColor='#e1e5e9'; this.style.transform='translateY(0)'; this.style.boxShadow='none'; }"
            >
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                <div style="display: flex; align-items: center; gap: 8px; flex: 1;">
                  <span style="
                    background: #667eea; 
                    color: white; 
                    width: 28px; 
                    height: 28px; 
                    border-radius: 50%; 
                    display: flex; 
                    align-items: center; 
                    justify-content: center; 
                    font-size: 12px; 
                    font-weight: 600;
                    flex-shrink: 0;
                  ">${orderNumber}</span>
                  <h3 style="font-size: 18px; color: #333; margin: 0; flex: 1;">${escapeHtml(prompt.title)}</h3>
                </div>
                <div style="display: flex; flex-direction: column; gap: 4px; margin-left: 8px;" onclick="event.stopPropagation();">
                  <button 
                    onclick="movePromptOrder('${prompt.id}', '${selectedCategory}', 'up')"
                    ${isFirst ? 'disabled' : ''}
                    style="
                      width: 28px;
                      height: 28px;
                      border: 1px solid #e1e5e9;
                      border-radius: 6px;
                      background: ${isFirst ? '#f0f0f0' : 'white'};
                      color: ${isFirst ? '#999' : '#667eea'};
                      cursor: ${isFirst ? 'not-allowed' : 'pointer'};
                      display: flex;
                      align-items: center;
                      justify-content: center;
                      font-size: 14px;
                      transition: all 0.2s;
                    "
                    onmouseover="${isFirst ? '' : "this.style.background='#f0f4ff'; this.style.borderColor='#667eea';"}"
                    onmouseout="${isFirst ? '' : "this.style.background='white'; this.style.borderColor='#e1e5e9';"}"
                    title="ìœ„ë¡œ ì´ë™"
                  >â–²</button>
                  <button 
                    onclick="movePromptOrder('${prompt.id}', '${selectedCategory}', 'down')"
                    ${isLast ? 'disabled' : ''}
                    style="
                      width: 28px;
                      height: 28px;
                      border: 1px solid #e1e5e9;
                      border-radius: 6px;
                      background: ${isLast ? '#f0f0f0' : 'white'};
                      color: ${isLast ? '#999' : '#667eea'};
                      cursor: ${isLast ? 'not-allowed' : 'pointer'};
                      display: flex;
                      align-items: center;
                      justify-content: center;
                      font-size: 14px;
                      transition: all 0.2s;
                    "
                    onmouseover="${isLast ? '' : "this.style.background='#f0f4ff'; this.style.borderColor='#667eea';"}"
                    onmouseout="${isLast ? '' : "this.style.background='white'; this.style.borderColor='#e1e5e9';"}"
                    title="ì•„ë˜ë¡œ ì´ë™"
                  >â–¼</button>
                </div>
              </div>
              <p style="color: #666; line-height: 1.6; margin: 0; font-size: 14px; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;">
                ${escapeHtml(prompt.content.substring(0, 150))}${prompt.content.length > 150 ? '...' : ''}
              </p>
            </div>
          `;
        });
        
        elements.promptCardsGrid.innerHTML = cardsHtml;
      }

      // í”„ë¡¬í”„íŠ¸ ì„ íƒ ì²˜ë¦¬ (ì¹´ë“œ í´ë¦­ ì‹œ)
      window.selectPromptForUse = async function (id) {
        // ì„ íƒëœ í”„ë¡¬í”„íŠ¸ ì°¾ê¸°
        const prompt = allPrompts.find(p => p.id === id);
        
        if (!prompt) {
          showError('ì„ íƒí•œ í”„ë¡¬í”„íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }

        // ëª¨ë“  ì¹´ë“œì˜ ì„ íƒ ìƒíƒœ ì œê±°
        const allCards = document.querySelectorAll('.prompt-card');
        allCards.forEach(card => {
          card.classList.remove('selected');
          if (!card.classList.contains('selected')) {
            card.style.borderColor = '#e1e5e9';
            card.style.borderWidth = '2px';
            card.style.background = '#f8f9fa';
            card.style.boxShadow = 'none';
          }
        });

        // ì„ íƒëœ ì¹´ë“œ ê°•ì¡°
        const selectedCard = document.querySelector(`.prompt-card[data-prompt-id="${id}"]`);
        if (selectedCard) {
          // ì´ì „ ì„ íƒ ì œê±°
          document.querySelectorAll('.prompt-card').forEach(card => {
            card.classList.remove('selected');
          });
          
          selectedCard.classList.add('selected');
          selectedCard.style.borderColor = '#667eea';
          selectedCard.style.borderWidth = '3px';
          selectedCard.style.background = 'linear-gradient(135deg, #f8f9ff 0%, #f0f4ff 100%)';
          selectedCard.style.boxShadow = '0 4px 12px rgba(102, 126, 234, 0.3)';
        }

        // ë²„ì „ íˆìŠ¤í† ë¦¬ ë¡œë“œ
        const versions = await loadVersionHistory(prompt.id);
        
        // ì‹¤í–‰ íŒ¨ë„ì— í”„ë¡¬í”„íŠ¸ ì¦‰ì‹œ í‘œì‹œ (ë¡œë”© ì—†ì´)
        // currentVersionì´ ìˆ«ìë©´ ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ì—¬ ë¹„êµ
        let currentVersion = prompt.currentVersion || 1;
        let currentVersionStr = typeof currentVersion === 'number' ? 'v' + currentVersion : currentVersion;
        if (!currentVersionStr.startsWith('v')) {
          currentVersionStr = 'v' + currentVersionStr;
        }
        const versionInfo = versions.find(v => v.version === currentVersionStr);
        const versionDate = versionInfo?.createdAt ? 
          new Date(versionInfo.createdAt.toDate ? versionInfo.createdAt.toDate() : versionInfo.createdAt).toLocaleString('ko-KR') :
          (prompt.updatedAt ? new Date(prompt.updatedAt.toDate ? prompt.updatedAt.toDate() : prompt.updatedAt).toLocaleString('ko-KR') : 'ì•Œ ìˆ˜ ì—†ìŒ');

        elements.executionPanel.innerHTML = `
          <h2 style="font-size: 20px; margin-bottom: 16px; color: #333;">ğŸ“„ í”„ë¡¬í”„íŠ¸ ìƒì„¸</h2>
          <div style="margin-top: 20px; border: 2px solid #667eea; border-radius: 12px; padding: 24px; background: #f8f9fa;">
            <div style="margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center; gap: 12px; flex-wrap: wrap;">
              <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                <span style="background: #667eea; color: white; padding: 6px 16px; border-radius: 12px; font-size: 13px;">${escapeHtml(prompt.category)}</span>
                <span style="background: #f97316; color: white; padding: 6px 16px; border-radius: 12px; font-size: 13px;">LLM: ${escapeHtml(prompt.llmModel || 'ë¯¸ì§€ì •')}</span>
                <span style="background: #0ea5e9; color: white; padding: 6px 16px; border-radius: 12px; font-size: 13px;">ëª¨ë“œ: ${escapeHtml(prompt.llmMode || 'ì¼ë°˜')}</span>
              </div>
              <span style="background: #28a745; color: white; padding: 6px 16px; border-radius: 12px; font-size: 13px; font-weight: 600;">ë²„ì „ ${currentVersionStr}</span>
            </div>
            <h3 style="font-size: 24px; margin-bottom: 16px; color: #333;">${escapeHtml(prompt.title)}</h3>
            <div style="background: white; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
              <p style="color: #666; line-height: 1.8; white-space: pre-wrap; margin: 0;">${escapeHtml(prompt.content)}</p>
            </div>
            <div style="display: flex; gap: 8px; margin-top: 16px; flex-wrap: wrap;">
              <button onclick="copyPromptToClipboard('${prompt.id}')" class="btn-primary" style="padding: 10px 20px; font-size: 14px;">ğŸ“‹ í´ë¦½ë³´ë“œì— ë³µì‚¬</button>
              <button onclick="viewPromptInSearch('${prompt.id}')" class="btn-secondary" style="padding: 10px 20px; font-size: 14px;">ğŸ” ê²€ìƒ‰ íƒ­ì—ì„œ ë³´ê¸°</button>
              <button onclick="editPrompt('${prompt.id}')" class="btn-secondary" style="padding: 10px 20px; font-size: 14px;">âœï¸ ìˆ˜ì •í•˜ê¸°</button>
            </div>
            <div style="margin-top: 24px; padding-top: 16px; border-top: 1px solid #e1e5e9;">
              <div style="color: #999; font-size: 13px; margin-bottom: 12px;">
                í˜„ì¬ ë²„ì „ ìƒì„±ì¼: ${versionDate}
              </div>
              ${versions.length > 1 ? `
                <div style="margin-top: 16px;">
                  <button 
                    onclick="toggleVersionHistory('${prompt.id}')" 
                    class="btn-secondary" 
                    style="padding: 8px 16px; font-size: 13px; width: 100%;"
                    id="version-history-toggle-${prompt.id}"
                  >
                    ğŸ“œ ì´ì „ ë²„ì „ ë³´ê¸° (${versions.filter(v => {
                      const vNum = parseInt(v.version.replace('v', '')) || 0;
                      const currentNum = typeof currentVersion === 'number' ? currentVersion : parseInt(currentVersionStr.replace('v', '')) || 1;
                      return vNum < currentNum;
                    }).length}ê°œ)
                  </button>
                  <div id="version-history-${prompt.id}" style="display: none; margin-top: 16px;">
                    ${renderVersionHistory(prompt.id, versions.filter(v => {
                      const vNum = parseInt(v.version.replace('v', '')) || 0;
                      const currentNum = typeof currentVersion === 'number' ? currentVersion : parseInt(currentVersionStr.replace('v', '')) || 1;
                      return vNum < currentNum;
                    }))}
                  </div>
                </div>
              ` : ''}
            </div>
          </div>
        `;
        
        // ì‹¤í–‰ íŒ¨ë„ë¡œ ìŠ¤í¬ë¡¤
        elements.executionPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }

      // ë²„ì „ íˆìŠ¤í† ë¦¬ ë¡œë“œ
      async function loadVersionHistory(promptId) {
        try {
          const userId = currentUser.uid;
          const versionsSnapshot = await db
            .collection('users')
            .doc(userId)
            .collection('prompts')
            .doc(promptId)
            .collection('versions')
            .orderBy('version', 'desc')
            .get();

          const versions = [];
          versionsSnapshot.forEach((doc) => {
            versions.push({
              id: doc.id,
              ...doc.data()
            });
          });

          return versions;
        } catch (error) {
          console.error('ë²„ì „ íˆìŠ¤í† ë¦¬ ë¡œë“œ ì‹¤íŒ¨:', error);
          return [];
        }
      }

      // ë²„ì „ íˆìŠ¤í† ë¦¬ ë Œë”ë§
      function renderVersionHistory(promptId, versions) {
        if (versions.length === 0) return '';

        let html = '<div style="display: flex; flex-direction: column; gap: 12px;">';
        versions.forEach((version) => {
          const versionDate = version.createdAt ? 
            new Date(version.createdAt.toDate ? version.createdAt.toDate() : version.createdAt).toLocaleString('ko-KR') :
            'ì•Œ ìˆ˜ ì—†ìŒ';
          
          html += `
            <div style="border: 1px solid #e1e5e9; border-radius: 8px; padding: 16px; background: white;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <span style="background: #6c757d; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">ë²„ì „ ${version.version}</span>
                <span style="color: #999; font-size: 12px;">${versionDate}</span>
              </div>
              <div style="margin-bottom: 8px;">
                <strong style="color: #333; font-size: 14px;">${escapeHtml(version.title)}</strong>
              </div>
              <div style="margin-bottom: 8px; display: flex; gap: 8px; flex-wrap: wrap;">
                <span style="background: #f97316; color: white; padding: 4px 10px; border-radius: 10px; font-size: 12px;">LLM: ${escapeHtml(version.llmModel || 'ë¯¸ì§€ì •')}</span>
                <span style="background: #0ea5e9; color: white; padding: 4px 10px; border-radius: 10px; font-size: 12px;">ëª¨ë“œ: ${escapeHtml(version.llmMode || 'ì¼ë°˜')}</span>
              </div>
              <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; max-height: 200px; overflow-y: auto;">
                <p style="color: #666; line-height: 1.6; white-space: pre-wrap; margin: 0; font-size: 13px;">${escapeHtml(version.content)}</p>
              </div>
            </div>
          `;
        });
        html += '</div>';
        return html;
      }

      // ë²„ì „ íˆìŠ¤í† ë¦¬ í† ê¸€ (ì‚¬ìš© íƒ­)
      window.toggleVersionHistory = function (promptId) {
        const historyDiv = document.getElementById(`version-history-${promptId}`);
        const toggleBtn = document.getElementById(`version-history-toggle-${promptId}`);
        
        if (historyDiv && toggleBtn) {
          if (historyDiv.style.display === 'none') {
            historyDiv.style.display = 'block';
            toggleBtn.textContent = 'ğŸ“œ ì´ì „ ë²„ì „ ìˆ¨ê¸°ê¸°';
          } else {
            historyDiv.style.display = 'none';
            toggleBtn.textContent = 'ğŸ“œ ì´ì „ ë²„ì „ ë³´ê¸°';
          }
        }
      };

      // ë²„ì „ íˆìŠ¤í† ë¦¬ í† ê¸€ (ê²€ìƒ‰ íƒ­)
      window.toggleVersionHistoryInSearch = function (promptId) {
        const historyDiv = document.getElementById(`version-history-search-${promptId}`);
        const toggleBtn = document.getElementById(`version-history-toggle-search-${promptId}`);
        
        if (historyDiv && toggleBtn) {
          if (historyDiv.style.display === 'none') {
            historyDiv.style.display = 'block';
            toggleBtn.textContent = 'ğŸ“œ ì´ì „ ë²„ì „ ìˆ¨ê¸°ê¸°';
          } else {
            historyDiv.style.display = 'none';
            toggleBtn.textContent = 'ğŸ“œ ì´ì „ ë²„ì „ ë³´ê¸°';
          }
        }
      };

      // í”„ë¡¬í”„íŠ¸ ìˆœì„œ ë³€ê²½
      window.movePromptOrder = async function (promptId, category, direction) {
        try {
          // í˜„ì¬ ì¹´í…Œê³ ë¦¬ì˜ í”„ë¡¬í”„íŠ¸ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
          const categoryPrompts = allPrompts
            .filter(p => (p.category || 'ê¸°íƒ€') === category)
            .sort((a, b) => {
              const aOrder = a.displayOrder !== undefined ? a.displayOrder : 999999;
              const bOrder = b.displayOrder !== undefined ? b.displayOrder : 999999;
              if (aOrder !== bOrder) return aOrder - bOrder;
              const aTime = a.createdAt?.toDate ? a.createdAt.toDate().getTime() : (a.createdAt?.seconds || 0) * 1000;
              const bTime = b.createdAt?.toDate ? b.createdAt.toDate().getTime() : (b.createdAt?.seconds || 0) * 1000;
              return aTime - bTime;
            });

          const currentIndex = categoryPrompts.findIndex(p => p.id === promptId);
          if (currentIndex === -1) return;

          let newIndex;
          if (direction === 'up' && currentIndex > 0) {
            newIndex = currentIndex - 1;
          } else if (direction === 'down' && currentIndex < categoryPrompts.length - 1) {
            newIndex = currentIndex + 1;
          } else {
            return; // ì´ë™ ë¶ˆê°€ëŠ¥
          }

          // ë‘ í”„ë¡¬í”„íŠ¸ì˜ displayOrder êµí™˜
          const currentPrompt = categoryPrompts[currentIndex];
          const targetPrompt = categoryPrompts[newIndex];

          const userId = currentUser.uid;
          const batch = db.batch();

          // í˜„ì¬ í”„ë¡¬í”„íŠ¸ì˜ displayOrderë¥¼ ëŒ€ìƒ í”„ë¡¬í”„íŠ¸ì˜ displayOrderë¡œ ë³€ê²½
          const currentRef = db.collection('users').doc(userId).collection('prompts').doc(currentPrompt.id);
          const currentOrder = currentPrompt.displayOrder !== undefined ? currentPrompt.displayOrder : currentIndex;
          const targetOrder = targetPrompt.displayOrder !== undefined ? targetPrompt.displayOrder : newIndex;

          batch.update(currentRef, {
            displayOrder: targetOrder,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });

          // ëŒ€ìƒ í”„ë¡¬í”„íŠ¸ì˜ displayOrderë¥¼ í˜„ì¬ í”„ë¡¬í”„íŠ¸ì˜ displayOrderë¡œ ë³€ê²½
          const targetRef = db.collection('users').doc(userId).collection('prompts').doc(targetPrompt.id);
          batch.update(targetRef, {
            displayOrder: currentOrder,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });

          await batch.commit();

          // ë¡œì»¬ ë°ì´í„° ì—…ë°ì´íŠ¸
          const currentPromptLocal = allPrompts.find(p => p.id === currentPrompt.id);
          const targetPromptLocal = allPrompts.find(p => p.id === targetPrompt.id);
          if (currentPromptLocal) currentPromptLocal.displayOrder = targetOrder;
          if (targetPromptLocal) targetPromptLocal.displayOrder = currentOrder;

          // ì¹´ë“œ ë‹¤ì‹œ ë Œë”ë§
          handleCategorySelect();

          showSuccess('ìˆœì„œê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
        } catch (error) {
          console.error('ìˆœì„œ ë³€ê²½ ì‹¤íŒ¨:', error);
          showError('ìˆœì„œ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }
      };

      // íƒ­ 3: í”„ë¡¬í”„íŠ¸ ê²€ìƒ‰ìš© ë¡œë“œ
      async function loadPromptsForSearch() {
        if (!elements.promptSearchResults) return;

        try {
          if (allPrompts.length === 0) {
            await loadPromptsForAllTabs();
          }

          // ê²€ìƒ‰ì–´ê°€ ì—†ìœ¼ë©´ ëª¨ë“  í”„ë¡¬í”„íŠ¸ í‘œì‹œ
          const searchQuery = elements.searchInput ? elements.searchInput.value.trim().toLowerCase() : '';
          let filteredPrompts = allPrompts;

          if (searchQuery) {
            filteredPrompts = allPrompts.filter(prompt => {
              const title = (prompt.title || '').toLowerCase();
              const content = (prompt.content || '').toLowerCase();
              const category = (prompt.category || '').toLowerCase();
              return title.includes(searchQuery) || content.includes(searchQuery) || category.includes(searchQuery);
            });
          }

          if (filteredPrompts.length === 0) {
            elements.promptSearchResults.innerHTML =
              '<p style="color: #999; text-align: center; padding: 40px;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
          }

          let html = '<div style="display: grid; gap: 16px;">';
          filteredPrompts.forEach((prompt) => {
            html += `
              <div style="border: 2px solid #e1e5e9; border-radius: 12px; padding: 20px; background: #f8f9fa;">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                  <h3 style="font-size: 18px; color: #333;">${escapeHtml(prompt.title)}</h3>
                  <span style="background: #667eea; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px;">${escapeHtml(prompt.category)}</span>
                </div>
                <p style="color: #666; line-height: 1.6; margin-bottom: 12px;">${escapeHtml(prompt.content.substring(0, 200))}${prompt.content.length > 200 ? '...' : ''}</p>
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                  <button onclick="viewPromptInSearch('${prompt.id}')" class="btn-primary" style="padding: 8px 16px; font-size: 13px;">ğŸ‘ï¸ ìƒì„¸ë³´ê¸°</button>
                  <button onclick="usePrompt('${prompt.id}')" class="btn-primary" style="padding: 8px 16px; font-size: 13px;">ğŸš€ ì‚¬ìš©í•˜ê¸°</button>
                  <button onclick="editPrompt('${prompt.id}')" class="btn-secondary" style="padding: 8px 16px; font-size: 13px;">âœï¸ ìˆ˜ì •</button>
                  <button onclick="deletePrompt('${prompt.id}')" class="btn-secondary" style="padding: 8px 16px; font-size: 13px;">ğŸ—‘ï¸ ì‚­ì œ</button>
                </div>
              </div>
            `;
          });
          html += '</div>';

          elements.promptSearchResults.innerHTML = html;
        } catch (error) {
          console.error('í”„ë¡¬í”„íŠ¸ ê²€ìƒ‰ ì‹¤íŒ¨:', error);
          elements.promptSearchResults.innerHTML =
            '<p style="color: #dc3545; text-align: center; padding: 40px;">ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
        }
      }

      // ê²€ìƒ‰ ì²˜ë¦¬
      function handleSearch() {
        if (currentTab === 'search') {
          loadPromptsForSearch();
        }
      }

      // ì—ëŸ¬ ì²˜ë¦¬ (ê³µí†µ)
      function handleLoadError(error) {
        const errorHtml = `
          <div style="color: #dc3545; text-align: center; padding: 40px; background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; margin: 20px;">
            <h3 style="color: #856404; margin-bottom: 16px;">âš ï¸ Firestore ì¸ë±ìŠ¤ê°€ í•„ìš”í•©ë‹ˆë‹¤</h3>
            <p style="color: #856404; margin-bottom: 16px;">
              í”„ë¡¬í”„íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ë ¤ë©´ Firestore ì¸ë±ìŠ¤ë¥¼ ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤.
            </p>
            <p style="color: #856404; margin-bottom: 16px; font-size: 14px;">
              <strong>í•´ê²° ë°©ë²•:</strong><br/>
              1. ì•„ë˜ ë§í¬ë¥¼ í´ë¦­í•˜ì—¬ ì¸ë±ìŠ¤ë¥¼ ìƒì„±í•˜ê±°ë‚˜<br/>
              2. Firebase Consoleì—ì„œ ì§ì ‘ ì¸ë±ìŠ¤ë¥¼ ìƒì„±í•˜ì„¸ìš”
            </p>
            ${error.message && error.message.includes('create it here') && error.message.includes('http') ? 
              `<a href="${error.message.match(/https:\/\/[^\s]+/)?.[0]}" target="_blank" 
                  style="display: inline-block; padding: 10px 20px; background: #007bff; color: white; text-decoration: none; border-radius: 5px; margin-top: 10px;">
                ì¸ë±ìŠ¤ ìƒì„±í•˜ê¸° (Firebase Console)
              </a>` : ''
            }
            <p style="color: #856404; margin-top: 16px; font-size: 12px;">
              ë˜ëŠ” í„°ë¯¸ë„ì—ì„œ ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”:<br/>
              <code style="background: #f8f9fa; padding: 4px 8px; border-radius: 4px;">firebase deploy --only firestore:indexes</code>
            </p>
          </div>
        `;
        
        if (elements.promptUseList) elements.promptUseList.innerHTML = errorHtml;
        if (elements.promptSearchResults) elements.promptSearchResults.innerHTML = errorHtml;
      }

      // í”„ë¡¬í”„íŠ¸ ì‚¬ìš©í•˜ê¸° (ë‹¤ë¥¸ íƒ­ì—ì„œ í˜¸ì¶œ ì‹œ)
      window.usePrompt = async function (id) {
        showLoading();

        try {
          // ë¡œì»¬ ìºì‹œì—ì„œ ë¨¼ì € ì°¾ê¸°
          let prompt = allPrompts.find(p => p.id === id);
          
          if (!prompt) {
            // Firestoreì—ì„œ ì§ì ‘ ê°€ì ¸ì˜¤ê¸°
            const userId = currentUser.uid;
            const doc = await db
              .collection('users')
              .doc(userId)
              .collection('prompts')
              .doc(id)
              .get();
              
            if (!doc.exists) {
              showError('í”„ë¡¬í”„íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
              return;
            }
            prompt = { id: doc.id, ...doc.data() };
          }

          // ì‚¬ìš© íƒ­ìœ¼ë¡œ ì „í™˜
          if (currentTab !== 'use') {
            switchTab('use', { skipReload: true });
          }

          // í•´ë‹¹ í”„ë¡¬í”„íŠ¸ì˜ ì¹´í…Œê³ ë¦¬ë¥¼ ì°¾ì•„ì„œ ì„ íƒ
          if (prompt && elements.categorySelectDropdown) {
            const category = prompt.category || 'ê¸°íƒ€';
            elements.categorySelectDropdown.value = category;
            handleCategorySelect();
            
            // ì¹´í…Œê³ ë¦¬ ë¡œë“œ í›„ í”„ë¡¬í”„íŠ¸ ì„ íƒ
            setTimeout(() => {
              selectPromptForUse(id);
            }, 100);
          }

          elements.executionPanel.scrollIntoView({ behavior: 'smooth' });
        } catch (error) {
          console.error('í”„ë¡¬í”„íŠ¸ ì‚¬ìš© ì‹¤íŒ¨:', error);
          showError('í”„ë¡¬í”„íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        } finally {
          hideLoading();
        }
      };

      // í”„ë¡¬í”„íŠ¸ ë³´ê¸° (ìƒì„¸ë³´ê¸°) - ê²€ìƒ‰ íƒ­ì—ì„œ ì‚¬ìš©
      window.viewPrompt = async function (id) {
        await viewPromptInSearch(id);
      };

      // ê²€ìƒ‰ íƒ­ì—ì„œ í”„ë¡¬í”„íŠ¸ ìƒì„¸ë³´ê¸°
      window.viewPromptInSearch = async function (id) {
        showLoading();

        try {
          // ë¡œì»¬ ìºì‹œì—ì„œ ë¨¼ì € ì°¾ê¸°
          let prompt = allPrompts.find(p => p.id === id);
          
          if (!prompt) {
            // Firestoreì—ì„œ ì§ì ‘ ê°€ì ¸ì˜¤ê¸°
            const userId = currentUser.uid;
            const doc = await db
              .collection('users')
              .doc(userId)
              .collection('prompts')
              .doc(id)
              .get();
              
            if (!doc.exists) {
              showError('í”„ë¡¬í”„íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
              return;
            }
            prompt = { id: doc.id, ...doc.data() };
          }

          // ê²€ìƒ‰ íƒ­ìœ¼ë¡œ ì „í™˜í•˜ì—¬ ìƒì„¸ë³´ê¸°
          if (currentTab !== 'search') {
            switchTab('search', { skipReload: true });
          }

          // ê²€ìƒ‰ì–´ë¥¼ í”„ë¡¬í”„íŠ¸ ì œëª©ìœ¼ë¡œ ì„¤ì •í•˜ì—¬ ê´€ë ¨ í”„ë¡¬í”„íŠ¸ë„ í•¨ê»˜ í‘œì‹œ
          if (elements.searchInput) {
            elements.searchInput.value = prompt.title;
          }

          // ë²„ì „ íˆìŠ¤í† ë¦¬ ë¡œë“œ
          const versions = await loadVersionHistory(prompt.id);
          // currentVersionì´ ìˆ«ìë©´ ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ì—¬ ë¹„êµ
          let currentVersion = prompt.currentVersion || 1;
          let currentVersionStr = typeof currentVersion === 'number' ? 'v' + currentVersion : currentVersion;
          if (!currentVersionStr.startsWith('v')) {
            currentVersionStr = 'v' + currentVersionStr;
          }
          const versionInfo = versions.find(v => v.version === currentVersionStr);
          const versionDate = versionInfo?.createdAt ? 
            new Date(versionInfo.createdAt.toDate ? versionInfo.createdAt.toDate() : versionInfo.createdAt).toLocaleString('ko-KR') :
            (prompt.updatedAt ? new Date(prompt.updatedAt.toDate ? prompt.updatedAt.toDate() : prompt.updatedAt).toLocaleString('ko-KR') : 'ì•Œ ìˆ˜ ì—†ìŒ');

          // ê²€ìƒ‰ ê²°ê³¼ ì˜ì—­ì— ìƒì„¸ ì •ë³´ í‘œì‹œ
          const detailHtml = `
            <div style="border: 2px solid #667eea; border-radius: 12px; padding: 24px; background: #f8f9fa; margin-bottom: 20px;">
              <div style="margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center; gap: 12px; flex-wrap: wrap;">
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                  <span style="background: #667eea; color: white; padding: 6px 16px; border-radius: 12px; font-size: 13px;">${escapeHtml(prompt.category)}</span>
                  <span style="background: #f97316; color: white; padding: 6px 16px; border-radius: 12px; font-size: 13px;">LLM: ${escapeHtml(prompt.llmModel || 'ë¯¸ì§€ì •')}</span>
                  <span style="background: #0ea5e9; color: white; padding: 6px 16px; border-radius: 12px; font-size: 13px;">ëª¨ë“œ: ${escapeHtml(prompt.llmMode || 'ì¼ë°˜')}</span>
                </div>
                <span style="background: #28a745; color: white; padding: 6px 16px; border-radius: 12px; font-size: 13px; font-weight: 600;">ë²„ì „ ${currentVersionStr}</span>
              </div>
              <h3 style="font-size: 24px; margin-bottom: 16px; color: #333;">${escapeHtml(prompt.title)}</h3>
              <div style="background: white; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                <p style="color: #666; line-height: 1.8; white-space: pre-wrap; margin: 0;">${escapeHtml(prompt.content)}</p>
              </div>
              <div style="display: flex; gap: 8px; margin-top: 16px; flex-wrap: wrap;">
                <button onclick="usePrompt('${prompt.id}')" class="btn-primary" style="padding: 10px 20px; font-size: 14px;">ğŸš€ ì‚¬ìš©í•˜ê¸°</button>
                <button onclick="copyPromptToClipboard('${prompt.id}')" class="btn-primary" style="padding: 10px 20px; font-size: 14px;">ğŸ“‹ í´ë¦½ë³´ë“œì— ë³µì‚¬</button>
                <button onclick="editPrompt('${prompt.id}')" class="btn-secondary" style="padding: 10px 20px; font-size: 14px;">âœï¸ ìˆ˜ì •í•˜ê¸°</button>
                <button onclick="deletePrompt('${prompt.id}')" class="btn-secondary" style="padding: 10px 20px; font-size: 14px;">ğŸ—‘ï¸ ì‚­ì œ</button>
              </div>
              <div style="margin-top: 24px; padding-top: 16px; border-top: 1px solid #e1e5e9;">
                <div style="color: #999; font-size: 13px; margin-bottom: 12px;">
                  í˜„ì¬ ë²„ì „ ìƒì„±ì¼: ${versionDate}
                </div>
                ${versions.length > 1 ? `
                  <div style="margin-top: 16px;">
                    <button 
                      onclick="toggleVersionHistoryInSearch('${prompt.id}')" 
                      class="btn-secondary" 
                      style="padding: 8px 16px; font-size: 13px; width: 100%;"
                      id="version-history-toggle-search-${prompt.id}"
                    >
                      ğŸ“œ ì´ì „ ë²„ì „ ë³´ê¸° (${versions.filter(v => {
                        const vNum = parseInt(v.version.replace('v', '')) || 0;
                        const currentNum = typeof currentVersion === 'number' ? currentVersion : parseInt(currentVersionStr.replace('v', '')) || 1;
                        return vNum < currentNum;
                      }).length}ê°œ)
                    </button>
                    <div id="version-history-search-${prompt.id}" style="display: none; margin-top: 16px;">
                      ${renderVersionHistory(prompt.id, versions.filter(v => {
                        const vNum = parseInt(v.version.replace('v', '')) || 0;
                        const currentNum = typeof currentVersion === 'number' ? currentVersion : parseInt(currentVersionStr.replace('v', '')) || 1;
                        return vNum < currentNum;
                      }))}
                    </div>
                  </div>
                ` : ''}
              </div>
            </div>
          `;
          
          // ê´€ë ¨ í”„ë¡¬í”„íŠ¸ ëª©ë¡ ë¡œë“œ (í˜„ì¬ í”„ë¡¬í”„íŠ¸ ì œì™¸)
          const searchQuery = elements.searchInput ? elements.searchInput.value.trim().toLowerCase() : '';
          let filteredPrompts = allPrompts.filter(p => p.id !== prompt.id);
          
          if (searchQuery) {
            filteredPrompts = filteredPrompts.filter(p => {
              const title = (p.title || '').toLowerCase();
              const content = (p.content || '').toLowerCase();
              const category = (p.category || '').toLowerCase();
              return title.includes(searchQuery) || content.includes(searchQuery) || category.includes(searchQuery);
            });
          }
          
          let listHtml = '';
          if (filteredPrompts.length > 0) {
            listHtml = '<h3 style="font-size: 18px; margin-bottom: 16px; color: #333;">ê´€ë ¨ í”„ë¡¬í”„íŠ¸</h3><div style="display: grid; gap: 16px;">';
            filteredPrompts.forEach((p) => {
              listHtml += `
                <div style="border: 2px solid #e1e5e9; border-radius: 12px; padding: 20px; background: #f8f9fa;">
                  <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                    <h3 style="font-size: 18px; color: #333;">${escapeHtml(p.title)}</h3>
                    <span style="background: #667eea; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px;">${escapeHtml(p.category)}</span>
                  </div>
                  <p style="color: #666; line-height: 1.6; margin-bottom: 12px;">${escapeHtml(p.content.substring(0, 200))}${p.content.length > 200 ? '...' : ''}</p>
                  <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <button onclick="viewPromptInSearch('${p.id}')" class="btn-primary" style="padding: 8px 16px; font-size: 13px;">ğŸ‘ï¸ ìƒì„¸ë³´ê¸°</button>
                    <button onclick="usePrompt('${p.id}')" class="btn-primary" style="padding: 8px 16px; font-size: 13px;">ğŸš€ ì‚¬ìš©í•˜ê¸°</button>
                    <button onclick="editPrompt('${p.id}')" class="btn-secondary" style="padding: 8px 16px; font-size: 13px;">âœï¸ ìˆ˜ì •</button>
                    <button onclick="deletePrompt('${p.id}')" class="btn-secondary" style="padding: 8px 16px; font-size: 13px;">ğŸ—‘ï¸ ì‚­ì œ</button>
                  </div>
                </div>
              `;
            });
            listHtml += '</div>';
          }
          
          elements.promptSearchResults.innerHTML = detailHtml + listHtml;
        } catch (error) {
          console.error('í”„ë¡¬í”„íŠ¸ ì¡°íšŒ ì‹¤íŒ¨:', error);
          showError('í”„ë¡¬í”„íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        } finally {
          hideLoading();
        }
      };

      // í”„ë¡¬í”„íŠ¸ ìˆ˜ì • (ë“±ë¡ íƒ­ìœ¼ë¡œ ì´ë™í•˜ì—¬ ìˆ˜ì •)
      window.editPrompt = async function (id) {
        showLoading();

        try {
          // ë¡œì»¬ ìºì‹œì—ì„œ ë¨¼ì € ì°¾ê¸°
          let prompt = allPrompts.find(p => p.id === id);
          
          if (!prompt) {
            // Firestoreì—ì„œ ì§ì ‘ ê°€ì ¸ì˜¤ê¸°
            const userId = currentUser.uid;
            const doc = await db
              .collection('users')
              .doc(userId)
              .collection('prompts')
              .doc(id)
              .get();
              
            if (!doc.exists) {
              showError('í”„ë¡¬í”„íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
              return;
            }
            prompt = { id: doc.id, ...doc.data() };
          }

          // ë“±ë¡ íƒ­ìœ¼ë¡œ ì „í™˜
          switchTab('register');

          // ìˆ˜ì • í¼ í‘œì‹œ
          elements.promptForm.innerHTML = `
            <h2 style="font-size: 20px; margin-bottom: 16px; color: #333;">âœï¸ í”„ë¡¬í”„íŠ¸ ìˆ˜ì •</h2>
            <div style="display: flex; flex-direction: column; gap: 16px; margin-top: 20px;">
              <div>
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">ì œëª©</label>
                <input type="text" id="prompt-title-edit" value="${escapeHtml(prompt.title)}" placeholder="í”„ë¡¬í”„íŠ¸ ì œëª©" style="width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 15px;">
              </div>
              <div>
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">ë‚´ìš©</label>
                <textarea id="prompt-content-edit" placeholder="í”„ë¡¬í”„íŠ¸ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..." style="width: 100%; min-height: 150px; padding: 12px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 15px; resize: vertical;">${escapeHtml(prompt.content)}</textarea>
              </div>
              <div>
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">ì¹´í…Œê³ ë¦¬</label>
                <input type="text" id="prompt-category-edit" value="${escapeHtml(prompt.category || '')}" placeholder="ì˜ˆ: ì½”ë”©, ê¸€ì“°ê¸°, ë²ˆì—­" style="width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 15px;">
              </div>
              ${renderLlmModelField({ selectId: 'llm-model-select-edit', customInputId: 'llm-model-custom-edit' })}
              ${renderLlmModeField({ inputId: 'llm-mode-input-edit' })}
              <div style="display: flex; gap: 12px;">
                <button onclick="updatePrompt('${prompt.id}')" class="btn-primary" style="flex: 1;">ğŸ’¾ ìˆ˜ì • ì €ì¥</button>
                <button onclick="cancelPrompt()" class="btn-secondary" style="flex: 1;">âŒ ì·¨ì†Œ</button>
              </div>
            </div>
          `;
          elements.promptForm.scrollIntoView({ behavior: 'smooth' });
          setupLlmModelSelector({
            selectId: 'llm-model-select-edit',
            customInputId: 'llm-model-custom-edit',
            initialValue: prompt.llmModel || llmModelOptions[0].value
          });
          setLlmModeValue('llm-mode-input-edit', prompt.llmMode || 'ì¼ë°˜');
        } catch (error) {
          console.error('í”„ë¡¬í”„íŠ¸ ìˆ˜ì • í¼ ë¡œë“œ ì‹¤íŒ¨:', error);
          showError('í”„ë¡¬í”„íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        } finally {
          hideLoading();
        }
      };

      // í”„ë¡¬í”„íŠ¸ ìˆ˜ì • ì €ì¥
      window.updatePrompt = async function (id) {
        const title = document.getElementById('prompt-title-edit').value.trim();
        const content = document.getElementById('prompt-content-edit').value.trim();
        const category = document.getElementById('prompt-category-edit').value.trim();
        const llmModel = getSelectedLlmModel('llm-model-select-edit', 'llm-model-custom-edit');
        const llmMode = getLlmModeValue('llm-mode-input-edit');

        if (!title || !content) {
          showError('ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }

        showLoading();

        try {
          const userId = currentUser.uid;
          const promptRef = db.collection('users').doc(userId).collection('prompts').doc(id);
          
          // í˜„ì¬ í”„ë¡¬í”„íŠ¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
          const currentPrompt = await promptRef.get();
          if (!currentPrompt.exists) {
            showError('í”„ë¡¬í”„íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
          }

          const currentData = currentPrompt.data();
          // currentVersionì´ ìˆ«ìë©´ ë¬¸ìì—´ë¡œ ë³€í™˜, ì´ë¯¸ ë¬¸ìì—´ì´ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©
          let currentVersionStr = currentData.currentVersion;
          if (typeof currentVersionStr === 'number') {
            currentVersionStr = 'v' + currentVersionStr;
          } else if (!currentVersionStr) {
            currentVersionStr = 'v1';
          }
          
          // ë²„ì „ ë²ˆí˜¸ ì¶”ì¶œ (v1 -> 1, v2 -> 2)
          const currentVersionNum = parseInt(currentVersionStr.replace('v', '')) || 1;
          const newVersionNum = currentVersionNum + 1;
          const newVersionStr = 'v' + newVersionNum;

          // í˜„ì¬ ë²„ì „ì´ versionsì— ì—†ìœ¼ë©´ ì €ì¥ (ì¤‘ë³µ ë°©ì§€)
          const currentVersionSnapshot = await promptRef
            .collection('versions')
            .where('version', '==', currentVersionStr)
            .get();
          
          if (currentVersionSnapshot.empty) {
            // í˜„ì¬ ë²„ì „ì„ versions ì„œë¸Œì»¬ë ‰ì…˜ì— ì €ì¥ (íˆìŠ¤í† ë¦¬ ë³´ê´€)
            const versionRef = promptRef.collection('versions').doc();
            await versionRef.set({
              id: versionRef.id,
              version: currentVersionStr, // ë¬¸ìì—´ í˜•ì‹
              title: currentData.title,
              content: currentData.content,
              category: currentData.category || 'ê¸°íƒ€',
              llmModel: currentData.llmModel || 'ë¯¸ì§€ì •',
              llmMode: currentData.llmMode || 'ì¼ë°˜',
              changelog: 'ì´ì „ ë²„ì „ ë³´ê´€', // í•„ìˆ˜ í•„ë“œ ì¶”ê°€
              createdAt: currentData.updatedAt || currentData.createdAt,
              createdBy: userId
            });
          }

          // í”„ë¡¬í”„íŠ¸ ì—…ë°ì´íŠ¸ (ìƒˆ ë²„ì „ìœ¼ë¡œ - ìˆ«ìë¡œ ì €ì¥í•˜ì—¬ í•˜ìœ„ í˜¸í™˜ì„± ìœ ì§€)
          await promptRef.update({
            title,
            content,
            category: category || 'ê¸°íƒ€',
            llmModel: llmModel || 'ë¯¸ì§€ì •',
            llmMode: llmMode || 'ì¼ë°˜',
            currentVersion: newVersionNum, // ìˆ«ìë¡œ ì €ì¥ (í•˜ìœ„ í˜¸í™˜ì„±)
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });

          // ìƒˆ ë²„ì „ë„ versionsì— ì €ì¥
          const newVersionRef = promptRef.collection('versions').doc();
          await newVersionRef.set({
            id: newVersionRef.id,
            version: newVersionStr, // ë¬¸ìì—´ í˜•ì‹ (v2, v3 ë“±)
            title: title,
            content: content,
            category: category || 'ê¸°íƒ€',
            llmModel: llmModel || 'ë¯¸ì§€ì •',
            llmMode: llmMode || 'ì¼ë°˜',
            changelog: 'í”„ë¡¬í”„íŠ¸ ìˆ˜ì •', // í•„ìˆ˜ í•„ë“œ ì¶”ê°€
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            createdBy: userId
          });

          showSuccess(`í”„ë¡¬í”„íŠ¸ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤! (ë²„ì „ ${newVersionStr})`);
          elements.promptForm.innerHTML = '';
          
          // ëª¨ë“  íƒ­ìš© ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
          await loadPromptsForAllTabs();
          
          // ì‚¬ìš© íƒ­ì— ìˆ˜ì •ëœ í”„ë¡¬í”„íŠ¸ê°€ í‘œì‹œë˜ì–´ ìˆë‹¤ë©´ ê°±ì‹ 
          if (currentTab === 'use') {
            const selectedCard = document.querySelector('.prompt-card[data-prompt-id="' + id + '"]');
            if (selectedCard) {
              // ì¹´í…Œê³ ë¦¬ì™€ í”„ë¡¬í”„íŠ¸ ì„ íƒ ìƒíƒœ ìœ ì§€í•˜ë©´ì„œ ê°±ì‹ 
              const updatedPrompt = allPrompts.find(p => p.id === id);
              if (updatedPrompt) {
                const category = updatedPrompt.category || 'ê¸°íƒ€';
                // ì¹´í…Œê³ ë¦¬ê°€ ë³€ê²½ë˜ì—ˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ í™•ì¸
                if (elements.categorySelectDropdown.value !== category) {
                  elements.categorySelectDropdown.value = category;
                  handleCategorySelect();
                  setTimeout(() => {
                    selectPromptForUse(id);
                  }, 100);
                } else {
                  selectPromptForUse(id);
                }
              }
            }
          }
        } catch (error) {
          console.error('ìˆ˜ì • ì‹¤íŒ¨:', error);
          showError('í”„ë¡¬í”„íŠ¸ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        } finally {
          hideLoading();
        }
      };

      // í´ë¦½ë³´ë“œì— ë³µì‚¬
      window.copyPromptToClipboard = async function (id) {
        try {
          let prompt = allPrompts.find(p => p.id === id);
          
          if (!prompt) {
            const userId = currentUser.uid;
            const doc = await db
              .collection('users')
              .doc(userId)
              .collection('prompts')
              .doc(id)
              .get();
            if (doc.exists) {
              prompt = { id: doc.id, ...doc.data() };
            }
          }

          if (prompt) {
            await navigator.clipboard.writeText(prompt.content);
            showSuccess('í”„ë¡¬í”„íŠ¸ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
          }
        } catch (error) {
          console.error('ë³µì‚¬ ì‹¤íŒ¨:', error);
          showError('í´ë¦½ë³´ë“œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      };

      // í”„ë¡¬í”„íŠ¸ ì‚­ì œ (ì†Œí”„íŠ¸ ì‚­ì œ)
      window.deletePrompt = async function (id) {
        if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        showLoading();

        try {
          // Firestore ê·œì¹™ì— ë§ëŠ” ê²½ë¡œ ì‚¬ìš©: users/{userId}/prompts/{promptId}
          // ì†Œí”„íŠ¸ ì‚­ì œ: isDeleted = trueë¡œ ì„¤ì •
          const userId = currentUser.uid;
          await db
            .collection('users')
            .doc(userId)
            .collection('prompts')
            .doc(id)
            .update({
              isDeleted: true,
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
          showSuccess('í”„ë¡¬í”„íŠ¸ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
          
          // ëª¨ë“  íƒ­ìš© ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
          await loadPromptsForAllTabs();
          
          // í˜„ì¬ íƒ­ì´ ì‚¬ìš© íƒ­ì´ê³  ì‚­ì œëœ í”„ë¡¬í”„íŠ¸ê°€ ì‹¤í–‰ íŒ¨ë„ì— í‘œì‹œë˜ì–´ ìˆë‹¤ë©´ ì´ˆê¸°í™”
          if (currentTab === 'use' && elements.executionPanel) {
            const executionContent = elements.executionPanel.innerHTML;
            if (executionContent.includes(`'${id}'`)) {
              elements.executionPanel.innerHTML = '';
            }
          }
          
          // í˜„ì¬ íƒ­ì´ ê²€ìƒ‰ íƒ­ì´ê³  ê²€ìƒ‰ ê²°ê³¼ì— ì‚­ì œëœ í”„ë¡¬í”„íŠ¸ê°€ ìˆë‹¤ë©´ ê°±ì‹ 
          if (currentTab === 'search') {
            loadPromptsForSearch();
          }
        } catch (error) {
          console.error('ì‚­ì œ ì‹¤íŒ¨:', error);
          showError('í”„ë¡¬í”„íŠ¸ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        } finally {
          hideLoading();
        }
      };

      // UI í—¬í¼
      function showAuthSection() {
        elements.authSection.style.display = 'block';
        elements.mainContent.style.display = 'none';
      }

      function showMainContent() {
        elements.authSection.style.display = 'none';
        elements.mainContent.style.display = 'block';
        elements.userEmail.textContent = currentUser.email;
      }

      function showLoading() {
        elements.loading.style.display = 'flex';
      }

      function hideLoading() {
        elements.loading.style.display = 'none';
      }

      function showError(message) {
        alert('âŒ ' + message);
      }

      function showSuccess(message) {
        alert('âœ… ' + message);
      }

      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      function getErrorMessage(code) {
        const messages = {
          'auth/invalid-email': 'ì˜¬ë°”ë¥¸ ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.',
          'auth/user-disabled': 'ë¹„í™œì„±í™”ëœ ê³„ì •ì…ë‹ˆë‹¤.',
          'auth/user-not-found': 'ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê³„ì •ì…ë‹ˆë‹¤.',
          'auth/wrong-password': 'ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.',
          'auth/email-already-in-use': 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤.',
          'auth/weak-password': 'ë¹„ë°€ë²ˆí˜¸ê°€ ë„ˆë¬´ ì•½í•©ë‹ˆë‹¤. 6ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.',
          'auth/network-request-failed': 'ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.',
          'auth/popup-closed-by-user': 'ë¡œê·¸ì¸ ì°½ì´ ë‹«í˜”ìŠµë‹ˆë‹¤.',
          'auth/cancelled-popup-request': 'ë¡œê·¸ì¸ ìš”ì²­ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.',
          'auth/popup-blocked': 'íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.',
          'auth/operation-not-allowed': 'Google ë¡œê·¸ì¸ì´ í™œì„±í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. Firebase Consoleì—ì„œ í™œì„±í™”í•´ì£¼ì„¸ìš”.',
          'auth/unauthorized-domain': 'ìŠ¹ì¸ë˜ì§€ ì•Šì€ ë„ë©”ì¸ì…ë‹ˆë‹¤. Firebase Consoleì—ì„œ ë„ë©”ì¸ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.',
          'auth/account-exists-with-different-credential': 'ì´ ì´ë©”ì¼ì€ ë‹¤ë¥¸ ë¡œê·¸ì¸ ë°©ë²•ìœ¼ë¡œ ì´ë¯¸ ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤.',
          'auth/invalid-credential': 'ì¸ì¦ ì •ë³´ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.',
          'auth/too-many-requests': 'ë„ˆë¬´ ë§ì€ ìš”ì²­ì´ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'
        };
        return messages[code] || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
      }

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
      window.addEventListener('DOMContentLoaded', init);
    </script>
  </body>
</html>
