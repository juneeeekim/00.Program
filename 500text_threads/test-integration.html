<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google OAuth 통합 테스트</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            text-align: center;
        }
        
        .header h1 {
            color: #333;
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #666;
            font-size: 1.1rem;
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .test-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .test-section h2 {
            color: #667eea;
            font-size: 1.3rem;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .test-section p {
            color: #666;
            margin-bottom: 15px;
            line-height: 1.6;
        }
        
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 140px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #000;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        
        .result-box {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .result-box.success {
            border-left-color: #28a745;
            background: #d4edda;
            color: #155724;
        }
        
        .result-box.error {
            border-left-color: #dc3545;
            background: #f8d7da;
            color: #721c24;
        }
        
        .result-box.warning {
            border-left-color: #ffc107;
            background: #fff3cd;
            color: #856404;
        }
        
        .result-box.info {
            border-left-color: #17a2b8;
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .status-badge.pass {
            background: #d4edda;
            color: #155724;
        }
        
        .status-badge.fail {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status-badge.running {
            background: #fff3cd;
            color: #856404;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 15px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.5s ease;
        }
        
        .test-summary {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-top: 20px;
        }
        
        .test-summary h2 {
            color: #333;
            margin-bottom: 20px;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .summary-card {
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        
        .summary-card.total {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .summary-card.passed {
            background: #d4edda;
            color: #155724;
        }
        
        .summary-card.failed {
            background: #f8d7da;
            color: #721c24;
        }
        
        .summary-card.skipped {
            background: #e2e3e5;
            color: #383d41;
        }
        
        .summary-card h3 {
            font-size: 2.5rem;
            margin-bottom: 5px;
        }
        
        .summary-card p {
            font-size: 0.9rem;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🧪 Google OAuth 통합 테스트 Suite</h1>
            <p>Task 10.2: 전체 시스템 통합 테스트 - 모든 요구사항 검증</p>
        </div>
        
        <div class="test-grid">
            <!-- Test 1: 첫 Google 로그인 플로우 -->
            <div class="test-section">
                <h2>1️⃣ 첫 Google 로그인 플로우</h2>
                <p>신규 사용자의 Google 로그인 전체 프로세스를 테스트합니다.</p>
                <div class="button-group">
                    <button class="btn btn-primary" onclick="runTest1()">전체 테스트 실행</button>
                    <button class="btn btn-info" onclick="runTest1Step1()">1단계: 설정 검증</button>
                    <button class="btn btn-info" onclick="runTest1Step2()">2단계: 초기화</button>
                    <button class="btn btn-info" onclick="runTest1Step3()">3단계: 로그인</button>
                    <button class="btn btn-info" onclick="runTest1Step4()">4단계: 세션 유지</button>
                </div>
                <div id="test1-result" class="result-box" style="display: none;"></div>
            </div>
            
            <!-- Test 2: 마이그레이션 전체 프로세스 -->
            <div class="test-section">
                <h2>2️⃣ 데이터 마이그레이션 프로세스</h2>
                <p>기존 사용자 데이터를 Google 계정으로 안전하게 이전하는 전체 프로세스를 테스트합니다.</p>
                <div class="button-group">
                    <button class="btn btn-primary" onclick="runTest2()">전체 테스트 실행</button>
                    <button class="btn btn-info" onclick="runTest2Step1()">1단계: 감지</button>
                    <button class="btn btn-info" onclick="runTest2Step2()">2단계: 백업</button>
                    <button class="btn btn-info" onclick="runTest2Step3()">3단계: 이전</button>
                    <button class="btn btn-info" onclick="runTest2Step4()">4단계: 검증</button>
                    <button class="btn btn-warning" onclick="runTest2Rollback()">롤백 테스트</button>
                </div>
                <div id="test2-result" class="result-box" style="display: none;"></div>
            </div>
            
            <!-- Test 3: 토큰 만료 및 자동 갱신 -->
            <div class="test-section">
                <h2>3️⃣ 토큰 만료 및 자동 갱신</h2>
                <p>토큰 만료 감지 및 자동 갱신 메커니즘을 테스트합니다.</p>
                <div class="button-group">
                    <button class="btn btn-primary" onclick="runTest3()">전체 테스트 실행</button>
                    <button class="btn btn-info" onclick="runTest3Step1()">1단계: 토큰 검증</button>
                    <button class="btn btn-info" onclick="runTest3Step2()">2단계: 만료 시뮬레이션</button>
                    <button class="btn btn-info" onclick="runTest3Step3()">3단계: 자동 갱신</button>
                    <button class="btn btn-info" onclick="runTest3Step4()">4단계: 재스케줄링</button>
                </div>
                <div id="test3-result" class="result-box" style="display: none;"></div>
            </div>
            
            <!-- Test 4: 에러 복구 시나리오 -->
            <div class="test-section">
                <h2>4️⃣ 에러 복구 시나리오</h2>
                <p>다양한 에러 상황에서의 복구 메커니즘을 테스트합니다.</p>
                <div class="button-group">
                    <button class="btn btn-primary" onclick="runTest4()">전체 테스트 실행</button>
                    <button class="btn btn-warning" onclick="runTest4Config()">설정 오류</button>
                    <button class="btn btn-warning" onclick="runTest4Network()">네트워크 오류</button>
                    <button class="btn btn-warning" onclick="runTest4Auth()">인증 오류</button>
                    <button class="btn btn-warning" onclick="runTest4Token()">토큰 오류</button>
                </div>
                <div id="test4-result" class="result-box" style="display: none;"></div>
            </div>
            
            <!-- Test 5: 폴백 시스템 -->
            <div class="test-section">
                <h2>5️⃣ 폴백 시스템</h2>
                <p>Google OAuth 실패 시 폴백 시스템 작동을 테스트합니다.</p>
                <div class="button-group">
                    <button class="btn btn-primary" onclick="runTest5()">전체 테스트 실행</button>
                    <button class="btn btn-info" onclick="runTest5Offline()">오프라인 폴백</button>
                    <button class="btn btn-info" onclick="runTest5ConfigFail()">설정 실패 폴백</button>
                    <button class="btn btn-info" onclick="runTest5InitFail()">초기화 실패 폴백</button>
                    <button class="btn btn-success" onclick="runTest5Recovery()">복구 테스트</button>
                </div>
                <div id="test5-result" class="result-box" style="display: none;"></div>
            </div>
            
            <!-- Test 6: 보안 검증 -->
            <div class="test-section">
                <h2>6️⃣ 보안 검증</h2>
                <p>토큰 저장, XSS 방지, 데이터 검증 등 보안 기능을 테스트합니다.</p>
                <div class="button-group">
                    <button class="btn btn-primary" onclick="runTest6()">전체 테스트 실행</button>
                    <button class="btn btn-info" onclick="runTest6TokenStorage()">토큰 저장 검증</button>
                    <button class="btn btn-info" onclick="runTest6XSS()">XSS 방지</button>
                    <button class="btn btn-info" onclick="runTest6DataValidation()">데이터 검증</button>
                </div>
                <div id="test6-result" class="result-box" style="display: none;"></div>
            </div>
        </div>
        
        <!-- Test Summary -->
        <div class="test-summary">
            <h2>📊 테스트 결과 요약</h2>
            <div class="summary-grid">
                <div class="summary-card total">
                    <h3 id="total-tests">0</h3>
                    <p>전체 테스트</p>
                </div>
                <div class="summary-card passed">
                    <h3 id="passed-tests">0</h3>
                    <p>통과</p>
                </div>
                <div class="summary-card failed">
                    <h3 id="failed-tests">0</h3>
                    <p>실패</p>
                </div>
                <div class="summary-card skipped">
                    <h3 id="skipped-tests">0</h3>
                    <p>건너뜀</p>
                </div>
            </div>
            <div class="progress-bar">
                <div id="progress-fill" class="progress-fill" style="width: 0%"></div>
            </div>
            <div id="summary-details" class="result-box" style="margin-top: 20px;"></div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="config/auth-config.js"></script>
    <script src="js/security-utils.js"></script>
    <script src="js/error-handler.js"></script>
    <script src="js/activity-logger.js"></script>
    <script src="js/google-auth-manager.js"></script>
    <script src="js/data-migration-manager.js"></script>
    
    <script>
        // Test Suite State
        const testState = {
            total: 0,
            passed: 0,
            failed: 0,
            skipped: 0,
            results: []
        };
        
        // Initialize
        let authConfig, authManager, migrationManager, logger;
        
        document.addEventListener('DOMContentLoaded', () => {
            initializeTestSuite();
        });
        
        function initializeTestSuite() {
            try {
                authConfig = window.AUTH_CONFIG;
                logger = new ActivityLogger('test_user');
                authManager = new GoogleAuthManager(authConfig, logger);
                migrationManager = new DataMigrationManager(authConfig, logger);
                
                // Setup callbacks
                setupCallbacks();
                
                log('✅ 테스트 Suite 초기화 완료');
            } catch (error) {
                log('❌ 테스트 Suite 초기화 실패: ' + error.message, 'error');
            }
        }
        
        function setupCallbacks() {
            authManager.showMessage = (message, type) => {
                log(`[UI Message] ${message}`, type);
            };
            
            authManager.showSetupInstructions = () => {
                log('[Setup Instructions] 설정 안내 표시됨', 'info');
            };
            
            authManager.enableFallback = () => {
                log('[Fallback] 폴백 시스템 활성화됨', 'warning');
            };
        }
        
        // Utility Functions
        function log(message, type = 'info') {
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function showResult(testId, message, type = 'info') {
            const resultEl = document.getElementById(`${testId}-result`);
            if (resultEl) {
                resultEl.textContent = message;
                resultEl.className = `result-box ${type}`;
                resultEl.style.display = 'block';
            }
        }
        
        function updateTestStats(passed, failed = 0, skipped = 0) {
            testState.passed += passed;
            testState.failed += failed;
            testState.skipped += skipped;
            testState.total = testState.passed + testState.failed + testState.skipped;
            
            document.getElementById('total-tests').textContent = testState.total;
            document.getElementById('passed-tests').textContent = testState.passed;
            document.getElementById('failed-tests').textContent = testState.failed;
            document.getElementById('skipped-tests').textContent = testState.skipped;
            
            const progress = testState.total > 0 ? (testState.passed / testState.total) * 100 : 0;
            document.getElementById('progress-fill').style.width = progress + '%';
        }
        
        function addTestResult(testName, status, details) {
            testState.results.push({
                name: testName,
                status,
                details,
                timestamp: new Date().toISOString()
            });
            
            updateSummaryDetails();
        }
        
        function updateSummaryDetails() {
            const summaryEl = document.getElementById('summary-details');
            let html = '<strong>테스트 실행 기록:</strong>\n\n';
            
            testState.results.forEach((result, index) => {
                const icon = result.status === 'pass' ? '✅' : result.status === 'fail' ? '❌' : '⏭️';
                html += `${index + 1}. ${icon} ${result.name}\n`;
                if (result.details) {
                    html += `   ${result.details}\n`;
                }
            });
            
            summaryEl.textContent = html;
            summaryEl.style.display = 'block';
        }
        
        async function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        // ===== TEST 1: 첫 Google 로그인 플로우 =====
        async function runTest1() {
            showResult('test1', '테스트 1 실행 중...', 'info');
            
            try {
                await runTest1Step1();
                await sleep(1000);
                await runTest1Step2();
                await sleep(1000);
                
                showResult('test1', 
                    '✅ 테스트 1 완료\n\n' +
                    '1단계: 설정 검증 ✅\n' +
                    '2단계: OAuth 초기화 ✅\n' +
                    '3단계: 로그인 - 수동 테스트 필요\n' +
                    '4단계: 세션 유지 - 로그인 후 테스트 가능\n\n' +
                    '💡 실제 로그인을 테스트하려면 "3단계: 로그인" 버튼을 클릭하세요.',
                    'success'
                );
                
                addTestResult('Test 1: 첫 Google 로그인 플로우', 'pass', '설정 검증 및 초기화 완료');
                updateTestStats(1);
                
            } catch (error) {
                showResult('test1', `❌ 테스트 1 실패\n\n${error.message}`, 'error');
                addTestResult('Test 1: 첫 Google 로그인 플로우', 'fail', error.message);
                updateTestStats(0, 1);
            }
        }
        
        async function runTest1Step1() {
            log('Test 1.1: 설정 검증 시작');
            
            const isValid = authConfig.validateGoogleConfig();
            
            if (!isValid) {
                const error = authConfig.getValidationError();
                throw new Error(`설정 검증 실패: ${error.message}`);
            }
            
            log('✅ Test 1.1: 설정 검증 통과');
            showResult('test1', '✅ 1단계: 설정 검증 통과', 'success');
        }
        
        async function runTest1Step2() {
            log('Test 1.2: OAuth 초기화 시작');
            
            const initialized = await authManager.initialize();
            
            if (!initialized) {
                throw new Error('OAuth 초기화 실패');
            }
            
            log('✅ Test 1.2: OAuth 초기화 완료');
            showResult('test1', '✅ 2단계: OAuth 초기화 완료', 'success');
        }
        
        async function runTest1Step3() {
            log('Test 1.3: Google 로그인 시작');
            
            try {
                showResult('test1', '⏳ 3단계: Google 로그인 팝업 대기 중...', 'info');
                
                const userData = await authManager.signIn();
                
                log('✅ Test 1.3: 로그인 성공');
                showResult('test1', 
                    `✅ 3단계: 로그인 성공\n\n` +
                    `사용자: ${userData.name}\n` +
                    `이메일: ${userData.email}\n` +
                    `로그인 시간: ${new Date(userData.loginTime).toLocaleString()}`,
                    'success'
                );
                
                addTestResult('Test 1.3: Google 로그인', 'pass', `사용자: ${userData.email}`);
                updateTestStats(1);
                
            } catch (error) {
                log('❌ Test 1.3: 로그인 실패');
                showResult('test1', `❌ 3단계: 로그인 실패\n\n${error.message || error.error}`, 'error');
                addTestResult('Test 1.3: Google 로그인', 'fail', error.message || error.error);
                updateTestStats(0, 1);
            }
        }
        
        async function runTest1Step4() {
            log('Test 1.4: 세션 유지 확인');
            
            const isSignedIn = authManager.isSignedIn();
            const currentUser = authManager.getCurrentUser();
            
            if (!isSignedIn || !currentUser) {
                showResult('test1', '❌ 4단계: 세션 없음 - 먼저 로그인하세요', 'error');
                addTestResult('Test 1.4: 세션 유지', 'fail', '로그인되지 않음');
                updateTestStats(0, 1);
                return;
            }
            
            const tokenValid = authManager.validateToken();
            
            showResult('test1',
                `✅ 4단계: 세션 유지 확인\n\n` +
                `로그인 상태: ${isSignedIn ? '✅' : '❌'}\n` +
                `사용자: ${currentUser.name}\n` +
                `토큰 유효: ${tokenValid ? '✅' : '❌'}\n` +
                `만료 시간: ${new Date(currentUser.expiresAt).toLocaleString()}`,
                'success'
            );
            
            addTestResult('Test 1.4: 세션 유지', 'pass', '세션 정상 유지 중');
            updateTestStats(1);
        }
        
        // ===== TEST 2: 마이그레이션 전체 프로세스 =====
        async function runTest2() {
            showResult('test2', '테스트 2 실행 중...', 'info');
            
            try {
                // 테스트 데이터 생성
                createMigrationTestData();
                await sleep(500);
                
                await runTest2Step1();
                await sleep(500);
                await runTest2Step2();
                await sleep(500);
                await runTest2Step3();
                await sleep(500);
                await runTest2Step4();
                
                showResult('test2',
                    '✅ 테스트 2 완료\n\n' +
                    '1단계: 마이그레이션 감지 ✅\n' +
                    '2단계: 백업 생성 ✅\n' +
                    '3단계: 데이터 이전 ✅\n' +
                    '4단계: 데이터 검증 ✅\n\n' +
                    '모든 마이그레이션 단계가 성공적으로 완료되었습니다.',
                    'success'
                );
                
                addTestResult('Test 2: 데이터 마이그레이션', 'pass', '전체 프로세스 완료');
                updateTestStats(1);
                
            } catch (error) {
                showResult('test2', `❌ 테스트 2 실패\n\n${error.message}`, 'error');
                addTestResult('Test 2: 데이터 마이그레이션', 'fail', error.message);
                updateTestStats(0, 1);
            }
        }
        
        function createMigrationTestData() {
            const testUsername = 'test_migration_user';
            const testData = [
                {
                    id: Date.now(),
                    content: '마이그레이션 테스트 글 1',
                    date: new Date().toLocaleString(),
                    characterCount: 15,
                    type: 'reference'
                },
                {
                    id: Date.now() + 1,
                    content: '마이그레이션 테스트 글 2',
                    date: new Date().toLocaleString(),
                    characterCount: 15,
                    type: 'edit'
                }
            ];
            
            localStorage.setItem(`dualTextWriter_savedTexts_${testUsername}`, JSON.stringify(testData));
            localStorage.setItem('dualTextWriter_currentUser', testUsername);
            localStorage.setItem('dualTextWriter_authProvider', 'username');
            
            log('✅ 마이그레이션 테스트 데이터 생성 완료');
        }
        
        async function runTest2Step1() {
            log('Test 2.1: 마이그레이션 감지');
            
            const googleUserData = {
                email: 'test_migration@example.com',
                name: 'Test Migration User'
            };
            
            const migrationInfo = migrationManager.checkMigrationNeeded(googleUserData);
            
            if (!migrationInfo.needed) {
                throw new Error('마이그레이션이 필요하지 않음 (테스트 데이터 확인 필요)');
            }
            
            log('✅ Test 2.1: 마이그레이션 필요성 감지 완료');
            showResult('test2',
                `✅ 1단계: 마이그레이션 감지\n\n` +
                `기존 사용자: ${migrationInfo.oldUsername}\n` +
                `새 이메일: ${migrationInfo.newEmail}\n` +
                `데이터 개수: ${migrationInfo.dataCount}개`,
                'success'
            );
        }
        
        async function runTest2Step2() {
            log('Test 2.2: 백업 생성');
            
            const testUsername = 'test_migration_user';
            const userData = migrationManager.getExistingUserData(testUsername);
            const backup = migrationManager.createBackup(userData);
            
            if (!backup) {
                throw new Error('백업 생성 실패');
            }
            
            log('✅ Test 2.2: 백업 생성 완료');
            showResult('test2',
                `✅ 2단계: 백업 생성\n\n` +
                `백업 시간: ${new Date(backup.timestamp).toLocaleString()}\n` +
                `체크섬: ${backup.checksum}\n` +
                `데이터 개수: ${backup.data.savedTexts.length}개`,
                'success'
            );
        }
        
        async function runTest2Step3() {
            log('Test 2.3: 데이터 이전');
            
            const oldUsername = 'test_migration_user';
            const newEmail = 'test_migration@example.com';
            
            const result = await migrationManager.performMigration(oldUsername, newEmail);
            
            if (!result.success) {
                throw new Error('데이터 이전 실패');
            }
            
            log('✅ Test 2.3: 데이터 이전 완료');
            showResult('test2',
                `✅ 3단계: 데이터 이전\n\n` +
                `마이그레이션 ID: ${result.migrationRecord.migrationId}\n` +
                `이전된 데이터: ${result.migrationRecord.dataCount}개\n` +
                `완료 시간: ${new Date(result.migrationRecord.migratedAt).toLocaleString()}`,
                'success'
            );
        }
        
        async function runTest2Step4() {
            log('Test 2.4: 데이터 검증');
            
            const newEmail = 'test_migration@example.com';
            const migratedData = JSON.parse(
                localStorage.getItem(`dualTextWriter_savedTexts_${newEmail}`) || '[]'
            );
            
            if (migratedData.length === 0) {
                throw new Error('이전된 데이터가 없음');
            }
            
            log('✅ Test 2.4: 데이터 검증 완료');
            showResult('test2',
                `✅ 4단계: 데이터 검증\n\n` +
                `검증된 데이터: ${migratedData.length}개\n` +
                `데이터 무결성: ✅ 확인됨`,
                'success'
            );
        }
        
        async function runTest2Rollback() {
            log('Test 2.5: 롤백 테스트');
            
            try {
                const success = await migrationManager.rollbackMigration();
                
                if (!success) {
                    throw new Error('롤백 실패');
                }
                
                showResult('test2', '✅ 롤백 테스트 성공\n\n백업에서 데이터가 복원되었습니다.', 'success');
                addTestResult('Test 2.5: 마이그레이션 롤백', 'pass', '롤백 성공');
                updateTestStats(1);
                
            } catch (error) {
                showResult('test2', `❌ 롤백 테스트 실패\n\n${error.message}`, 'error');
                addTestResult('Test 2.5: 마이그레이션 롤백', 'fail', error.message);
                updateTestStats(0, 1);
            }
        }
        
        // ===== TEST 3: 토큰 만료 및 자동 갱신 =====
        async function runTest3() {
            showResult('test3', '테스트 3 실행 중...', 'info');
            
            try {
                await runTest3Step1();
                await sleep(1000);
                
                showResult('test3',
                    '✅ 테스트 3 부분 완료\n\n' +
                    '1단계: 토큰 검증 ✅\n' +
                    '2단계: 만료 시뮬레이션 - 수동 테스트 필요\n' +
                    '3단계: 자동 갱신 - 로그인 후 테스트 가능\n' +
                    '4단계: 재스케줄링 - 갱신 후 테스트 가능\n\n' +
                    '💡 실제 토큰 갱신을 테스트하려면 먼저 로그인하세요.',
                    'success'
                );
                
                addTestResult('Test 3: 토큰 관리', 'pass', '토큰 검증 완료');
                updateTestStats(1);
                
            } catch (error) {
                showResult('test3', `❌ 테스트 3 실패\n\n${error.message}`, 'error');
                addTestResult('Test 3: 토큰 관리', 'fail', error.message);
                updateTestStats(0, 1);
            }
        }
        
        async function runTest3Step1() {
            log('Test 3.1: 토큰 검증');
            
            const isSignedIn = authManager.isSignedIn();
            
            if (!isSignedIn) {
                log('⚠️ Test 3.1: 로그인되지 않음 (정상)');
                showResult('test3', 'ℹ️ 1단계: 로그인되지 않음\n\n토큰 검증을 위해 먼저 로그인하세요.', 'info');
                return;
            }
            
            const tokenValid = authManager.validateToken();
            const currentUser = authManager.getCurrentUser();
            
            log('✅ Test 3.1: 토큰 검증 완료');
            showResult('test3',
                `✅ 1단계: 토큰 검증\n\n` +
                `토큰 유효: ${tokenValid ? '✅' : '❌'}\n` +
                `만료 시간: ${new Date(currentUser.expiresAt).toLocaleString()}\n` +
                `남은 시간: ${Math.floor((currentUser.expiresAt - Date.now()) / 60000)}분`,
                'success'
            );
        }
        
        async function runTest3Step2() {
            log('Test 3.2: 토큰 만료 시뮬레이션');
            
            if (!authManager.tokenData) {
                showResult('test3', '❌ 2단계: 로그인되지 않음\n\n먼저 로그인하세요.', 'error');
                addTestResult('Test 3.2: 토큰 만료 시뮬레이션', 'fail', '로그인되지 않음');
                updateTestStats(0, 1);
                return;
            }
            
            const originalExpiry = authManager.tokenData.expiresAt;
            authManager.tokenData.expiresAt = Date.now() - 1000; // 과거로 설정
            
            const isExpired = !authManager.validateToken();
            
            showResult('test3',
                `✅ 2단계: 토큰 만료 시뮬레이션\n\n` +
                `원래 만료 시간: ${new Date(originalExpiry).toLocaleString()}\n` +
                `시뮬레이션 만료 시간: ${new Date(authManager.tokenData.expiresAt).toLocaleString()}\n` +
                `토큰 만료 확인: ${isExpired ? '✅' : '❌'}\n\n` +
                `5초 후 원래 시간으로 복구됩니다...`,
                'success'
            );
            
            // 5초 후 복구
            setTimeout(() => {
                if (authManager.tokenData) {
                    authManager.tokenData.expiresAt = originalExpiry;
                    log('✅ 토큰 만료 시간 복구됨');
                }
            }, 5000);
            
            addTestResult('Test 3.2: 토큰 만료 시뮬레이션', 'pass', '만료 감지 성공');
            updateTestStats(1);
        }
        
        async function runTest3Step3() {
            log('Test 3.3: 토큰 자동 갱신');
            
            try {
                showResult('test3', '⏳ 3단계: 토큰 갱신 중...', 'info');
                
                const tokenData = await authManager.refreshToken();
                
                if (!tokenData) {
                    throw new Error('토큰 갱신 실패');
                }
                
                log('✅ Test 3.3: 토큰 갱신 완료');
                showResult('test3',
                    `✅ 3단계: 토큰 자동 갱신\n\n` +
                    `갱신 시간: ${new Date().toLocaleString()}\n` +
                    `새 만료 시간: ${new Date(tokenData.expiresAt).toLocaleString()}\n` +
                    `유효 기간: ${Math.floor((tokenData.expiresAt - Date.now()) / 60000)}분`,
                    'success'
                );
                
                addTestResult('Test 3.3: 토큰 자동 갱신', 'pass', '갱신 성공');
                updateTestStats(1);
                
            } catch (error) {
                showResult('test3', `❌ 3단계: 토큰 갱신 실패\n\n${error.message || error.error}`, 'error');
                addTestResult('Test 3.3: 토큰 자동 갱신', 'fail', error.message || error.error);
                updateTestStats(0, 1);
            }
        }
        
        async function runTest3Step4() {
            log('Test 3.4: 토큰 갱신 재스케줄링');
            
            if (!authManager.tokenData) {
                showResult('test3', '❌ 4단계: 로그인되지 않음\n\n먼저 로그인하세요.', 'error');
                addTestResult('Test 3.4: 재스케줄링', 'fail', '로그인되지 않음');
                updateTestStats(0, 1);
                return;
            }
            
            const expiresAt = authManager.tokenData.expiresAt;
            const refreshTime = expiresAt - (5 * 60 * 1000); // 5분 전
            const timeUntilRefresh = refreshTime - Date.now();
            
            showResult('test3',
                `✅ 4단계: 토큰 갱신 재스케줄링\n\n` +
                `토큰 만료 시간: ${new Date(expiresAt).toLocaleString()}\n` +
                `자동 갱신 예정 시간: ${new Date(refreshTime).toLocaleString()}\n` +
                `갱신까지 남은 시간: ${Math.floor(timeUntilRefresh / 60000)}분\n` +
                `스케줄링 상태: ${authManager.tokenRefreshTimeout ? '✅ 활성' : '❌ 비활성'}`,
                'success'
            );
            
            addTestResult('Test 3.4: 재스케줄링', 'pass', '스케줄링 확인 완료');
            updateTestStats(1);
        }
        
        // ===== TEST 4: 에러 복구 시나리오 =====
        async function runTest4() {
            showResult('test4', '테스트 4 실행 중...', 'info');
            
            try {
                await runTest4Config();
                await sleep(1000);
                await runTest4Network();
                await sleep(1000);
                await runTest4Auth();
                await sleep(1000);
                await runTest4Token();
                
                showResult('test4',
                    '✅ 테스트 4 완료\n\n' +
                    '설정 오류 복구 ✅\n' +
                    '네트워크 오류 복구 ✅\n' +
                    '인증 오류 복구 ✅\n' +
                    '토큰 오류 복구 ✅\n\n' +
                    '모든 에러 복구 시나리오가 정상 작동합니다.',
                    'success'
                );
                
                addTestResult('Test 4: 에러 복구', 'pass', '전체 시나리오 완료');
                updateTestStats(1);
                
            } catch (error) {
                showResult('test4', `❌ 테스트 4 실패\n\n${error.message}`, 'error');
                addTestResult('Test 4: 에러 복구', 'fail', error.message);
                updateTestStats(0, 1);
            }
        }
        
        async function runTest4Config() {
            log('Test 4.1: 설정 오류 복구');
            
            const error = {
                error: 'config_validation_failed',
                message: '설정 검증 실패 (시뮬레이션)'
            };
            
            const result = authManager.handleAuthError(error);
            
            showResult('test4',
                `✅ 설정 오류 복구 테스트\n\n` +
                `에러 카테고리: ${result.category}\n` +
                `에러 코드: ${result.code}\n` +
                `사용자 메시지: ${result.userMessage}\n` +
                `액션: ${result.action}\n` +
                `처리 완료: ${result.handled ? '✅' : '❌'}`,
                'success'
            );
            
            addTestResult('Test 4.1: 설정 오류 복구', 'pass', '에러 처리 완료');
            updateTestStats(1);
        }
        
        async function runTest4Network() {
            log('Test 4.2: 네트워크 오류 복구');
            
            const error = {
                error: 'network_error',
                message: '네트워크 연결 실패 (시뮬레이션)'
            };
            
            const result = authManager.handleAuthError(error);
            
            showResult('test4',
                `✅ 네트워크 오류 복구 테스트\n\n` +
                `에러 카테고리: ${result.category}\n` +
                `에러 코드: ${result.code}\n` +
                `사용자 메시지: ${result.userMessage}\n` +
                `액션: ${result.action}\n` +
                `처리 완료: ${result.handled ? '✅' : '❌'}`,
                'success'
            );
            
            addTestResult('Test 4.2: 네트워크 오류 복구', 'pass', '에러 처리 완료');
            updateTestStats(1);
        }
        
        async function runTest4Auth() {
            log('Test 4.3: 인증 오류 복구');
            
            const error = {
                error: 'popup_closed_by_user',
                message: '사용자가 팝업을 닫음 (시뮬레이션)'
            };
            
            const result = authManager.handleAuthError(error);
            
            showResult('test4',
                `✅ 인증 오류 복구 테스트\n\n` +
                `에러 카테고리: ${result.category}\n` +
                `에러 코드: ${result.code}\n` +
                `사용자 메시지: ${result.userMessage}\n` +
                `액션: ${result.action}\n` +
                `처리 완료: ${result.handled ? '✅' : '❌'}`,
                'success'
            );
            
            addTestResult('Test 4.3: 인증 오류 복구', 'pass', '에러 처리 완료');
            updateTestStats(1);
        }
        
        async function runTest4Token() {
            log('Test 4.4: 토큰 오류 복구');
            
            const error = {
                error: 'token_expired',
                message: '토큰 만료 (시뮬레이션)'
            };
            
            const result = authManager.handleAuthError(error);
            
            showResult('test4',
                `✅ 토큰 오류 복구 테스트\n\n` +
                `에러 카테고리: ${result.category}\n` +
                `에러 코드: ${result.code}\n` +
                `사용자 메시지: ${result.userMessage}\n` +
                `액션: ${result.action}\n` +
                `처리 완료: ${result.handled ? '✅' : '❌'}`,
                'success'
            );
            
            addTestResult('Test 4.4: 토큰 오류 복구', 'pass', '에러 처리 완료');
            updateTestStats(1);
        }
        
        // ===== TEST 5: 폴백 시스템 =====
        async function runTest5() {
            showResult('test5', '테스트 5 실행 중...', 'info');
            
            try {
                await runTest5Offline();
                await sleep(1000);
                await runTest5ConfigFail();
                await sleep(1000);
                await runTest5InitFail();
                
                showResult('test5',
                    '✅ 테스트 5 완료\n\n' +
                    '오프라인 폴백 ✅\n' +
                    '설정 실패 폴백 ✅\n' +
                    '초기화 실패 폴백 ✅\n\n' +
                    '모든 폴백 시나리오가 정상 작동합니다.',
                    'success'
                );
                
                addTestResult('Test 5: 폴백 시스템', 'pass', '전체 시나리오 완료');
                updateTestStats(1);
                
            } catch (error) {
                showResult('test5', `❌ 테스트 5 실패\n\n${error.message}`, 'error');
                addTestResult('Test 5: 폴백 시스템', 'fail', error.message);
                updateTestStats(0, 1);
            }
        }
        
        async function runTest5Offline() {
            log('Test 5.1: 오프라인 폴백');
            
            const isOnline = navigator.onLine;
            
            showResult('test5',
                `✅ 오프라인 폴백 테스트\n\n` +
                `현재 네트워크 상태: ${isOnline ? '온라인' : '오프라인'}\n` +
                `폴백 활성화 조건: 오프라인 상태\n` +
                `예상 동작: 사용자명 로그인만 표시\n\n` +
                `💡 실제 오프라인 테스트:\n` +
                `1. 개발자 도구 (F12) 열기\n` +
                `2. Network 탭 > Offline 체크\n` +
                `3. 페이지 새로고침`,
                'success'
            );
            
            addTestResult('Test 5.1: 오프라인 폴백', 'pass', `네트워크 상태: ${isOnline ? '온라인' : '오프라인'}`);
            updateTestStats(1);
        }
        
        async function runTest5ConfigFail() {
            log('Test 5.2: 설정 실패 폴백');
            
            const fallbackConfig = authConfig.getFallbackConfig();
            
            showResult('test5',
                `✅ 설정 실패 폴백 테스트\n\n` +
                `폴백 로그인 활성화: ${fallbackConfig.enableFallbackLogin ? '✅' : '❌'}\n` +
                `설정 안내 표시: ${fallbackConfig.showSetupInstructions ? '✅' : '❌'}\n` +
                `오프라인 모드 허용: ${fallbackConfig.allowOfflineMode ? '✅' : '❌'}\n` +
                `폴백 메시지: ${fallbackConfig.fallbackMessage}\n\n` +
                `예상 동작: 설정 안내 표시 후 폴백 활성화`,
                'success'
            );
            
            addTestResult('Test 5.2: 설정 실패 폴백', 'pass', '폴백 설정 확인 완료');
            updateTestStats(1);
        }
        
        async function runTest5InitFail() {
            log('Test 5.3: 초기화 실패 폴백');
            
            const error = {
                error: 'initialization_failed',
                message: 'Google OAuth 초기화 실패 (시뮬레이션)'
            };
            
            const result = authManager.handleAuthError(error);
            
            showResult('test5',
                `✅ 초기화 실패 폴백 테스트\n\n` +
                `에러 처리: ${result.handled ? '✅' : '❌'}\n` +
                `폴백 활성화: ${result.action === 'enable_fallback' ? '✅' : '❌'}\n` +
                `사용자 메시지: ${result.userMessage}\n\n` +
                `예상 동작: 폴백 시스템으로 자동 전환`,
                'success'
            );
            
            addTestResult('Test 5.3: 초기화 실패 폴백', 'pass', '폴백 전환 확인 완료');
            updateTestStats(1);
        }
        
        async function runTest5Recovery() {
            log('Test 5.4: 폴백에서 복구');
            
            const isOnline = navigator.onLine;
            
            if (!isOnline) {
                showResult('test5',
                    `⚠️ 복구 테스트\n\n` +
                    `현재 상태: 오프라인\n` +
                    `복구 조건: 온라인 복구 필요\n\n` +
                    `💡 네트워크 연결을 복구하면 자동으로 Google OAuth가 재활성화됩니다.`,
                    'warning'
                );
                addTestResult('Test 5.4: 폴백 복구', 'skip', '오프라인 상태');
                updateTestStats(0, 0, 1);
                return;
            }
            
            showResult('test5',
                `✅ 복구 테스트\n\n` +
                `현재 상태: 온라인\n` +
                `Google OAuth 상태: ${authManager.isInitialized ? '초기화됨' : '미초기화'}\n\n` +
                `예상 동작: 온라인 복구 시 Google OAuth 재활성화`,
                'success'
            );
            
            addTestResult('Test 5.4: 폴백 복구', 'pass', '복구 메커니즘 확인 완료');
            updateTestStats(1);
        }
        
        // ===== TEST 6: 보안 검증 =====
        async function runTest6() {
            showResult('test6', '테스트 6 실행 중...', 'info');
            
            try {
                await runTest6TokenStorage();
                await sleep(1000);
                await runTest6XSS();
                await sleep(1000);
                await runTest6DataValidation();
                
                showResult('test6',
                    '✅ 테스트 6 완료\n\n' +
                    '토큰 저장 보안 ✅\n' +
                    'XSS 방지 ✅\n' +
                    '데이터 검증 ✅\n\n' +
                    '모든 보안 기능이 정상 작동합니다.',
                    'success'
                );
                
                addTestResult('Test 6: 보안 검증', 'pass', '전체 보안 검증 완료');
                updateTestStats(1);
                
            } catch (error) {
                showResult('test6', `❌ 테스트 6 실패\n\n${error.message}`, 'error');
                addTestResult('Test 6: 보안 검증', 'fail', error.message);
                updateTestStats(0, 1);
            }
        }
        
        async function runTest6TokenStorage() {
            log('Test 6.1: 토큰 저장 보안 검증');
            
            // 로컬 스토리지에 토큰이 저장되어 있는지 확인
            const hasTokenInStorage = localStorage.getItem('dualTextWriter_accessToken') !== null ||
                                     localStorage.getItem('dualTextWriter_tokenData') !== null;
            
            // 메모리에만 토큰이 있는지 확인
            const hasTokenInMemory = authManager.tokenData !== null;
            
            const isSecure = !hasTokenInStorage; // 로컬 스토리지에 없어야 안전
            
            showResult('test6',
                `${isSecure ? '✅' : '❌'} 토큰 저장 보안 검증\n\n` +
                `로컬 스토리지에 토큰: ${hasTokenInStorage ? '❌ 있음 (보안 위험!)' : '✅ 없음 (안전)'}\n` +
                `메모리에 토큰: ${hasTokenInMemory ? '✅ 있음' : 'ℹ️ 없음 (로그인 필요)'}\n\n` +
                `보안 요구사항:\n` +
                `- Access Token은 메모리에만 저장 ✅\n` +
                `- 로컬 스토리지에는 비민감 정보만 저장 ✅\n` +
                `- 페이지 새로고침 시 토큰 삭제 ✅`,
                isSecure ? 'success' : 'error'
            );
            
            addTestResult('Test 6.1: 토큰 저장 보안', isSecure ? 'pass' : 'fail', 
                         isSecure ? '토큰이 안전하게 메모리에만 저장됨' : '토큰이 로컬 스토리지에 노출됨');
            updateTestStats(isSecure ? 1 : 0, isSecure ? 0 : 1);
        }
        
        async function runTest6XSS() {
            log('Test 6.2: XSS 방지 검증');
            
            const securityUtils = new SecurityUtils();
            
            // XSS 공격 시도 테스트
            const maliciousInputs = [
                '<script>alert("XSS")</script>',
                '<img src=x onerror="alert(1)">',
                'javascript:alert(1)',
                '<svg onload="alert(1)">'
            ];
            
            let allSafe = true;
            const results = [];
            
            maliciousInputs.forEach(input => {
                const escaped = securityUtils.escapeHtml(input);
                const isSafe = !escaped.includes('<script') && !escaped.includes('onerror') && 
                              !escaped.includes('javascript:') && !escaped.includes('onload');
                
                results.push(`입력: ${input.substring(0, 30)}...\n이스케이프: ${escaped.substring(0, 50)}...\n안전: ${isSafe ? '✅' : '❌'}`);
                
                if (!isSafe) allSafe = false;
            });
            
            showResult('test6',
                `${allSafe ? '✅' : '❌'} XSS 방지 검증\n\n` +
                `테스트된 공격 패턴: ${maliciousInputs.length}개\n` +
                `모두 차단됨: ${allSafe ? '✅' : '❌'}\n\n` +
                `테스트 결과:\n${results.join('\n\n')}`,
                allSafe ? 'success' : 'error'
            );
            
            addTestResult('Test 6.2: XSS 방지', allSafe ? 'pass' : 'fail', 
                         `${maliciousInputs.length}개 패턴 테스트`);
            updateTestStats(allSafe ? 1 : 0, allSafe ? 0 : 1);
        }
        
        async function runTest6DataValidation() {
            log('Test 6.3: 데이터 검증');
            
            const securityUtils = new SecurityUtils();
            
            // 이메일 검증 테스트
            const emailTests = [
                { email: 'valid@example.com', expected: true },
                { email: 'invalid.email', expected: false },
                { email: 'test@', expected: false },
                { email: '@example.com', expected: false },
                { email: 'test@example', expected: false }
            ];
            
            let allPassed = true;
            const results = [];
            
            emailTests.forEach(test => {
                const isValid = securityUtils.isValidEmail(test.email);
                const passed = isValid === test.expected;
                
                results.push(`${test.email}: ${isValid ? '✅ 유효' : '❌ 무효'} (예상: ${test.expected ? '유효' : '무효'}) ${passed ? '✅' : '❌'}`);
                
                if (!passed) allPassed = false;
            });
            
            showResult('test6',
                `${allPassed ? '✅' : '❌'} 데이터 검증\n\n` +
                `이메일 검증 테스트: ${emailTests.length}개\n` +
                `모두 통과: ${allPassed ? '✅' : '❌'}\n\n` +
                `테스트 결과:\n${results.join('\n')}`,
                allPassed ? 'success' : 'error'
            );
            
            addTestResult('Test 6.3: 데이터 검증', allPassed ? 'pass' : 'fail', 
                         `${emailTests.length}개 검증 테스트`);
            updateTestStats(allPassed ? 1 : 0, allPassed ? 0 : 1);
        }
    </script>
</body>
</html>
