<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google OAuth í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        .btn {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-info { background: #17a2b8; color: white; }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: monospace;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.info { background: #d1ecf1; color: #0c5460; }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ”§ Google OAuth 2.0 í…ŒìŠ¤íŠ¸ ë„êµ¬</h1>
        <p>ì´ í˜ì´ì§€ëŠ” Google OAuth ì„¤ì •ì„ í…ŒìŠ¤íŠ¸í•˜ê³  ë””ë²„ê¹…í•˜ê¸° ìœ„í•œ ë„êµ¬ì…ë‹ˆë‹¤.</p>
        
        <!-- ì„¤ì • ìƒíƒœ -->
        <div class="test-section">
            <h3>ğŸ“‹ ì„¤ì • ìƒíƒœ</h3>
            <div id="config-status"></div>
            <button class="btn btn-info" onclick="checkConfig()">ì„¤ì • í™•ì¸</button>
            <button class="btn btn-warning" onclick="showSetupGuide()">ì„¤ì • ê°€ì´ë“œ</button>
        </div>
        
        <!-- OAuth í…ŒìŠ¤íŠ¸ -->
        <div class="test-section">
            <h3>ğŸ” OAuth í…ŒìŠ¤íŠ¸</h3>
            <div id="auth-status"></div>
            <button class="btn btn-primary" onclick="testGoogleLogin()">Google ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸</button>
            <button class="btn btn-danger" onclick="testGoogleLogout()">Google ë¡œê·¸ì•„ì›ƒ í…ŒìŠ¤íŠ¸</button>
            <button class="btn btn-info" onclick="checkAuthStatus()">ì¸ì¦ ìƒíƒœ í™•ì¸</button>
        </div>
        
        <!-- í† í° ê´€ë¦¬ -->
        <div class="test-section">
            <h3>ğŸ« í† í° ê´€ë¦¬</h3>
            <div id="token-status"></div>
            <button class="btn btn-success" onclick="refreshToken()">í† í° ê°±ì‹ </button>
            <button class="btn btn-info" onclick="validateToken()">í† í° ê²€ì¦</button>
        </div>
        
        <!-- ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ -->
        <div class="test-section">
            <h3>ğŸ“¦ ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜</h3>
            <div id="migration-status"></div>
            <button class="btn btn-info" onclick="checkMigrationStatus()">ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒíƒœ</button>
            <button class="btn btn-warning" onclick="createTestData()">í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„±</button>
            <button class="btn btn-danger" onclick="clearTestData()">í…ŒìŠ¤íŠ¸ ë°ì´í„° ì‚­ì œ</button>
        </div>
        
        <!-- ë¡œê·¸ -->
        <div class="test-section">
            <h3>ğŸ“ ì‹¤ì‹œê°„ ë¡œê·¸</h3>
            <div id="log-container" class="log"></div>
            <button class="btn btn-warning" onclick="clearLog()">ë¡œê·¸ ì§€ìš°ê¸°</button>
        </div>
    </div>

    <!-- ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ -->
    <script src="config/auth-config.js"></script>
    <script src="js/google-auth-manager.js"></script>
    <script src="js/data-migration-manager.js"></script>
    
    <script>
        // í…ŒìŠ¤íŠ¸ ë„êµ¬ ë³€ìˆ˜
        let authManager;
        let migrationManager;
        let config;
        
        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', async () => {
            config = window.AUTH_CONFIG;
            authManager = new GoogleAuthManager(config);
            migrationManager = new DataMigrationManager(config);
            
            // ì½œë°± ì„¤ì •
            setupCallbacks();
            
            // ì´ˆê¸° ìƒíƒœ í™•ì¸
            await checkConfig();
            
            log('í…ŒìŠ¤íŠ¸ ë„êµ¬ ì´ˆê¸°í™” ì™„ë£Œ');
        });
        
        // ì½œë°± ì„¤ì •
        function setupCallbacks() {
            authManager.onSignInSuccess = (userData) => {
                log(`âœ… ë¡œê·¸ì¸ ì„±ê³µ: ${userData.name} (${userData.email})`);
                updateAuthStatus('success', `ë¡œê·¸ì¸ë¨: ${userData.name}`);
            };
            
            authManager.onSignInError = (error) => {
                log(`âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨: ${error.error || error.message}`);
                updateAuthStatus('error', `ë¡œê·¸ì¸ ì‹¤íŒ¨: ${error.error || error.message}`);
            };
            
            authManager.onSignOutSuccess = () => {
                log('âœ… ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ');
                updateAuthStatus('info', 'ë¡œê·¸ì•„ì›ƒë¨');
            };
            
            authManager.onTokenRefresh = (tokenData) => {
                log(`ğŸ”„ í† í° ê°±ì‹ : ${new Date(tokenData.refreshTime).toLocaleString()}`);
            };
        }
        
        // ì„¤ì • í™•ì¸
        async function checkConfig() {
            const isValid = config.validateGoogleConfig();
            const envConfig = config.getEnvironmentConfig();
            
            const status = `
                <div class="status ${isValid ? 'success' : 'error'}">
                    <strong>ì„¤ì • ìƒíƒœ:</strong> ${isValid ? 'âœ… ì™„ë£Œ' : 'âŒ ë¯¸ì™„ë£Œ'}<br>
                    <strong>í™˜ê²½:</strong> ${envConfig.isDevelopment ? 'ê°œë°œ' : 'í”„ë¡œë•ì…˜'}<br>
                    <strong>í´ë¼ì´ì–¸íŠ¸ ID:</strong> ${envConfig.clientId}<br>
                    <strong>ìŠ¤ì½”í”„:</strong> ${envConfig.scopes.join(', ')}<br>
                    <strong>í—ˆìš© ë„ë©”ì¸:</strong> ${envConfig.allowedOrigins.join(', ')}
                </div>
            `;
            
            document.getElementById('config-status').innerHTML = status;
            
            if (isValid) {
                try {
                    await authManager.initialize();
                    log('Google OAuth ì´ˆê¸°í™” ì„±ê³µ');
                } catch (error) {
                    log(`Google OAuth ì´ˆê¸°í™” ì‹¤íŒ¨: ${error.message}`);
                }
            }
        }
        
        // ì„¤ì • ê°€ì´ë“œ í‘œì‹œ
        function showSetupGuide() {
            alert(config.getSetupInstructions());
        }
        
        // Google ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸
        async function testGoogleLogin() {
            try {
                log('Google ë¡œê·¸ì¸ ì‹œë„...');
                await authManager.signIn();
            } catch (error) {
                log(`ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`);
            }
        }
        
        // Google ë¡œê·¸ì•„ì›ƒ í…ŒìŠ¤íŠ¸
        async function testGoogleLogout() {
            try {
                log('Google ë¡œê·¸ì•„ì›ƒ ì‹œë„...');
                await authManager.signOut();
            } catch (error) {
                log(`ë¡œê·¸ì•„ì›ƒ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`);
            }
        }
        
        // ì¸ì¦ ìƒíƒœ í™•ì¸
        function checkAuthStatus() {
            const isSignedIn = authManager.isSignedIn();
            const currentUser = authManager.getCurrentUser();
            
            let status = `<div class="status ${isSignedIn ? 'success' : 'info'}">`;
            status += `<strong>ë¡œê·¸ì¸ ìƒíƒœ:</strong> ${isSignedIn ? 'âœ… ë¡œê·¸ì¸ë¨' : 'âŒ ë¡œê·¸ì•„ì›ƒë¨'}<br>`;
            
            if (currentUser) {
                status += `<strong>ì‚¬ìš©ì:</strong> ${currentUser.name} (${currentUser.email})<br>`;
                status += `<strong>í† í° ìœ íš¨:</strong> ${currentUser.isValid ? 'âœ…' : 'âŒ'}<br>`;
                status += `<strong>ë§Œë£Œ ì‹œê°„:</strong> ${new Date(currentUser.expiresAt).toLocaleString()}`;
            }
            
            status += '</div>';
            document.getElementById('auth-status').innerHTML = status;
            
            log(`ì¸ì¦ ìƒíƒœ í™•ì¸: ${isSignedIn ? 'ë¡œê·¸ì¸ë¨' : 'ë¡œê·¸ì•„ì›ƒë¨'}`);
        }
        
        // í† í° ê°±ì‹ 
        async function refreshToken() {
            try {
                log('í† í° ê°±ì‹  ì‹œë„...');
                const tokenData = await authManager.refreshToken();
                if (tokenData) {
                    updateTokenStatus('success', `í† í° ê°±ì‹  ì™„ë£Œ: ${new Date(tokenData.refreshTime).toLocaleString()}`);
                } else {
                    updateTokenStatus('error', 'í† í° ê°±ì‹  ì‹¤íŒ¨: ë¡œê·¸ì¸ë˜ì§€ ì•ŠìŒ');
                }
            } catch (error) {
                log(`í† í° ê°±ì‹  ì‹¤íŒ¨: ${error.message}`);
                updateTokenStatus('error', `í† í° ê°±ì‹  ì‹¤íŒ¨: ${error.message}`);
            }
        }
        
        // í† í° ê²€ì¦
        function validateToken() {
            const isValid = authManager.validateToken();
            updateTokenStatus(isValid ? 'success' : 'error', `í† í° ìœ íš¨ì„±: ${isValid ? 'âœ… ìœ íš¨' : 'âŒ ë¬´íš¨'}`);
            log(`í† í° ê²€ì¦: ${isValid ? 'ìœ íš¨' : 'ë¬´íš¨'}`);
        }
        
        // ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒíƒœ í™•ì¸
        function checkMigrationStatus() {
            const status = migrationManager.getMigrationStatus();
            
            let html = `<div class="status info">`;
            html += `<strong>ë§ˆì´ê·¸ë ˆì´ì…˜ ê¸°ë¡:</strong> ${status.hasMigrationRecord ? 'âœ… ìˆìŒ' : 'âŒ ì—†ìŒ'}<br>`;
            html += `<strong>ë°±ì—… ë°ì´í„°:</strong> ${status.hasBackup ? 'âœ… ìˆìŒ' : 'âŒ ì—†ìŒ'}<br>`;
            
            if (status.migrationRecord) {
                html += `<strong>ì´ì „ ì‚¬ìš©ì:</strong> ${status.migrationRecord.oldUsername}<br>`;
                html += `<strong>ìƒˆ ì´ë©”ì¼:</strong> ${status.migrationRecord.newEmail}<br>`;
                html += `<strong>ì´ì „ ë°ì´í„°:</strong> ${status.migrationRecord.dataCount}ê°œ<br>`;
                html += `<strong>ì´ì „ ì‹œê°„:</strong> ${new Date(status.migrationRecord.migratedAt).toLocaleString()}`;
            }
            
            html += '</div>';
            document.getElementById('migration-status').innerHTML = html;
            
            log('ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒíƒœ í™•ì¸ ì™„ë£Œ');
        }
        
        // í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„±
        function createTestData() {
            const testUsername = 'test_user_' + Date.now();
            const testData = [
                {
                    id: Date.now(),
                    content: 'í…ŒìŠ¤íŠ¸ ë ˆí¼ëŸ°ìŠ¤ ê¸€ì…ë‹ˆë‹¤.',
                    date: new Date().toLocaleString('ko-KR'),
                    characterCount: 15,
                    type: 'reference'
                },
                {
                    id: Date.now() + 1,
                    content: 'í…ŒìŠ¤íŠ¸ ìˆ˜ì • ê¸€ì…ë‹ˆë‹¤.',
                    date: new Date().toLocaleString('ko-KR'),
                    characterCount: 12,
                    type: 'edit'
                }
            ];
            
            localStorage.setItem(`dualTextWriter_savedTexts_${testUsername}`, JSON.stringify(testData));
            localStorage.setItem('dualTextWriter_currentUser', testUsername);
            localStorage.setItem('dualTextWriter_authProvider', 'username');
            
            log(`í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„±: ${testUsername} (${testData.length}ê°œ ê¸€)`);
            updateMigrationStatus('success', `í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„±ë¨: ${testUsername}`);
        }
        
        // í…ŒìŠ¤íŠ¸ ë°ì´í„° ì‚­ì œ
        function clearTestData() {
            const keys = Object.keys(localStorage).filter(key => 
                key.startsWith('dualTextWriter_') || key.startsWith('test_user_')
            );
            
            keys.forEach(key => localStorage.removeItem(key));
            
            log(`í…ŒìŠ¤íŠ¸ ë°ì´í„° ì‚­ì œ: ${keys.length}ê°œ í•­ëª©`);
            updateMigrationStatus('info', 'í…ŒìŠ¤íŠ¸ ë°ì´í„° ì‚­ì œë¨');
        }
        
        // ìƒíƒœ ì—…ë°ì´íŠ¸ í—¬í¼
        function updateAuthStatus(type, message) {
            document.getElementById('auth-status').innerHTML = 
                `<div class="status ${type}">${message}</div>`;
        }
        
        function updateTokenStatus(type, message) {
            document.getElementById('token-status').innerHTML = 
                `<div class="status ${type}">${message}</div>`;
        }
        
        function updateMigrationStatus(type, message) {
            document.getElementById('migration-status').innerHTML = 
                `<div class="status ${type}">${message}</div>`;
        }
        
        // ë¡œê·¸ í•¨ìˆ˜
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logContainer = document.getElementById('log-container');
            logContainer.innerHTML += `[${timestamp}] ${message}\n`;
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        // ë¡œê·¸ ì§€ìš°ê¸°
        function clearLog() {
            document.getElementById('log-container').innerHTML = '';
        }
    </script>
</body>
</html>