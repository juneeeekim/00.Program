<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google OAuth 테스트</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        .btn {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-info { background: #17a2b8; color: white; }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: monospace;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.info { background: #d1ecf1; color: #0c5460; }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>🔧 Google OAuth 2.0 테스트 도구</h1>
        <p>이 페이지는 Google OAuth 설정을 테스트하고 디버깅하기 위한 도구입니다.</p>
        
        <!-- 설정 상태 -->
        <div class="test-section">
            <h3>📋 설정 상태</h3>
            <div id="config-status"></div>
            <button class="btn btn-info" onclick="checkConfig()">설정 확인</button>
            <button class="btn btn-warning" onclick="showSetupGuide()">설정 가이드</button>
        </div>
        
        <!-- OAuth 테스트 -->
        <div class="test-section">
            <h3>🔐 OAuth 테스트</h3>
            <div id="auth-status"></div>
            <button class="btn btn-primary" onclick="testGoogleLogin()">Google 로그인 테스트</button>
            <button class="btn btn-danger" onclick="testGoogleLogout()">Google 로그아웃 테스트</button>
            <button class="btn btn-info" onclick="checkAuthStatus()">인증 상태 확인</button>
        </div>
        
        <!-- 토큰 관리 -->
        <div class="test-section">
            <h3>🎫 토큰 관리</h3>
            <div id="token-status"></div>
            <button class="btn btn-success" onclick="refreshToken()">토큰 갱신</button>
            <button class="btn btn-info" onclick="validateToken()">토큰 검증</button>
        </div>
        
        <!-- 데이터 마이그레이션 -->
        <div class="test-section">
            <h3>📦 데이터 마이그레이션</h3>
            <div id="migration-status"></div>
            <button class="btn btn-info" onclick="checkMigrationStatus()">마이그레이션 상태</button>
            <button class="btn btn-warning" onclick="createTestData()">테스트 데이터 생성</button>
            <button class="btn btn-danger" onclick="clearTestData()">테스트 데이터 삭제</button>
        </div>
        
        <!-- 로그 -->
        <div class="test-section">
            <h3>📝 실시간 로그</h3>
            <div id="log-container" class="log"></div>
            <button class="btn btn-warning" onclick="clearLog()">로그 지우기</button>
        </div>
    </div>

    <!-- 스크립트 로드 -->
    <script src="config/auth-config.js"></script>
    <script src="js/google-auth-manager.js"></script>
    <script src="js/data-migration-manager.js"></script>
    
    <script>
        // 테스트 도구 변수
        let authManager;
        let migrationManager;
        let config;
        
        // 초기화
        document.addEventListener('DOMContentLoaded', async () => {
            config = window.AUTH_CONFIG;
            authManager = new GoogleAuthManager(config);
            migrationManager = new DataMigrationManager(config);
            
            // 콜백 설정
            setupCallbacks();
            
            // 초기 상태 확인
            await checkConfig();
            
            log('테스트 도구 초기화 완료');
        });
        
        // 콜백 설정
        function setupCallbacks() {
            authManager.onSignInSuccess = (userData) => {
                log(`✅ 로그인 성공: ${userData.name} (${userData.email})`);
                updateAuthStatus('success', `로그인됨: ${userData.name}`);
            };
            
            authManager.onSignInError = (error) => {
                log(`❌ 로그인 실패: ${error.error || error.message}`);
                updateAuthStatus('error', `로그인 실패: ${error.error || error.message}`);
            };
            
            authManager.onSignOutSuccess = () => {
                log('✅ 로그아웃 완료');
                updateAuthStatus('info', '로그아웃됨');
            };
            
            authManager.onTokenRefresh = (tokenData) => {
                log(`🔄 토큰 갱신: ${new Date(tokenData.refreshTime).toLocaleString()}`);
            };
        }
        
        // 설정 확인
        async function checkConfig() {
            const isValid = config.validateGoogleConfig();
            const envConfig = config.getEnvironmentConfig();
            
            const status = `
                <div class="status ${isValid ? 'success' : 'error'}">
                    <strong>설정 상태:</strong> ${isValid ? '✅ 완료' : '❌ 미완료'}<br>
                    <strong>환경:</strong> ${envConfig.isDevelopment ? '개발' : '프로덕션'}<br>
                    <strong>클라이언트 ID:</strong> ${envConfig.clientId}<br>
                    <strong>스코프:</strong> ${envConfig.scopes.join(', ')}<br>
                    <strong>허용 도메인:</strong> ${envConfig.allowedOrigins.join(', ')}
                </div>
            `;
            
            document.getElementById('config-status').innerHTML = status;
            
            if (isValid) {
                try {
                    await authManager.initialize();
                    log('Google OAuth 초기화 성공');
                } catch (error) {
                    log(`Google OAuth 초기화 실패: ${error.message}`);
                }
            }
        }
        
        // 설정 가이드 표시
        function showSetupGuide() {
            alert(config.getSetupInstructions());
        }
        
        // Google 로그인 테스트
        async function testGoogleLogin() {
            try {
                log('Google 로그인 시도...');
                await authManager.signIn();
            } catch (error) {
                log(`로그인 테스트 실패: ${error.message}`);
            }
        }
        
        // Google 로그아웃 테스트
        async function testGoogleLogout() {
            try {
                log('Google 로그아웃 시도...');
                await authManager.signOut();
            } catch (error) {
                log(`로그아웃 테스트 실패: ${error.message}`);
            }
        }
        
        // 인증 상태 확인
        function checkAuthStatus() {
            const isSignedIn = authManager.isSignedIn();
            const currentUser = authManager.getCurrentUser();
            
            let status = `<div class="status ${isSignedIn ? 'success' : 'info'}">`;
            status += `<strong>로그인 상태:</strong> ${isSignedIn ? '✅ 로그인됨' : '❌ 로그아웃됨'}<br>`;
            
            if (currentUser) {
                status += `<strong>사용자:</strong> ${currentUser.name} (${currentUser.email})<br>`;
                status += `<strong>토큰 유효:</strong> ${currentUser.isValid ? '✅' : '❌'}<br>`;
                status += `<strong>만료 시간:</strong> ${new Date(currentUser.expiresAt).toLocaleString()}`;
            }
            
            status += '</div>';
            document.getElementById('auth-status').innerHTML = status;
            
            log(`인증 상태 확인: ${isSignedIn ? '로그인됨' : '로그아웃됨'}`);
        }
        
        // 토큰 갱신
        async function refreshToken() {
            try {
                log('토큰 갱신 시도...');
                const tokenData = await authManager.refreshToken();
                if (tokenData) {
                    updateTokenStatus('success', `토큰 갱신 완료: ${new Date(tokenData.refreshTime).toLocaleString()}`);
                } else {
                    updateTokenStatus('error', '토큰 갱신 실패: 로그인되지 않음');
                }
            } catch (error) {
                log(`토큰 갱신 실패: ${error.message}`);
                updateTokenStatus('error', `토큰 갱신 실패: ${error.message}`);
            }
        }
        
        // 토큰 검증
        function validateToken() {
            const isValid = authManager.validateToken();
            updateTokenStatus(isValid ? 'success' : 'error', `토큰 유효성: ${isValid ? '✅ 유효' : '❌ 무효'}`);
            log(`토큰 검증: ${isValid ? '유효' : '무효'}`);
        }
        
        // 마이그레이션 상태 확인
        function checkMigrationStatus() {
            const status = migrationManager.getMigrationStatus();
            
            let html = `<div class="status info">`;
            html += `<strong>마이그레이션 기록:</strong> ${status.hasMigrationRecord ? '✅ 있음' : '❌ 없음'}<br>`;
            html += `<strong>백업 데이터:</strong> ${status.hasBackup ? '✅ 있음' : '❌ 없음'}<br>`;
            
            if (status.migrationRecord) {
                html += `<strong>이전 사용자:</strong> ${status.migrationRecord.oldUsername}<br>`;
                html += `<strong>새 이메일:</strong> ${status.migrationRecord.newEmail}<br>`;
                html += `<strong>이전 데이터:</strong> ${status.migrationRecord.dataCount}개<br>`;
                html += `<strong>이전 시간:</strong> ${new Date(status.migrationRecord.migratedAt).toLocaleString()}`;
            }
            
            html += '</div>';
            document.getElementById('migration-status').innerHTML = html;
            
            log('마이그레이션 상태 확인 완료');
        }
        
        // 테스트 데이터 생성
        function createTestData() {
            const testUsername = 'test_user_' + Date.now();
            const testData = [
                {
                    id: Date.now(),
                    content: '테스트 레퍼런스 글입니다.',
                    date: new Date().toLocaleString('ko-KR'),
                    characterCount: 15,
                    type: 'reference'
                },
                {
                    id: Date.now() + 1,
                    content: '테스트 수정 글입니다.',
                    date: new Date().toLocaleString('ko-KR'),
                    characterCount: 12,
                    type: 'edit'
                }
            ];
            
            localStorage.setItem(`dualTextWriter_savedTexts_${testUsername}`, JSON.stringify(testData));
            localStorage.setItem('dualTextWriter_currentUser', testUsername);
            localStorage.setItem('dualTextWriter_authProvider', 'username');
            
            log(`테스트 데이터 생성: ${testUsername} (${testData.length}개 글)`);
            updateMigrationStatus('success', `테스트 데이터 생성됨: ${testUsername}`);
        }
        
        // 테스트 데이터 삭제
        function clearTestData() {
            const keys = Object.keys(localStorage).filter(key => 
                key.startsWith('dualTextWriter_') || key.startsWith('test_user_')
            );
            
            keys.forEach(key => localStorage.removeItem(key));
            
            log(`테스트 데이터 삭제: ${keys.length}개 항목`);
            updateMigrationStatus('info', '테스트 데이터 삭제됨');
        }
        
        // 상태 업데이트 헬퍼
        function updateAuthStatus(type, message) {
            document.getElementById('auth-status').innerHTML = 
                `<div class="status ${type}">${message}</div>`;
        }
        
        function updateTokenStatus(type, message) {
            document.getElementById('token-status').innerHTML = 
                `<div class="status ${type}">${message}</div>`;
        }
        
        function updateMigrationStatus(type, message) {
            document.getElementById('migration-status').innerHTML = 
                `<div class="status ${type}">${message}</div>`;
        }
        
        // 로그 함수
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logContainer = document.getElementById('log-container');
            logContainer.innerHTML += `[${timestamp}] ${message}\n`;
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        // 로그 지우기
        function clearLog() {
            document.getElementById('log-container').innerHTML = '';
        }
    </script>
</body>
</html>