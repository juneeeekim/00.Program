<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DataMigrationManager í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 900px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 { color: #333; }
        h2 { color: #666; margin-top: 0; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª DataMigrationManager í…ŒìŠ¤íŠ¸</h1>
    
    <div class="test-section">
        <h2>1. í…ŒìŠ¤íŠ¸ ë°ì´í„° ì„¤ì •</h2>
        <button onclick="setupTestData()">í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„±</button>
        <button onclick="clearTestData()">í…ŒìŠ¤íŠ¸ ë°ì´í„° ì‚­ì œ</button>
        <pre id="setup-result"></pre>
    </div>
    
    <div class="test-section">
        <h2>2. ë§ˆì´ê·¸ë ˆì´ì…˜ ê°ì§€ í…ŒìŠ¤íŠ¸</h2>
        <button onclick="testMigrationDetection()">ë§ˆì´ê·¸ë ˆì´ì…˜ í•„ìš”ì„± í™•ì¸</button>
        <pre id="detection-result"></pre>
    </div>
    
    <div class="test-section">
        <h2>3. ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰ í…ŒìŠ¤íŠ¸</h2>
        <button onclick="testMigrationExecution()">ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰</button>
        <pre id="execution-result"></pre>
    </div>
    
    <div class="test-section">
        <h2>4. ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒíƒœ í™•ì¸</h2>
        <button onclick="testMigrationStatus()">ìƒíƒœ í™•ì¸</button>
        <pre id="status-result"></pre>
    </div>
    
    <div class="test-section">
        <h2>5. ë°±ì—… ë° ë¡¤ë°± í…ŒìŠ¤íŠ¸</h2>
        <button onclick="testBackupRollback()">ë°±ì—…/ë¡¤ë°± í…ŒìŠ¤íŠ¸</button>
        <pre id="backup-result"></pre>
    </div>

    <script src="config/auth-config.js"></script>
    <script src="js/data-migration-manager.js"></script>
    
    <script>
        const config = window.AUTH_CONFIG;
        const migrationManager = new DataMigrationManager(config);
        
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
            element.innerHTML = `<span class="${className}">${message}</span>`;
        }
        
        function setupTestData() {
            try {
                // ê¸°ì¡´ ì‚¬ìš©ìëª… ê¸°ë°˜ ë°ì´í„° ìƒì„±
                const testUsername = 'testuser';
                const testData = [
                    {
                        id: Date.now(),
                        content: 'ì´ê²ƒì€ í…ŒìŠ¤íŠ¸ ë ˆí¼ëŸ°ìŠ¤ ê¸€ì…ë‹ˆë‹¤.',
                        date: new Date().toLocaleString('ko-KR'),
                        characterCount: 20,
                        type: 'reference'
                    },
                    {
                        id: Date.now() + 1,
                        content: 'ì´ê²ƒì€ í…ŒìŠ¤íŠ¸ ì‘ì„± ê¸€ì…ë‹ˆë‹¤.',
                        date: new Date().toLocaleString('ko-KR'),
                        characterCount: 18,
                        type: 'edit'
                    }
                ];
                
                const tempSave = {
                    refText: 'ì„ì‹œ ì €ì¥ëœ ë ˆí¼ëŸ°ìŠ¤',
                    editText: 'ì„ì‹œ ì €ì¥ëœ ì‘ì„±ê¸€',
                    timestamp: Date.now()
                };
                
                localStorage.setItem('dualTextWriter_currentUser', testUsername);
                localStorage.setItem('dualTextWriter_authProvider', 'username');
                localStorage.setItem(`dualTextWriter_savedTexts_${testUsername}`, JSON.stringify(testData));
                localStorage.setItem(`dualTextWriter_tempSave_${testUsername}`, JSON.stringify(tempSave));
                
                log('setup-result', 
                    `âœ… í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„± ì™„ë£Œ!\n` +
                    `ì‚¬ìš©ìëª…: ${testUsername}\n` +
                    `ì €ì¥ëœ ê¸€: ${testData.length}ê°œ\n` +
                    `ì„ì‹œ ì €ì¥: ìˆìŒ`,
                    'success'
                );
            } catch (error) {
                log('setup-result', `âŒ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }
        
        function clearTestData() {
            try {
                const testUsername = 'testuser';
                localStorage.removeItem('dualTextWriter_currentUser');
                localStorage.removeItem('dualTextWriter_authProvider');
                localStorage.removeItem(`dualTextWriter_savedTexts_${testUsername}`);
                localStorage.removeItem(`dualTextWriter_tempSave_${testUsername}`);
                localStorage.removeItem('dualTextWriter_migrationRecord');
                localStorage.removeItem(config.MIGRATION_BACKUP_KEY);
                
                log('setup-result', 'âœ… í…ŒìŠ¤íŠ¸ ë°ì´í„° ì‚­ì œ ì™„ë£Œ!', 'success');
            } catch (error) {
                log('setup-result', `âŒ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }
        
        function testMigrationDetection() {
            try {
                const googleUserData = {
                    email: 'test@gmail.com',
                    name: 'Test User'
                };
                
                const migrationInfo = migrationManager.checkMigrationNeeded(googleUserData);
                
                log('detection-result',
                    `ë§ˆì´ê·¸ë ˆì´ì…˜ í•„ìš”: ${migrationInfo.needed ? 'âœ… ì˜ˆ' : 'âŒ ì•„ë‹ˆì˜¤'}\n\n` +
                    JSON.stringify(migrationInfo, null, 2),
                    migrationInfo.needed ? 'success' : 'info'
                );
            } catch (error) {
                log('detection-result', `âŒ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }
        
        async function testMigrationExecution() {
            try {
                const oldUsername = 'testuser';
                const newEmail = 'test@gmail.com';
                
                const result = await migrationManager.performMigration(oldUsername, newEmail);
                
                log('execution-result',
                    `âœ… ë§ˆì´ê·¸ë ˆì´ì…˜ ì„±ê³µ!\n\n` +
                    `ë§ˆì´ê·¸ë ˆì´ì…˜ ID: ${result.migrationRecord.migrationId}\n` +
                    `ì´ì „ëœ ê¸€: ${result.migrationRecord.dataCount}ê°œ\n` +
                    `ì„ì‹œ ì €ì¥: ${result.migrationRecord.tempSaveExists ? 'ìˆìŒ' : 'ì—†ìŒ'}\n` +
                    `ë°±ì—… ì²´í¬ì„¬: ${result.backup.checksum}\n\n` +
                    `ë¡œê·¸:\n${result.log.map(l => `- ${l.message}`).join('\n')}`,
                    'success'
                );
            } catch (error) {
                log('execution-result', `âŒ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }
        
        function testMigrationStatus() {
            try {
                const status = migrationManager.getMigrationStatus();
                
                log('status-result',
                    `ë§ˆì´ê·¸ë ˆì´ì…˜ ê¸°ë¡: ${status.hasMigrationRecord ? 'âœ… ìˆìŒ' : 'âŒ ì—†ìŒ'}\n` +
                    `ë°±ì—… ë°ì´í„°: ${status.hasBackup ? 'âœ… ìˆìŒ' : 'âŒ ì—†ìŒ'}\n\n` +
                    JSON.stringify(status, null, 2),
                    'info'
                );
            } catch (error) {
                log('status-result', `âŒ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }
        
        async function testBackupRollback() {
            try {
                // ë°±ì—… í…ŒìŠ¤íŠ¸
                const testUsername = 'testuser';
                const userData = migrationManager.getExistingUserData(testUsername);
                
                if (userData.savedTexts.length === 0) {
                    log('backup-result', 'âš ï¸ ë¨¼ì € í…ŒìŠ¤íŠ¸ ë°ì´í„°ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.', 'error');
                    return;
                }
                
                const backup = migrationManager.createBackup(userData);
                log('backup-result',
                    `âœ… ë°±ì—… ìƒì„± ì™„ë£Œ!\n\n` +
                    `íƒ€ì„ìŠ¤íƒ¬í”„: ${new Date(backup.timestamp).toLocaleString('ko-KR')}\n` +
                    `ì‚¬ìš©ìëª…: ${backup.username}\n` +
                    `ì²´í¬ì„¬: ${backup.checksum}\n` +
                    `ë°ì´í„° ê°œìˆ˜: ${backup.data.savedTexts.length}ê°œ`,
                    'success'
                );
                
                // ë¡¤ë°± í…ŒìŠ¤íŠ¸
                setTimeout(async () => {
                    const rollbackResult = await migrationManager.rollbackMigration();
                    const currentResult = document.getElementById('backup-result').innerHTML;
                    log('backup-result',
                        currentResult + `\n\nâœ… ë¡¤ë°± ${rollbackResult ? 'ì„±ê³µ' : 'ì‹¤íŒ¨'}!`,
                        rollbackResult ? 'success' : 'error'
                    );
                }, 1000);
                
            } catch (error) {
                log('backup-result', `âŒ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>
