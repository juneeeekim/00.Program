<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DataMigrationManager 테스트</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 900px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 { color: #333; }
        h2 { color: #666; margin-top: 0; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>🧪 DataMigrationManager 테스트</h1>
    
    <div class="test-section">
        <h2>1. 테스트 데이터 설정</h2>
        <button onclick="setupTestData()">테스트 데이터 생성</button>
        <button onclick="clearTestData()">테스트 데이터 삭제</button>
        <pre id="setup-result"></pre>
    </div>
    
    <div class="test-section">
        <h2>2. 마이그레이션 감지 테스트</h2>
        <button onclick="testMigrationDetection()">마이그레이션 필요성 확인</button>
        <pre id="detection-result"></pre>
    </div>
    
    <div class="test-section">
        <h2>3. 마이그레이션 실행 테스트</h2>
        <button onclick="testMigrationExecution()">마이그레이션 실행</button>
        <pre id="execution-result"></pre>
    </div>
    
    <div class="test-section">
        <h2>4. 마이그레이션 상태 확인</h2>
        <button onclick="testMigrationStatus()">상태 확인</button>
        <pre id="status-result"></pre>
    </div>
    
    <div class="test-section">
        <h2>5. 백업 및 롤백 테스트</h2>
        <button onclick="testBackupRollback()">백업/롤백 테스트</button>
        <pre id="backup-result"></pre>
    </div>

    <script src="config/auth-config.js"></script>
    <script src="js/data-migration-manager.js"></script>
    
    <script>
        const config = window.AUTH_CONFIG;
        const migrationManager = new DataMigrationManager(config);
        
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
            element.innerHTML = `<span class="${className}">${message}</span>`;
        }
        
        function setupTestData() {
            try {
                // 기존 사용자명 기반 데이터 생성
                const testUsername = 'testuser';
                const testData = [
                    {
                        id: Date.now(),
                        content: '이것은 테스트 레퍼런스 글입니다.',
                        date: new Date().toLocaleString('ko-KR'),
                        characterCount: 20,
                        type: 'reference'
                    },
                    {
                        id: Date.now() + 1,
                        content: '이것은 테스트 작성 글입니다.',
                        date: new Date().toLocaleString('ko-KR'),
                        characterCount: 18,
                        type: 'edit'
                    }
                ];
                
                const tempSave = {
                    refText: '임시 저장된 레퍼런스',
                    editText: '임시 저장된 작성글',
                    timestamp: Date.now()
                };
                
                localStorage.setItem('dualTextWriter_currentUser', testUsername);
                localStorage.setItem('dualTextWriter_authProvider', 'username');
                localStorage.setItem(`dualTextWriter_savedTexts_${testUsername}`, JSON.stringify(testData));
                localStorage.setItem(`dualTextWriter_tempSave_${testUsername}`, JSON.stringify(tempSave));
                
                log('setup-result', 
                    `✅ 테스트 데이터 생성 완료!\n` +
                    `사용자명: ${testUsername}\n` +
                    `저장된 글: ${testData.length}개\n` +
                    `임시 저장: 있음`,
                    'success'
                );
            } catch (error) {
                log('setup-result', `❌ 오류: ${error.message}`, 'error');
            }
        }
        
        function clearTestData() {
            try {
                const testUsername = 'testuser';
                localStorage.removeItem('dualTextWriter_currentUser');
                localStorage.removeItem('dualTextWriter_authProvider');
                localStorage.removeItem(`dualTextWriter_savedTexts_${testUsername}`);
                localStorage.removeItem(`dualTextWriter_tempSave_${testUsername}`);
                localStorage.removeItem('dualTextWriter_migrationRecord');
                localStorage.removeItem(config.MIGRATION_BACKUP_KEY);
                
                log('setup-result', '✅ 테스트 데이터 삭제 완료!', 'success');
            } catch (error) {
                log('setup-result', `❌ 오류: ${error.message}`, 'error');
            }
        }
        
        function testMigrationDetection() {
            try {
                const googleUserData = {
                    email: 'test@gmail.com',
                    name: 'Test User'
                };
                
                const migrationInfo = migrationManager.checkMigrationNeeded(googleUserData);
                
                log('detection-result',
                    `마이그레이션 필요: ${migrationInfo.needed ? '✅ 예' : '❌ 아니오'}\n\n` +
                    JSON.stringify(migrationInfo, null, 2),
                    migrationInfo.needed ? 'success' : 'info'
                );
            } catch (error) {
                log('detection-result', `❌ 오류: ${error.message}`, 'error');
            }
        }
        
        async function testMigrationExecution() {
            try {
                const oldUsername = 'testuser';
                const newEmail = 'test@gmail.com';
                
                const result = await migrationManager.performMigration(oldUsername, newEmail);
                
                log('execution-result',
                    `✅ 마이그레이션 성공!\n\n` +
                    `마이그레이션 ID: ${result.migrationRecord.migrationId}\n` +
                    `이전된 글: ${result.migrationRecord.dataCount}개\n` +
                    `임시 저장: ${result.migrationRecord.tempSaveExists ? '있음' : '없음'}\n` +
                    `백업 체크섬: ${result.backup.checksum}\n\n` +
                    `로그:\n${result.log.map(l => `- ${l.message}`).join('\n')}`,
                    'success'
                );
            } catch (error) {
                log('execution-result', `❌ 오류: ${error.message}`, 'error');
            }
        }
        
        function testMigrationStatus() {
            try {
                const status = migrationManager.getMigrationStatus();
                
                log('status-result',
                    `마이그레이션 기록: ${status.hasMigrationRecord ? '✅ 있음' : '❌ 없음'}\n` +
                    `백업 데이터: ${status.hasBackup ? '✅ 있음' : '❌ 없음'}\n\n` +
                    JSON.stringify(status, null, 2),
                    'info'
                );
            } catch (error) {
                log('status-result', `❌ 오류: ${error.message}`, 'error');
            }
        }
        
        async function testBackupRollback() {
            try {
                // 백업 테스트
                const testUsername = 'testuser';
                const userData = migrationManager.getExistingUserData(testUsername);
                
                if (userData.savedTexts.length === 0) {
                    log('backup-result', '⚠️ 먼저 테스트 데이터를 생성해주세요.', 'error');
                    return;
                }
                
                const backup = migrationManager.createBackup(userData);
                log('backup-result',
                    `✅ 백업 생성 완료!\n\n` +
                    `타임스탬프: ${new Date(backup.timestamp).toLocaleString('ko-KR')}\n` +
                    `사용자명: ${backup.username}\n` +
                    `체크섬: ${backup.checksum}\n` +
                    `데이터 개수: ${backup.data.savedTexts.length}개`,
                    'success'
                );
                
                // 롤백 테스트
                setTimeout(async () => {
                    const rollbackResult = await migrationManager.rollbackMigration();
                    const currentResult = document.getElementById('backup-result').innerHTML;
                    log('backup-result',
                        currentResult + `\n\n✅ 롤백 ${rollbackResult ? '성공' : '실패'}!`,
                        rollbackResult ? 'success' : 'error'
                    );
                }, 1000);
                
            } catch (error) {
                log('backup-result', `❌ 오류: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>
